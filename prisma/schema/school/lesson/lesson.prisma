// ============================================
// 到校服務模組 - 課堂
// ============================================

/// 到校課堂（核心業務單位）
model SchoolLesson {
  id String @id @default(cuid())

  courseId String
  course   SchoolCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // 課堂基本資料
  lessonDate DateTime
  startTime  String // HH:mm 格式
  endTime    String // HH:mm 格式
  weekday    Int // 1-7

  // 課堂類型
  lessonType LessonType  @default(REGULAR)
  lessonTerm CourseTerm?

  // 課堂狀態
  lessonStatus LessonStatus @default(SCHEDULED)

  // 參與人數（用於費用計算）
  tutorCount   Int  @default(1)
  studentCount Int?

  // 費用明細（支援多種收費模式混合）
  feeItems SchoolLessonFeeItem[]

  // 課堂總金額（自動計算）
  totalRevenue Decimal? @db.Decimal(10, 2) // 向學校收費總額
  totalExpense Decimal? @db.Decimal(10, 2) // 支付導師總額

  // 發票狀態
  invoiceStatus String? @default("NOT_INVOICED") // NOT_INVOICED | INVOICED | PAID

  // 取消/延期資訊
  cancellationReason String?       @db.Text
  cancelledAt        DateTime?
  cancelledBy        String?
  postponedToDate    DateTime?
  postponedLessonId  String?       @unique
  postponedLesson    SchoolLesson? @relation("LessonPostpone", fields: [postponedLessonId], references: [id], onDelete: SetNull)
  originalLesson     SchoolLesson? @relation("LessonPostpone")

  // 備註
  remarks String? @db.Text

  // 關聯
  tutorLessons SchoolTutorLesson[]
  invoiceItems SchoolInvoiceItem[]

  // 系統欄位
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([courseId])
  @@index([lessonDate])
  @@index([lessonStatus])
  @@index([invoiceStatus])
  @@map("school_lessons")
}
