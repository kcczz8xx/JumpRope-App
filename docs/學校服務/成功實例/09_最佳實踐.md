# è¨­è¨ˆæ±ºç­–èˆ‡æœ€ä½³å¯¦è¸

## æ ¸å¿ƒè¨­è¨ˆæ±ºç­–

### 1. å¤šæ­¥é©Ÿè¡¨å–®è¨­è¨ˆ

**æ±ºç­–ï¼š** å°‡è¤‡é›œè¡¨å–®æ‹†åˆ†ç‚ºä¸‰å€‹æ­¥é©Ÿ

**åŸå› ï¼š**

- é™ä½ä½¿ç”¨è€…èªçŸ¥è² æ“”
- æå‡è¡¨å–®å®Œæˆç‡
- ä¾¿æ–¼è³‡æ–™é©—è­‰
- æ”¹å–„ä½¿ç”¨è€…é«”é©—

**å¯¦ä½œæ–¹å¼ï¼š**

```typescript
const STEPS = [{ label: "å­¸æ ¡è³‡æ–™" }, { label: "èª²ç¨‹è³‡æ–™" }, { label: "ç¸½çµ" }];
```

### 2. ç‹€æ…‹ç®¡ç†ç­–ç•¥

**æ±ºç­–ï¼š** ä½¿ç”¨ React useState + useCallback

**åŸå› ï¼š**

- è¡¨å–®ç‹€æ…‹ç›¸å°ç°¡å–®ï¼Œä¸éœ€è¦ Redux
- useCallback å„ªåŒ–æ•ˆèƒ½
- é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

**å¯¦ä½œæ¨¡å¼ï¼š**

```typescript
const [formData, setFormData] = useState<NewCourseFormData>(
  getDefaultNewCourseFormData()
);

const handleSchoolChange = useCallback((updates: Partial<SchoolBasicData>) => {
  setFormData((prev) => ({
    ...prev,
    school: { ...prev.school, ...updates },
  }));
}, []);
```

### 3. è³‡æ–™åº«äº¤æ˜“è™•ç†

**æ±ºç­–ï¼š** ä½¿ç”¨ Prisma Transaction ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§

**åŸå› ï¼š**

- å­¸æ ¡ã€è¯çµ¡äººã€èª²ç¨‹éœ€è¦åŸå­æ€§æ“ä½œ
- ä»»ä¸€æ­¥é©Ÿå¤±æ•—éƒ½æ‡‰å›æ»¾
- é¿å…è³‡æ–™ä¸ä¸€è‡´

**å¯¦ä½œæ–¹å¼ï¼š**

```typescript
const result = await prisma.$transaction(async (tx) => {
  // 1. è™•ç†å­¸æ ¡
  // 2. è™•ç†è¯çµ¡äºº
  // 3. æ‰¹æ¬¡å»ºç«‹èª²ç¨‹
  return { schoolId, coursesCount };
});
```

### 4. æ”¶è²»æ¨¡å¼è¨­è¨ˆ

**æ±ºç­–ï¼š** æ”¯æ´å¤šç¨®æ”¶è²»æ¨¡å¼çµ„åˆ

**åŸå› ï¼š**

- å¯¦éš›æ¥­å‹™éœ€æ±‚è¤‡é›œ
- ä¸åŒå­¸æ ¡æœ‰ä¸åŒæ”¶è²»æ–¹å¼
- éœ€è¦éˆæ´»æ€§

**å¯¦ä½œæ–¹å¼ï¼š**

```typescript
chargingModel: ChargingModel[] // é™£åˆ—æ”¯æ´å¤šé¸

// å‹•æ…‹é¡¯ç¤ºå°æ‡‰çš„æ”¶è²»æ¬„ä½
if (course.chargingModel.includes(ChargingModel.STUDENT_PER_LESSON)) {
  // é¡¯ç¤º studentPerLessonFee æ¬„ä½
}
```

## æ•ˆèƒ½å„ªåŒ–

### 1. useCallback å„ªåŒ–

```typescript
// âœ… ä½¿ç”¨ useCallback é¿å…å­å…ƒä»¶ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
const handleSchoolChange = useCallback((updates: Partial<SchoolBasicData>) => {
  setFormData((prev) => ({
    ...prev,
    school: { ...prev.school, ...updates },
  }));
}, []); // ç©ºä¾è³´é™£åˆ—

// âŒ é¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ™‚å‰µå»ºæ–°å‡½å¼
const handleSchoolChange = (updates: Partial<SchoolBasicData>) => {
  // ...
};
```

### 2. æ¢ä»¶æ¸²æŸ“å„ªåŒ–

```typescript
// âœ… ä½¿ç”¨ switch è€Œéå¤šå€‹ if-else
switch (currentStep) {
  case 0:
    return <SchoolFormStep />;
  case 1:
    return <CoursesFormStep />;
  case 2:
    return <SummaryFormStep />;
  default:
    return null;
}
```

### 3. è³‡æ–™é è¼‰å…¥

```typescript
// âœ… åœ¨é é¢è¼‰å…¥æ™‚é å…ˆè¼‰å…¥å­¸æ ¡åˆ—è¡¨
useEffect(() => {
  fetchSchools();
}, []);
```

## éŒ¯èª¤è™•ç†ç­–ç•¥

### 1. å‰ç«¯é©—è­‰

```typescript
// âœ… æ¯å€‹æ­¥é©Ÿéƒ½æœ‰ç¨ç«‹çš„é©—è­‰å‡½å¼
const validateStep1 = useCallback((): boolean => {
  const newErrors: Record<string, string> = {};

  if (!school.schoolName.trim()) {
    newErrors.schoolName = "è«‹è¼¸å…¥å­¸æ ¡åç¨±";
  }

  setErrors(newErrors);
  return Object.keys(newErrors).length === 0;
}, [formData]);
```

### 2. å¾Œç«¯éŒ¯èª¤è™•ç†

```typescript
// âœ… ä½¿ç”¨ try-catch æ•ç²éŒ¯èª¤
try {
  const result = await prisma.$transaction(async (tx) => {
    // ...
  });
  return NextResponse.json(result);
} catch (error) {
  console.error("Failed to batch create:", error);
  return NextResponse.json(
    { message: "å»ºç«‹å¤±æ•—", error: error.message },
    { status: 500 }
  );
}
```

### 3. ä½¿ç”¨è€…å‹å–„çš„éŒ¯èª¤è¨Šæ¯

```typescript
// âœ… é¡¯ç¤ºå…·é«”çš„éŒ¯èª¤è¨Šæ¯
if (!response.ok) {
  const error = await response.json();
  throw new Error(error.message || "å»ºç«‹å¤±æ•—");
}

// åœ¨ UI ä¸­é¡¯ç¤º
{
  errors.submit && (
    <div className="rounded-lg bg-error-50 p-4 text-sm text-error-600">
      {errors.submit}
    </div>
  );
}
```

## ä½¿ç”¨è€…é«”é©—å„ªåŒ–

### 1. è¼‰å…¥ç‹€æ…‹

```typescript
// âœ… é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
{
  isLoadingSchools ? (
    <div className="h-11 animate-pulse rounded-lg bg-gray-200" />
  ) : (
    <SearchableSelect options={schoolOptions} />
  );
}
```

### 2. æäº¤ç‹€æ…‹

```typescript
// âœ… é˜²æ­¢é‡è¤‡æäº¤
<Button onClick={handleSubmit} disabled={isSubmitting}>
  {isSubmitting ? "å»ºç«‹ä¸­..." : "ç¢ºèªå»ºç«‹èª²ç¨‹"}
</Button>
```

### 3. å³æ™‚é©—è­‰

```typescript
// âœ… æ¸…é™¤å·²ä¿®æ­£æ¬„ä½çš„éŒ¯èª¤è¨Šæ¯
setErrors((prevErrors) => {
  const newErrors = { ...prevErrors };
  Object.keys(updates).forEach((key) => {
    delete newErrors[key];
  });
  return newErrors;
});
```

### 4. æ¸¬è©¦æ•¸æ“šå¡«å……

```typescript
// âœ… æä¾›æ¸¬è©¦æ•¸æ“šæŒ‰éˆ•ï¼Œæ–¹ä¾¿é–‹ç™¼æ¸¬è©¦
<button onClick={fillMockData}>ğŸ§ª å¡«å……æ¸¬è©¦æ•¸æ“š</button>
```

## ç¨‹å¼ç¢¼çµ„ç¹”

### 1. å…ƒä»¶æ‹†åˆ†åŸå‰‡

```
NewCourseForm (ä¸»å…ƒä»¶)
â”œâ”€â”€ SchoolFormStep (å­¸æ ¡è³‡æ–™)
â”œâ”€â”€ CoursesFormStep (èª²ç¨‹è³‡æ–™)
â””â”€â”€ SummaryFormStep (ç¸½çµ)
```

**åŸå‰‡ï¼š**

- æ¯å€‹æ­¥é©Ÿç¨ç«‹æˆå…ƒä»¶
- å–®ä¸€è·è²¬åŸå‰‡
- ä¾¿æ–¼ç¶­è­·å’Œæ¸¬è©¦

### 2. é¡å‹å®šç¾©é›†ä¸­ç®¡ç†

```
types/course.ts
â”œâ”€â”€ ä»‹é¢å®šç¾©
â”œâ”€â”€ åˆ—èˆ‰é¡å‹
â”œâ”€â”€ æ¨™ç±¤å°æ‡‰
â””â”€â”€ å·¥å…·å‡½å¼
```

**å„ªé»ï¼š**

- é¡å‹é‡ç”¨
- çµ±ä¸€ç®¡ç†
- é¿å…é‡è¤‡å®šç¾©

### 3. API Route çµ„ç¹”

```
app/api/school-service/
â”œâ”€â”€ schools/route.ts
â””â”€â”€ courses/
    â””â”€â”€ batch-with-school/route.ts
```

**åŸå‰‡ï¼š**

- RESTful é¢¨æ ¼
- åŠŸèƒ½åˆ†çµ„
- æ¸…æ™°çš„è·¯å¾‘çµæ§‹

## è³‡æ–™åº«è¨­è¨ˆæœ€ä½³å¯¦è¸

### 1. ä½¿ç”¨äº¤æ˜“

```typescript
// âœ… ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
await prisma.$transaction(async (tx) => {
  const school = await tx.school.create({ ... });
  const contact = await tx.schoolContact.create({ ... });
  const courses = await Promise.all(
    coursesData.map(c => tx.schoolCourse.create({ ... }))
  );
});
```

### 2. è»Ÿåˆªé™¤

```prisma
model School {
  // ...
  deletedAt DateTime? // Soft delete
}
```

**å„ªé»ï¼š**

- ä¿ç•™æ­·å²è³‡æ–™
- å¯æ¢å¾©åˆªé™¤çš„è³‡æ–™
- é¿å…å¤–éµç´„æŸå•é¡Œ

### 3. ç´¢å¼•å„ªåŒ–

```prisma
model School {
  // ...
  @@index([partnershipStatus])
  @@index([schoolName])
}
```

**åŸå‰‡ï¼š**

- ç‚ºå¸¸ç”¨æŸ¥è©¢æ¬„ä½å»ºç«‹ç´¢å¼•
- ç‚ºå¤–éµå»ºç«‹ç´¢å¼•
- å¹³è¡¡æŸ¥è©¢æ•ˆèƒ½èˆ‡å¯«å…¥æ•ˆèƒ½

## å®‰å…¨æ€§è€ƒé‡

### 1. è¼¸å…¥é©—è­‰

```typescript
// âœ… å‰ç«¯é©—è­‰
if (!school.schoolName.trim()) {
  newErrors.schoolName = "è«‹è¼¸å…¥å­¸æ ¡åç¨±";
}

// âœ… å¾Œç«¯é©—è­‰
if (!school || !contact || !courses || !Array.isArray(courses)) {
  return NextResponse.json({ message: "ç„¡æ•ˆçš„è«‹æ±‚æ•¸æ“š" }, { status: 400 });
}
```

### 2. é¡å‹å®‰å…¨

```typescript
// âœ… ä½¿ç”¨ TypeScript ç¢ºä¿é¡å‹å®‰å…¨
courseTerm: course.courseTerm as CourseTerm,
chargingModels: course.chargingModel as ChargingModel[],
```

### 3. ç’°å¢ƒè®Šé‡ä¿è­·

```typescript
// âœ… æª¢æŸ¥ç’°å¢ƒè®Šé‡
if (!connectionString) {
  throw new Error("DATABASE_URL environment variable is not set");
}
```

## å¯ç¶­è­·æ€§

### 1. ç¨‹å¼ç¢¼è¨»è§£

```typescript
// âœ… é—œéµé‚è¼¯æ·»åŠ è¨»è§£
// 1. è™•ç†å­¸æ ¡
let schoolId = school.schoolId;

if (schoolId) {
  // æ›´æ–°ç¾æœ‰å­¸æ ¡
  await tx.school.update({ ... });
} else {
  // å‰µå»ºæ–°å­¸æ ¡
  const newSchool = await tx.school.create({ ... });
  schoolId = newSchool.id;
}
```

### 2. å¸¸æ•¸æå–

```typescript
// âœ… å°‡é­”è¡“æ•¸å­—æå–ç‚ºå¸¸æ•¸
const STEPS = [{ label: "å­¸æ ¡è³‡æ–™" }, { label: "èª²ç¨‹è³‡æ–™" }, { label: "ç¸½çµ" }];

const DEFAULT_REQUIRED_TUTORS = 1;
const DEFAULT_ESTIMATED_LESSONS = 12;
```

### 3. éŒ¯èª¤è¨Šæ¯çµ±ä¸€

```typescript
// âœ… ä½¿ç”¨å¸¸æ•¸ç®¡ç†éŒ¯èª¤è¨Šæ¯
const ERROR_MESSAGES = {
  REQUIRED_FIELD: "æ­¤æ¬„ä½ç‚ºå¿…å¡«",
  INVALID_EMAIL: "è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»éƒµåœ°å€",
  INVALID_DATE_RANGE: "çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ",
};
```

## æ¸¬è©¦å»ºè­°

### 1. å–®å…ƒæ¸¬è©¦

```typescript
// æ¸¬è©¦å·¥å…·å‡½å¼
describe("calculateAcademicYear", () => {
  it("should return correct academic year", () => {
    expect(calculateAcademicYear("2026-01-01", "2028-01-02")).toBe("2026-2028");
  });
});
```

### 2. æ•´åˆæ¸¬è©¦

```typescript
// æ¸¬è©¦ API Route
describe("POST /api/school-service/courses/batch-with-school", () => {
  it("should create school, contact and courses", async () => {
    const response = await fetch("/api/...", {
      method: "POST",
      body: JSON.stringify(testData),
    });
    expect(response.status).toBe(200);
  });
});
```

### 3. E2E æ¸¬è©¦

```typescript
// æ¸¬è©¦å®Œæ•´æµç¨‹
test("user can create a new course", async ({ page }) => {
  await page.goto("/dashboard/school/courses/new");
  await page.fill('[name="schoolName"]', "æ¸¬è©¦å°å­¸");
  // ... å¡«å¯«è¡¨å–®
  await page.click('button:has-text("ç¢ºèªå»ºç«‹èª²ç¨‹")');
  await expect(page).toHaveURL(/\/dashboard\/school\/courses\?schoolId=/);
});
```

## æœªä¾†æ“´å±•å»ºè­°

### 1. è‰ç¨¿å„²å­˜

```typescript
// è‡ªå‹•å„²å­˜è‰ç¨¿
useEffect(() => {
  const timer = setTimeout(() => {
    localStorage.setItem("courseDraft", JSON.stringify(formData));
  }, 1000);
  return () => clearTimeout(timer);
}, [formData]);
```

### 2. æ‰¹æ¬¡æ“ä½œ

```typescript
// æ”¯æ´å¾ Excel åŒ¯å…¥èª²ç¨‹
const handleImportExcel = async (file: File) => {
  const data = await parseExcel(file);
  setFormData((prev) => ({
    ...prev,
    courses: [...prev.courses, ...data],
  }));
};
```

### 3. æ¬Šé™æ§åˆ¶

```typescript
// æ ¹æ“šä½¿ç”¨è€…è§’è‰²é™åˆ¶åŠŸèƒ½
if (!hasPermission("course:create")) {
  return <AccessDenied />;
}
```

## ç¸½çµ

æœ¬åŠŸèƒ½çš„æˆåŠŸå¯¦ä½œä¾è³´æ–¼ï¼š

1. **æ¸…æ™°çš„æ¶æ§‹è¨­è¨ˆ** - å¤šæ­¥é©Ÿè¡¨å–®ã€å…ƒä»¶æ‹†åˆ†
2. **å®Œå–„çš„é¡å‹ç³»çµ±** - TypeScript é¡å‹å®‰å…¨
3. **å¯é çš„è³‡æ–™è™•ç†** - Prisma Transaction
4. **è‰¯å¥½çš„ä½¿ç”¨è€…é«”é©—** - è¼‰å…¥ç‹€æ…‹ã€éŒ¯èª¤è™•ç†
5. **å¯ç¶­è­·çš„ç¨‹å¼ç¢¼** - è¨»è§£ã€å¸¸æ•¸ã€çµ„ç¹”çµæ§‹

é€™äº›æœ€ä½³å¯¦è¸å¯ä»¥æ‡‰ç”¨æ–¼å…¶ä»–é¡ä¼¼çš„è¡¨å–®åŠŸèƒ½é–‹ç™¼ã€‚
