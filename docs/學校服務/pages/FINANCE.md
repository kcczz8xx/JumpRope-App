# ğŸ’° è²¡å‹™å„€è¡¨æ¿ - Finance

> **è·¯å¾‘**: `/dashboard/school/finance`  
> **å„ªå…ˆç´š**: P1  
> **è§’è‰²**: FINANCE, ADMIN

---

## ğŸ“‹ é é¢æ¦‚è¿°

è²¡å‹™äººå“¡å°ˆç”¨å„€è¡¨æ¿ï¼Œæä¾›æ”¶æ¬¾æ¦‚è¦½ã€å¾…è™•ç†ç™¼ç¥¨ã€æ”¶æ¬¾è¨˜éŒ„å’Œå ±è¡¨ä¸‹è¼‰åŠŸèƒ½ã€‚

---

## ğŸ¨ é é¢çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’° è²¡å‹™å„€è¡¨æ¿                                    [æœˆä»½ç¯©é¸] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ ğŸ’° æœ¬æœˆæ”¶æ¬¾ â”‚ â”‚ â° å¾…æ”¶æ¬¾   â”‚ â”‚ âš ï¸ å·²é€¾æœŸ   â”‚ â”‚ ğŸ“Š å¹´åº¦ç´¯è¨ˆ â”‚
â”‚  â”‚ HK$80,000   â”‚ â”‚ HK$45,000   â”‚ â”‚ HK$12,000   â”‚ â”‚ HK$960,000 â”‚
â”‚  â”‚             â”‚ â”‚  4å¼µç™¼ç¥¨    â”‚ â”‚  2å¼µç™¼ç¥¨    â”‚ â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âš ï¸ å¾…è™•ç†ç™¼ç¥¨                                 [å…¨éƒ¨] â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚ â”‚ ç·¨è™Ÿ â”‚ å­¸æ ¡    â”‚ é‡‘é¡    â”‚ åˆ°æœŸæ—¥  â”‚ æ“ä½œ    â”‚     â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚  â”‚ â”‚INV-01â”‚ è–ä¿ç¾…  â”‚ $12,000 â”‚ å·²é€¾æœŸ3å¤©â”‚ [å‚¬æ¬¾] â”‚     â”‚   â”‚
â”‚  â”‚ â”‚INV-02â”‚ åŸ¹æ­£    â”‚ $8,500  â”‚ 5å¤©å¾Œ   â”‚ [è¨˜éŒ„] â”‚     â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“ æœ€è¿‘æ”¶æ¬¾è¨˜éŒ„          â”‚ â”‚ ğŸ“Š å ±è¡¨ä¸‹è¼‰             â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ ä»Šå¤© 15:30               â”‚ â”‚ â”‚ ğŸ“„ æœ¬æœˆæ”¶å…¥å ±è¡¨ CSV â”‚ â”‚   â”‚
â”‚  â”‚ åŸ¹æ­£ä¸­å­¸ FPS $6,000      â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                          â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ æ˜¨å¤© 10:15               â”‚ â”‚ â”‚ ğŸ“„ å¹´åº¦è²¡å‹™ç¸½çµ PDF â”‚ â”‚   â”‚
â”‚  â”‚ è–ä¿ç¾… æ”¯ç¥¨ $12,000      â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                          â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ [ æŸ¥çœ‹å…¨éƒ¨ ]             â”‚ â”‚ â”‚ ğŸ“„ é€¾æœŸç™¼ç¥¨æ¸…å–®     â”‚ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ä½¿ç”¨çµ„ä»¶

### TailAdmin çµ„ä»¶

| çµ„ä»¶             | è·¯å¾‘                                    | ç”¨é€”               |
| ---------------- | --------------------------------------- | ------------------ |
| `InvoiceMetrics` | `components/invoice/InvoiceMetrics.tsx` | è²¡å‹™æŒ‡æ¨™ï¼ˆå¯åƒè€ƒï¼‰ |
| `InvoiceTable`   | `components/invoice/InvoiceTable.tsx`   | ç™¼ç¥¨è¡¨æ ¼ï¼ˆå¯åƒè€ƒï¼‰ |
| `CardWithIcon`   | `components/cards/card-with-icon/`      | æŒ‡æ¨™å¡ç‰‡           |
| `BasicTables`    | `components/tables/BasicTables/`        | ç™¼ç¥¨è¡¨æ ¼           |
| `Badge`          | `components/ui/badge/Badge.tsx`         | ç‹€æ…‹æ¨™ç±¤           |

---

## ğŸ“Š æŒ‡æ¨™å®šç¾©

### æœ¬æœˆå·²æ”¶æ¬¾

```typescript
const monthlyReceived = await prisma.schoolReceipt.aggregate({
  where: {
    paymentConfirmedDate: {
      gte: startOfMonth(new Date()),
      lte: endOfMonth(new Date()),
    },
    paymentStatus: "CONFIRMED",
  },
  _sum: { actualReceivedAmount: true },
});
```

### å¾…æ”¶æ¬¾

```typescript
const pendingInvoices = await prisma.schoolInvoice.findMany({
  where: {
    status: { in: ["SENT"] },
    OR: [{ dueDate: null }, { dueDate: { gte: new Date() } }],
  },
  select: {
    id: true,
    invoiceAmount: true,
    paidAmount: true,
  },
});

const pendingAmount = pendingInvoices.reduce(
  (sum, inv) => sum + (inv.invoiceAmount - inv.paidAmount),
  0
);
```

### å·²é€¾æœŸ

```typescript
const overdueInvoices = await prisma.schoolInvoice.findMany({
  where: {
    status: { in: ["SENT", "OVERDUE"] },
    dueDate: { lt: new Date() },
  },
  select: {
    id: true,
    invoiceAmount: true,
    paidAmount: true,
    dueDate: true,
  },
});

const overdueAmount = overdueInvoices.reduce(
  (sum, inv) => sum + (inv.invoiceAmount - inv.paidAmount),
  0
);
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å¿«é€Ÿè¨˜éŒ„æ”¶æ¬¾

```typescript
// å¾ç™¼ç¥¨è¡¨æ ¼ç›´æ¥è¨˜éŒ„æ”¶æ¬¾
interface QuickPaymentData {
  invoiceId: string;
  paymentDate: Date;
  amount: number;
  method: PaymentMethod;
  transactionNumber?: string;
}

async function recordQuickPayment(data: QuickPaymentData) {
  const invoice = await prisma.schoolInvoice.findUnique({
    where: { id: data.invoiceId },
  });

  if (!invoice) throw new Error("ç™¼ç¥¨ä¸å­˜åœ¨");

  // ç”Ÿæˆæ”¶æ“šç·¨è™Ÿ
  const receiptNumber = await generateReceiptNumber();

  await prisma.$transaction([
    // å»ºç«‹æ”¶æ“š
    prisma.schoolReceipt.create({
      data: {
        schoolId: invoice.schoolId,
        invoiceId: data.invoiceId,
        receiptNumber,
        paymentConfirmedDate: data.paymentDate,
        actualReceivedAmount: data.amount,
        paymentMethod: data.method,
        paymentStatus: "CONFIRMED",
        paymentTransactionNumber: data.transactionNumber,
      },
    }),
    // æ›´æ–°ç™¼ç¥¨
    prisma.schoolInvoice.update({
      where: { id: data.invoiceId },
      data: {
        paidAmount: { increment: data.amount },
        status:
          data.amount >= invoice.invoiceAmount - invoice.paidAmount
            ? "PAID"
            : "PARTIAL",
      },
    }),
  ]);
}
```

### 2. å‚¬æ¬¾åŠŸèƒ½

```typescript
interface ReminderData {
  invoiceId: string;
  method: "email" | "whatsapp";
}

async function sendPaymentReminder(data: ReminderData) {
  const invoice = await prisma.schoolInvoice.findUnique({
    where: { id: data.invoiceId },
    include: {
      school: {
        include: {
          contacts: { where: { isPrimary: true } },
        },
      },
    },
  });

  // ç™¼é€æé†’ï¼ˆæ ¹æ“šæ–¹å¼ï¼‰
  if (data.method === "email") {
    await sendEmail({
      to: invoice.contactEmail || invoice.school.contacts[0]?.email,
      template: "payment-reminder",
      data: {
        invoiceNumber: invoice.invoiceNumber,
        amount: invoice.invoiceAmount - invoice.paidAmount,
        dueDate: invoice.dueDate,
      },
    });
  }

  // è¨˜éŒ„å‚¬æ¬¾æ­·å²ï¼ˆå¯æ“´å±•ï¼‰
}
```

### 3. å ±è¡¨ä¸‹è¼‰

```typescript
// æœ¬æœˆæ”¶å…¥å ±è¡¨ CSV
async function generateMonthlyReportCSV() {
  const receipts = await prisma.schoolReceipt.findMany({
    where: {
      paymentConfirmedDate: {
        gte: startOfMonth(new Date()),
        lte: endOfMonth(new Date()),
      },
      paymentStatus: "CONFIRMED",
    },
    include: {
      school: true,
      invoice: true,
    },
    orderBy: { paymentConfirmedDate: "desc" },
  });

  const csvData = [
    ["æ—¥æœŸ", "å­¸æ ¡", "ç™¼ç¥¨ç·¨è™Ÿ", "æ”¶æ“šç·¨è™Ÿ", "ä»˜æ¬¾æ–¹å¼", "é‡‘é¡"],
    ...receipts.map((r) => [
      format(r.paymentConfirmedDate, "yyyy-MM-dd"),
      r.school.schoolName,
      r.invoice.invoiceNumber,
      r.receiptNumber,
      paymentMethodLabels[r.paymentMethod],
      r.actualReceivedAmount.toString(),
    ]),
  ];

  return convertToCSV(csvData);
}
```

---

## ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹

### é é¢çµæ§‹

```tsx
// app/(private)/dashboard/school/finance/page.tsx
import { getServerSession } from "next-auth";
import { redirect } from "next/navigation";

export default async function FinancePage() {
  const session = await getServerSession();

  if (!session?.user) {
    redirect("/login");
  }

  if (!["ADMIN", "FINANCE"].includes(session.user.role)) {
    redirect("/dashboard/school/overview");
  }

  const [metrics, pendingInvoices, recentReceipts] = await Promise.all([
    getFinanceMetrics(),
    getPendingInvoices(),
    getRecentReceipts(10),
  ]);

  return (
    <div className="space-y-6">
      <PageBreadCrumb title="è²¡å‹™å„€è¡¨æ¿" />

      {/* æŒ‡æ¨™å¡ç‰‡ */}
      <FinanceMetricCards metrics={metrics} />

      {/* å¾…è™•ç†ç™¼ç¥¨ */}
      <PendingInvoicesTable invoices={pendingInvoices} />

      {/* åº•éƒ¨å€åŸŸ */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* æœ€è¿‘æ”¶æ¬¾ */}
        <RecentReceiptsTimeline receipts={recentReceipts} />

        {/* å ±è¡¨ä¸‹è¼‰ */}
        <ReportDownloadPanel />
      </div>
    </div>
  );
}
```

### PendingInvoicesTable çµ„ä»¶

```tsx
"use client";

interface PendingInvoicesTableProps {
  invoices: InvoiceWithSchool[];
}

export function PendingInvoicesTable({ invoices }: PendingInvoicesTableProps) {
  const [paymentModal, setPaymentModal] = useState<string | null>(null);

  const getStatusDisplay = (invoice: InvoiceWithSchool) => {
    if (!invoice.dueDate) return { text: "ç„¡åˆ°æœŸæ—¥", color: "gray" };

    const daysUntilDue = differenceInDays(invoice.dueDate, new Date());

    if (daysUntilDue < 0) {
      return { text: `å·²é€¾æœŸ ${Math.abs(daysUntilDue)} å¤©`, color: "red" };
    } else if (daysUntilDue <= 7) {
      return { text: `${daysUntilDue} å¤©å¾Œåˆ°æœŸ`, color: "orange" };
    } else {
      return { text: `${daysUntilDue} å¤©å¾Œåˆ°æœŸ`, color: "gray" };
    }
  };

  return (
    <div className="rounded-xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-gray-900">
      <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-800">
        <h3 className="text-lg font-semibold">å¾…è™•ç†ç™¼ç¥¨</h3>
        <Link href="/dashboard/school/invoices?status=pending">
          <Button variant="ghost" size="sm">
            æŸ¥çœ‹å…¨éƒ¨
          </Button>
        </Link>
      </div>

      <div className="overflow-x-auto">
        <table className="w-full">
          <thead>
            <tr className="border-b border-gray-200 dark:border-gray-800">
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">
                ç·¨è™Ÿ
              </th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">
                å­¸æ ¡
              </th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-500">
                é‡‘é¡
              </th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">
                åˆ°æœŸæ—¥
              </th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-500">
                æ“ä½œ
              </th>
            </tr>
          </thead>
          <tbody>
            {invoices.map((invoice) => {
              const status = getStatusDisplay(invoice);
              const pendingAmount = invoice.invoiceAmount - invoice.paidAmount;

              return (
                <tr
                  key={invoice.id}
                  className={cn(
                    "border-b border-gray-100 dark:border-gray-800",
                    status.color === "red" && "bg-red-50 dark:bg-red-900/10"
                  )}
                >
                  <td className="px-4 py-3 text-sm font-medium">
                    {invoice.invoiceNumber}
                  </td>
                  <td className="px-4 py-3 text-sm">
                    {invoice.school.schoolName}
                  </td>
                  <td className="px-4 py-3 text-sm text-right font-medium">
                    HK$ {pendingAmount.toLocaleString()}
                  </td>
                  <td className="px-4 py-3 text-sm">
                    <Badge variant="light" color={status.color as any}>
                      {status.text}
                    </Badge>
                  </td>
                  <td className="px-4 py-3 text-right">
                    <div className="flex justify-end gap-2">
                      {status.color === "red" && (
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => handleSendReminder(invoice.id)}
                        >
                          å‚¬æ¬¾
                        </Button>
                      )}
                      <Button
                        size="sm"
                        variant="primary"
                        onClick={() => setPaymentModal(invoice.id)}
                      >
                        è¨˜éŒ„æ”¶æ¬¾
                      </Button>
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* å¿«é€Ÿæ”¶æ¬¾ Modal */}
      {paymentModal && (
        <QuickPaymentModal
          invoiceId={paymentModal}
          onClose={() => setPaymentModal(null)}
        />
      )}
    </div>
  );
}
```

---

## âœ… é©—æ”¶æ¨™æº–

- [ ] è²¡å‹™æŒ‡æ¨™æ­£ç¢ºè¨ˆç®—
- [ ] å¾…è™•ç†ç™¼ç¥¨æŒ‰é€¾æœŸå¤©æ•¸æ’åº
- [ ] é€¾æœŸç™¼ç¥¨ç´…è‰²é«˜äº®é¡¯ç¤º
- [ ] å¯å¿«é€Ÿè¨˜éŒ„æ”¶æ¬¾
- [ ] å‚¬æ¬¾åŠŸèƒ½å¯ç™¼é€æé†’
- [ ] å ±è¡¨å¯æ­£ç¢ºä¸‹è¼‰
- [ ] åªæœ‰ ADMIN å’Œ FINANCE å¯å­˜å–
