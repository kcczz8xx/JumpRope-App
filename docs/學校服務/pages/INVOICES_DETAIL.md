# ğŸ“„ ç™¼ç¥¨è©³æƒ… - Invoices Detail

> **è·¯å¾‘**: `/dashboard/school/invoices/[id]`  
> **å„ªå…ˆç´š**: P1  
> **è§’è‰²**: ADMIN (ç·¨è¼¯), FINANCE (ç·¨è¼¯), SCHOOL_ADMIN (å”¯è®€)

---

## ğŸ“‹ é é¢æ¦‚è¿°

é¡¯ç¤ºç™¼ç¥¨çš„å®Œæ•´è³‡æ–™ï¼ŒåŒ…å«å­¸æ ¡è³‡è¨Šã€ç™¼ç¥¨é …ç›®ã€æ”¶æ¬¾ç‹€æ…‹ã€‚æ”¯æ´ç·¨è¼¯ã€ç™¼é€ã€è¨˜éŒ„æ”¶æ¬¾ã€ä¸‹è¼‰ PDF ç­‰æ“ä½œã€‚

---

## ğŸ¨ é é¢çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’³ ç™¼ç¥¨è©³æƒ…                                   [ç·¨è¼¯] [åˆªé™¤] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç™¼ç¥¨ç·¨è™Ÿï¼šINV-2024-09-001                            â”‚   â”‚
â”‚  â”‚ ç‹€æ…‹ï¼šğŸ”µ å·²ç™¼é€                                      â”‚   â”‚
â”‚  â”‚ ç™¼ç¥¨æ—¥æœŸï¼š2024-09-30                                 â”‚   â”‚
â”‚  â”‚ ä»˜æ¬¾æœŸé™ï¼š30 å¤©                                      â”‚   â”‚
â”‚  â”‚ åˆ°æœŸæ—¥ï¼š2024-10-30                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“ å­¸æ ¡è³‡æ–™                                          â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ å­¸æ ¡åç¨±ï¼šè–ä¿ç¾…å°å­¸                                 â”‚   â”‚
â”‚  â”‚ åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°å …é“33è™Ÿ                               â”‚   â”‚
â”‚  â”‚ é›»è©±ï¼š2523-1234                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“¬ æ”¶ä»¶äººè³‡æ–™                                        â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ æ”¶ä»¶äººï¼šç‹è€å¸«ï¼ˆé«”è‚²ç§‘ä¸»ä»»ï¼‰                         â”‚   â”‚
â”‚  â”‚ é›»éƒµï¼šwang@stpaul.edu.hk                            â”‚   â”‚
â”‚  â”‚ éƒµå¯„åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°å …é“33è™Ÿ                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’° ç™¼ç¥¨é …ç›®                                          â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚ â”‚ èª²ç¨‹ï¼šè·³ç¹©æ†å¸¸ç­ï¼ˆä¸Šå­¸æœŸï¼‰                     â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ æœŸé–“ï¼š2024å¹´9æœˆ                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ èª²å ‚æ•¸ï¼š4 å ‚                                   â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ æ˜ç´°ï¼š                                         â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â€¢ 09/09 14:00 - 20 äºº - HK$ 1,000            â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â€¢ 09/16 14:00 - 20 äºº - HK$ 1,000            â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â€¢ 09/23 14:00 - 18 äºº - HK$ 900              â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â€¢ 09/30 14:00 - 20 äºº - HK$ 1,000            â”‚  â”‚   â”‚
â”‚  â”‚ â”‚                                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ å°è¨ˆï¼šHK$ 3,900                               â”‚  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ ç™¼ç¥¨é‡‘é¡ï¼šHK$ 3,900                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’µ æ”¶æ¬¾è³‡æ–™                                          â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ ç‹€æ…‹ï¼šå¾…æ”¶æ¬¾                                         â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ [ ğŸ“ è¨˜éŒ„æ”¶æ¬¾ ]                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“œ æ“ä½œæ­·å²                                          â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ ğŸ“¤ 2024-10-01 10:00  ç™¼ç¥¨å·²ç™¼é€                      â”‚   â”‚
â”‚  â”‚    ç™¼é€æ–¹å¼ï¼šé›»éƒµ                                    â”‚   â”‚
â”‚  â”‚    æ”¶ä»¶äººï¼šwang@stpaul.edu.hk                       â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ğŸ“ 2024-09-30 16:00  ç™¼ç¥¨å·²å»ºç«‹                      â”‚   â”‚
â”‚  â”‚    å»ºç«‹è€…ï¼šAdmin User                                â”‚   â”‚
â”‚  â”‚    èª²å ‚æ•¸ï¼š4 å ‚                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¯ æ“ä½œ                                              â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ [ ğŸ“„ ä¸‹è¼‰ PDF ] [ ğŸ“§ é‡æ–°ç™¼é€ ] [ ğŸ’¬ ç™¼é€å‚¬æ¬¾ ]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ä½¿ç”¨çµ„ä»¶

### TailAdmin çµ„ä»¶

| çµ„ä»¶      | è·¯å¾‘                            | ç”¨é€”     |
| --------- | ------------------------------- | -------- |
| `Badge`   | `components/ui/badge/Badge.tsx` | ç‹€æ…‹æ¨™ç±¤ |
| `Button`  | `components/ui/button/`         | æ“ä½œæŒ‰éˆ• |
| `Modal`   | `components/ui/modal/`          | æ”¶æ¬¾å½ˆçª— |
| `Tooltip` | `components/ui/tooltip/`        | æç¤ºè¨Šæ¯ |

### éœ€é–‹ç™¼çµ„ä»¶

| çµ„ä»¶                 | èªªæ˜         |
| -------------------- | ------------ |
| `InvoiceStatusBadge` | ç™¼ç¥¨ç‹€æ…‹æ¨™ç±¤ |
| `InvoiceInfoCard`    | ç™¼ç¥¨è³‡è¨Šå¡ç‰‡ |
| `InvoiceItemCard`    | ç™¼ç¥¨é …ç›®å¡ç‰‡ |
| `PaymentRecordCard`  | æ”¶æ¬¾è¨˜éŒ„å¡ç‰‡ |

---

## ğŸ“Š è³‡æ–™çµæ§‹

### ç™¼ç¥¨è©³æƒ…è³‡æ–™

```typescript
interface InvoiceDetail {
  id: string;
  invoiceNumber: string;
  status: InvoiceStatus;

  // æ—¥æœŸ
  invoiceDate: Date;
  paymentTermsDays: number;
  dueDate: Date;

  // é‡‘é¡
  invoiceAmount: number;
  paidAmount: number | null;

  // æ”¶ä»¶äººè³‡æ–™
  recipientNameChinese: string;
  recipientNameEnglish: string | null;
  contactPosition: string | null;
  contactEmail: string | null;
  mailingAddress: string | null;

  // å­¸æ ¡è³‡æ–™
  school: {
    id: string;
    schoolName: string;
    schoolNameEnglish: string | null;
    address: string | null;
    phone: string | null;
    email: string | null;
  };

  // ç™¼ç¥¨é …ç›®ï¼ˆæŒ‰èª²ç¨‹åˆ†çµ„ï¼‰
  courses: Array<{
    id: string;
    course: {
      id: string;
      courseName: string;
      chargingModel: ChargingModel;
    };
    amount: number;

    // èª²å ‚æ˜ç´°
    lessons: Array<{
      id: string;
      lessonDate: Date;
      startTime: string;
      studentCount: number;
      feeLesson: number;
    }>;
  }>;

  // æ”¶æ¬¾è¨˜éŒ„
  receipts: Array<{
    id: string;
    receiptNumber: string;
    paymentConfirmedDate: Date;
    actualReceivedAmount: number;
    paymentMethod: PaymentMethod;
    paymentStatus: PaymentStatus;
    paymentTransactionNumber: string | null;
  }>;

  // ç³»çµ±æ¬„ä½
  createdAt: Date;
  updatedAt: Date;
  createdBy: {
    id: string;
    name: string;
  };
}
```

### API æŸ¥è©¢

```typescript
// API: GET /api/invoices/[id]
async function getInvoiceDetail(id: string, session: Session) {
  // æ¬Šé™æª¢æŸ¥
  const canView = await checkPermission(session, "invoice:read");
  if (!canView) throw new Error("Unauthorized");

  const invoice = await prisma.schoolInvoice.findUnique({
    where: { id },
    include: {
      school: {
        select: {
          id: true,
          schoolName: true,
          schoolNameEnglish: true,
          address: true,
          phone: true,
          email: true,
        },
      },
      courses: {
        include: {
          course: {
            select: {
              id: true,
              courseName: true,
              chargingModel: true,
            },
          },
          // éœ€è¦é¡å¤–æŸ¥è©¢é—œè¯çš„èª²å ‚
        },
      },
      receipts: {
        where: { deletedAt: null },
        orderBy: { paymentConfirmedDate: "desc" },
      },
      createdByUser: {
        select: {
          id: true,
          name: true,
        },
      },
    },
  });

  if (!invoice) throw new Error("Invoice not found");

  // SCHOOL_ADMIN åªèƒ½æŸ¥çœ‹è‡ªå·±å­¸æ ¡
  if (session.user.role === "SCHOOL_ADMIN") {
    if (invoice.school.id !== session.user.schoolId) {
      throw new Error("Forbidden");
    }
  }

  // æŸ¥è©¢æ¯å€‹èª²ç¨‹çš„èª²å ‚æ˜ç´°
  for (const invoiceCourse of invoice.courses) {
    const lessons = await prisma.schoolLesson.findMany({
      where: {
        courseId: invoiceCourse.courseId,
        invoiceStatus: "INVOICED",
        // éœ€è¦é—œè¯åˆ°æ­¤ç™¼ç¥¨ï¼ˆé€éèª²å ‚çš„ invoice é—œä¿‚ï¼‰
      },
      select: {
        id: true,
        lessonDate: true,
        startTime: true,
        studentCount: true,
        feeLesson: true,
      },
      orderBy: { lessonDate: "asc" },
    });

    invoiceCourse.lessons = lessons;
  }

  return invoice;
}
```

---

## ğŸ”„ ç‹€æ…‹è®Šæ›´é‚è¼¯

### ç‹€æ…‹æµè½‰

```
DRAFTï¼ˆè‰ç¨¿ï¼‰
    â†“ [ç™¼é€ç™¼ç¥¨]
SENTï¼ˆå·²ç™¼é€ï¼‰
    â†“
    â”œâ”€ [è¨˜éŒ„æ”¶æ¬¾] â†’ PAIDï¼ˆå·²ä»˜æ¬¾ï¼‰
    â”œâ”€ [éƒ¨åˆ†æ”¶æ¬¾] â†’ PARTIALï¼ˆéƒ¨åˆ†ä»˜æ¬¾ï¼‰
    â””â”€ [éæœŸæœªä»˜] â†’ OVERDUEï¼ˆå·²é€¾æœŸï¼‰
```

### 1. ç™¼é€ç™¼ç¥¨

```typescript
// API: POST /api/invoices/[id]/send
async function sendInvoice(
  id: string,
  data: {
    method: "email" | "download";
    recipients?: string[];
  }
) {
  const invoice = await prisma.schoolInvoice.update({
    where: { id },
    data: {
      status: "SENT",
      sentDate: new Date(),
    },
  });

  // ç™¼é€é›»éƒµ
  if (data.method === "email") {
    await sendInvoiceEmail(invoice, data.recipients);
  }

  // ç”Ÿæˆ PDF
  const pdfUrl = await generateInvoicePDF(invoice);

  return { invoice, pdfUrl };
}
```

### 2. è¨˜éŒ„æ”¶æ¬¾

è·³è½‰åˆ° `/invoices/[id]/payment` é é¢

### 3. è‡ªå‹•é€¾æœŸæª¢æŸ¥

```typescript
async function checkOverdueInvoices() {
  const now = new Date();

  const overdueInvoices = await prisma.schoolInvoice.updateMany({
    where: {
      status: "SENT",
      dueDate: {
        lt: now,
      },
    },
    data: {
      status: "OVERDUE",
    },
  });

  return overdueInvoices.count;
}

// å®šæ™‚ä»»å‹™ï¼šæ¯å¤©åŸ·è¡Œä¸€æ¬¡
```

---

## ğŸ“ ç·¨è¼¯åŠŸèƒ½

### å¯ç·¨è¼¯æ¬„ä½ï¼ˆåƒ…è‰ç¨¿ç‹€æ…‹ï¼‰

```typescript
interface EditableInvoice {
  invoiceDate: Date;
  paymentTermsDays: number;

  // æ”¶ä»¶äººè³‡æ–™
  recipientNameChinese: string;
  recipientNameEnglish?: string;
  contactPosition?: string;
  contactEmail?: string;
  mailingAddress?: string;

  // å‚™è¨»
  notes?: string;

  // èª²ç¨‹é …ç›®ï¼ˆåƒ…èƒ½èª¿æ•´é‡‘é¡ï¼Œä¸èƒ½æ”¹èª²å ‚ï¼‰
  courses: Array<{
    courseId: string;
    amount: number;
  }>;
}
```

### API æ›´æ–°

```typescript
// API: PUT /api/invoices/[id]
async function updateInvoice(id: string, data: EditableInvoice) {
  // åªèƒ½ç·¨è¼¯è‰ç¨¿
  const existing = await prisma.schoolInvoice.findUnique({
    where: { id },
  });

  if (existing.status !== "DRAFT") {
    throw new Error("åªèƒ½ç·¨è¼¯è‰ç¨¿ç‹€æ…‹çš„ç™¼ç¥¨");
  }

  // æ›´æ–°ç™¼ç¥¨
  const invoice = await prisma.schoolInvoice.update({
    where: { id },
    data: {
      invoiceDate: data.invoiceDate,
      paymentTermsDays: data.paymentTermsDays,
      dueDate: addDays(data.invoiceDate, data.paymentTermsDays),
      recipientNameChinese: data.recipientNameChinese,
      recipientNameEnglish: data.recipientNameEnglish,
      contactPosition: data.contactPosition,
      contactEmail: data.contactEmail,
      mailingAddress: data.mailingAddress,
      notes: data.notes,
    },
  });

  // æ›´æ–°èª²ç¨‹é‡‘é¡
  for (const course of data.courses) {
    await prisma.schoolInvoiceCourse.update({
      where: {
        invoiceId_courseId: {
          invoiceId: id,
          courseId: course.courseId,
        },
      },
      data: {
        amount: course.amount,
      },
    });
  }

  // é‡æ–°è¨ˆç®—ç¸½é‡‘é¡
  const totalAmount = data.courses.reduce((sum, c) => sum + c.amount, 0);
  await prisma.schoolInvoice.update({
    where: { id },
    data: { invoiceAmount: totalAmount },
  });

  return invoice;
}
```

---

## ğŸ“§ å‚¬æ¬¾åŠŸèƒ½

### å‚¬æ¬¾é‚è¼¯

```typescript
// API: POST /api/invoices/[id]/remind
async function sendPaymentReminder(id: string) {
  const invoice = await prisma.schoolInvoice.findUnique({
    where: { id },
    include: {
      school: true,
      receipts: true,
    },
  });

  if (!invoice) throw new Error("Invoice not found");
  if (invoice.status === "PAID") {
    throw new Error("ç™¼ç¥¨å·²ä»˜æ¬¾ï¼Œç„¡éœ€å‚¬æ¬¾");
  }

  // è¨˜éŒ„å‚¬æ¬¾æ¬¡æ•¸
  const reminderCount = await prisma.invoiceReminder.count({
    where: { invoiceId: id },
  });

  // å»ºç«‹å‚¬æ¬¾è¨˜éŒ„
  await prisma.invoiceReminder.create({
    data: {
      invoiceId: id,
      reminderDate: new Date(),
      reminderMethod: "email",
      reminderCount: reminderCount + 1,
    },
  });

  // ç™¼é€å‚¬æ¬¾é›»éƒµ
  await sendReminderEmail(invoice);

  return { success: true, reminderCount: reminderCount + 1 };
}
```

### å‚¬æ¬¾é›»éƒµæ¨¡æ¿

```html
ä¸»æ—¨ï¼šã€ä»˜æ¬¾æé†’ã€‘ç™¼ç¥¨ INV-2024-09-001 å°Šæ•¬çš„ç‹è€å¸«ï¼š æ‚¨å¥½ï¼
é€™æ˜¯ä¸€å°å‹å–„çš„ä»˜æ¬¾æé†’ã€‚ ç™¼ç¥¨ç·¨è™Ÿï¼šINV-2024-09-001 ç™¼ç¥¨æ—¥æœŸï¼š2024-09-30
ç™¼ç¥¨é‡‘é¡ï¼šHK$ 3,900 åˆ°æœŸæ—¥ï¼š2024-10-30 ç›®å‰ç‹€æ…‹ï¼šå·²é€¾æœŸ 3 å¤©
è«‹å„˜å¿«å®‰æ’ä»˜æ¬¾ã€‚å¦‚æœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿èˆ‡æˆ‘å€‘è¯çµ¡ã€‚ è¬è¬ï¼ é¦™æ¸¯è·³ç¹©å­¸é™¢
```

---

## ğŸ“¥ PDF ç”Ÿæˆ

### PDF å…§å®¹çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é¦™æ¸¯è·³ç¹©å­¸é™¢                â”‚
â”‚         INVOICE                     â”‚
â”‚                                     â”‚
â”‚  ç™¼ç¥¨ç·¨è™Ÿï¼šINV-2024-09-001          â”‚
â”‚  ç™¼ç¥¨æ—¥æœŸï¼š2024-09-30               â”‚
â”‚  ä»˜æ¬¾æœŸé™ï¼š30 å¤©                    â”‚
â”‚  åˆ°æœŸæ—¥ï¼š2024-10-30                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è‡´ï¼šè–ä¿ç¾…å°å­¸                     â”‚
â”‚     ç‹è€å¸«ï¼ˆé«”è‚²ç§‘ä¸»ä»»ï¼‰            â”‚
â”‚     é¦™æ¸¯ä¸­ç’°å …é“33è™Ÿ                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç™¼ç¥¨é …ç›®ï¼š                         â”‚
â”‚                                     â”‚
â”‚  èª²ç¨‹ï¼šè·³ç¹©æ†å¸¸ç­ï¼ˆä¸Šå­¸æœŸï¼‰         â”‚
â”‚  æœŸé–“ï¼š2024å¹´9æœˆ                    â”‚
â”‚                                     â”‚
â”‚  èª²å ‚æ˜ç´°ï¼š                         â”‚
â”‚  09/09 14:00  20äºº  HK$ 1,000      â”‚
â”‚  09/16 14:00  20äºº  HK$ 1,000      â”‚
â”‚  09/23 14:00  18äºº  HK$   900      â”‚
â”‚  09/30 14:00  20äºº  HK$ 1,000      â”‚
â”‚                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  å°è¨ˆï¼š            HK$ 3,900       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç™¼ç¥¨é‡‘é¡ï¼š        HK$ 3,900       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»˜æ¬¾æ–¹å¼ï¼š                         â”‚
â”‚  è½‰æ•¸å¿« (FPS)ï¼š9123-4567           â”‚
â”‚  éŠ€è¡Œè½‰å¸³ï¼šHSBC 123-456789-001     â”‚
â”‚  æ”¯ç¥¨æŠ¬é ­ï¼šé¦™æ¸¯è·³ç¹©å­¸é™¢æœ‰é™å…¬å¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯¦ä½œåƒè€ƒ

```typescript
import { jsPDF } from "jspdf";

async function generateInvoicePDF(invoice: InvoiceDetail) {
  const doc = new jsPDF();

  // æ¨™é¡Œ
  doc.setFontSize(20);
  doc.text("é¦™æ¸¯è·³ç¹©å­¸é™¢", 105, 20, { align: "center" });
  doc.setFontSize(16);
  doc.text("INVOICE", 105, 30, { align: "center" });

  // ç™¼ç¥¨è³‡è¨Š
  doc.setFontSize(12);
  doc.text(`ç™¼ç¥¨ç·¨è™Ÿï¼š${invoice.invoiceNumber}`, 20, 45);
  doc.text(`ç™¼ç¥¨æ—¥æœŸï¼š${formatDate(invoice.invoiceDate)}`, 20, 52);
  doc.text(`åˆ°æœŸæ—¥ï¼š${formatDate(invoice.dueDate)}`, 20, 59);

  // å­¸æ ¡è³‡è¨Š
  doc.text(`è‡´ï¼š${invoice.school.schoolName}`, 20, 72);
  doc.text(`   ${invoice.recipientNameChinese}`, 20, 79);
  if (invoice.mailingAddress) {
    doc.text(`   ${invoice.mailingAddress}`, 20, 86);
  }

  // ç™¼ç¥¨é …ç›®
  let y = 100;
  invoice.courses.forEach((invoiceCourse) => {
    doc.text(`èª²ç¨‹ï¼š${invoiceCourse.course.courseName}`, 20, y);
    y += 7;

    doc.text("èª²å ‚æ˜ç´°ï¼š", 20, y);
    y += 7;

    invoiceCourse.lessons.forEach((lesson) => {
      const text = `${formatDate(lesson.lessonDate)} ${lesson.startTime}  ${
        lesson.studentCount
      }äºº  HK$ ${lesson.feeLesson.toLocaleString()}`;
      doc.text(text, 25, y);
      y += 7;
    });

    doc.text(`å°è¨ˆï¼šHK$ ${invoiceCourse.amount.toLocaleString()}`, 20, y);
    y += 10;
  });

  // ç¸½è¨ˆ
  doc.setFontSize(14);
  doc.text(
    `ç™¼ç¥¨é‡‘é¡ï¼šHK$ ${invoice.invoiceAmount.toLocaleString()}`,
    20,
    y + 10
  );

  // å„²å­˜
  const filename = `Invoice_${invoice.invoiceNumber}.pdf`;
  doc.save(filename);

  return filename;
}
```

---

## ğŸ” æ¬Šé™æ§åˆ¶

### æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯

```typescript
function getAvailableActions(invoice: InvoiceDetail, userRole: UserRole) {
  const actions = {
    edit: false,
    delete: false,
    send: false,
    recordPayment: false,
    download: true, // æ‰€æœ‰äººéƒ½å¯ä¸‹è¼‰
    resend: false,
    remind: false,
  };

  // SCHOOL_ADMIN åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½æ“ä½œ
  if (userRole === "SCHOOL_ADMIN") {
    return actions;
  }

  // ADMIN å’Œ FINANCE å¯æ“ä½œ
  if (userRole === "ADMIN" || userRole === "FINANCE") {
    switch (invoice.status) {
      case "DRAFT":
        actions.edit = true;
        actions.delete = true;
        actions.send = true;
        break;

      case "SENT":
        actions.recordPayment = true;
        actions.resend = true;
        break;

      case "OVERDUE":
        actions.recordPayment = true;
        actions.remind = true;
        break;

      case "PARTIAL":
        actions.recordPayment = true;
        break;

      case "PAID":
        // å·²ä»˜æ¬¾ï¼Œç„¡æ“ä½œ
        break;
    }
  }

  return actions;
}
```

---

## ğŸ¨ UX é‡é»

### 1. ç‹€æ…‹è¦–è¦ºåŒ–

```typescript
const statusConfig = {
  DRAFT: {
    color: "gray",
    icon: "ğŸ“",
    label: "è‰ç¨¿",
  },
  SENT: {
    color: "blue",
    icon: "ğŸ“¤",
    label: "å·²ç™¼é€",
  },
  OVERDUE: {
    color: "red",
    icon: "âš ï¸",
    label: "å·²é€¾æœŸ",
  },
  PARTIAL: {
    color: "orange",
    icon: "ğŸ’°",
    label: "éƒ¨åˆ†ä»˜æ¬¾",
  },
  PAID: {
    color: "green",
    icon: "âœ…",
    label: "å·²ä»˜æ¬¾",
  },
};
```

### 2. é€¾æœŸè­¦å‘Š

```typescript
function getDaysOverdue(dueDate: Date): number {
  const now = new Date();
  const diffTime = now.getTime() - dueDate.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays > 0 ? diffDays : 0;
}

// é¡¯ç¤ºï¼šã€Œå·²é€¾æœŸ 3 å¤©ã€
```

### 3. èª²å ‚æ˜ç´°æ‘ºç–Š

é è¨­é¡¯ç¤ºèª²ç¨‹å°è¨ˆï¼Œé»æ“Šã€ŒæŸ¥çœ‹æ˜ç´°ã€å±•é–‹èª²å ‚åˆ—è¡¨ï¼š

```
èª²ç¨‹ï¼šè·³ç¹©æ†å¸¸ç­ï¼ˆä¸Šå­¸æœŸï¼‰
æœŸé–“ï¼š2024å¹´9æœˆ
èª²å ‚æ•¸ï¼š4 å ‚
å°è¨ˆï¼šHK$ 3,900

[ ğŸ”½ æŸ¥çœ‹èª²å ‚æ˜ç´° ]

// å±•é–‹å¾Œé¡¯ç¤ºï¼š
â€¢ 09/09 14:00 - 20 äºº - HK$ 1,000
â€¢ 09/16 14:00 - 20 äºº - HK$ 1,000
â€¢ 09/23 14:00 - 18 äºº - HK$ 900
â€¢ 09/30 14:00 - 20 äºº - HK$ 1,000
```

### 4. æ”¶æ¬¾ç‹€æ…‹æç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ æ­¤ç™¼ç¥¨å·²é€¾æœŸ 3 å¤©                       â”‚
â”‚ è«‹å„˜å¿«è¨˜éŒ„æ”¶æ¬¾æˆ–ç™¼é€ä»˜æ¬¾æé†’ã€‚             â”‚
â”‚ [ ğŸ“ è¨˜éŒ„æ”¶æ¬¾ ] [ ğŸ’¬ ç™¼é€å‚¬æ¬¾ ]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### 1. æŸ¥çœ‹æ¬Šé™æ¸¬è©¦

```typescript
// ADMIN å’Œ FINANCE å¯æŸ¥çœ‹æ‰€æœ‰ç™¼ç¥¨
// SCHOOL_ADMIN åªèƒ½æŸ¥çœ‹è‡ªå·±å­¸æ ¡
// TUTOR ç„¡æ¬Šé™
```

### 2. ç‹€æ…‹è®Šæ›´æ¸¬è©¦

```typescript
// è‰ç¨¿ â†’ ç™¼é€ â†’ è¨˜éŒ„æ”¶æ¬¾ â†’ å·²ä»˜æ¬¾
// å·²ç™¼é€ â†’ é€¾æœŸï¼ˆè‡ªå‹•ï¼‰â†’ è¨˜éŒ„æ”¶æ¬¾ â†’ å·²ä»˜æ¬¾
// å·²ç™¼é€ â†’ éƒ¨åˆ†æ”¶æ¬¾ â†’ è¨˜éŒ„å‰©é¤˜ â†’ å·²ä»˜æ¬¾
```

### 3. ç·¨è¼¯é™åˆ¶æ¸¬è©¦

```typescript
// åªæœ‰è‰ç¨¿å¯ç·¨è¼¯
// å…¶ä»–ç‹€æ…‹é¡¯ç¤ºã€Œç„¡æ³•ç·¨è¼¯ã€æç¤º
```

---

## ğŸ“Œ é–‹ç™¼æ³¨æ„äº‹é …

1. **è‡ªå‹•é€¾æœŸ**ï¼šé é¢è¼‰å…¥æ™‚æª¢æŸ¥ `dueDate`ï¼Œè‡ªå‹•æ›´æ–°é€¾æœŸç‹€æ…‹
2. **æ¬Šé™æŒ‰éˆ•**ï¼šæ ¹æ“šç”¨æˆ¶è§’è‰²å’Œç™¼ç¥¨ç‹€æ…‹å‹•æ…‹é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
3. **èª²å ‚é—œè¯**ï¼šé¡¯ç¤ºç™¼ç¥¨åŒ…å«çš„èª²å ‚æ˜ç´°ï¼Œæ”¯æ´é»æ“Šè·³è½‰åˆ°èª²å ‚é é¢
4. **æ”¶æ¬¾è¨˜éŒ„**ï¼šé¡¯ç¤ºæ‰€æœ‰æ”¶æ¬¾è¨˜éŒ„ï¼ˆå«éƒ¨åˆ†æ”¶æ¬¾ï¼‰
5. **PDF ä¸‹è¼‰**ï¼šæ”¯æ´é›¢ç·šä¸‹è¼‰å’Œé›»éƒµç™¼é€
6. **å‚¬æ¬¾è¨˜éŒ„**ï¼šé¡¯ç¤ºå‚¬æ¬¾æ¬¡æ•¸å’Œæœ€å¾Œå‚¬æ¬¾æ—¥æœŸ
7. **é‡‘é¡é©—è­‰**ï¼š`invoiceAmount` æ‡‰ç­‰æ–¼æ‰€æœ‰ `courses.amount` çš„ç¸½å’Œ
8. **åˆªé™¤ä¿è­·**ï¼šå·²ç™¼é€çš„ç™¼ç¥¨ä¸å¯åˆªé™¤ï¼Œåªèƒ½ Soft Delete

---

## ğŸ”— ç›¸é—œé é¢

- **ä¸Šä¸€æ­¥**ï¼š[ç™¼ç¥¨åˆ—è¡¨](./INVOICES.md)
- **ä¸‹ä¸€æ­¥**ï¼š[è¨˜éŒ„æ”¶æ¬¾](./INVOICES_PAYMENT.md)
- **ç›¸é—œ**ï¼š[ç”Ÿæˆç™¼ç¥¨](./INVOICES_GENERATE.md)
