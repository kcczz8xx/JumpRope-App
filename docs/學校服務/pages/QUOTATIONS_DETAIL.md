# ğŸ“„ å ±åƒ¹è©³æƒ… - Quotations Detail

> **è·¯å¾‘**: `/dashboard/school/quotations/[id]`  
> **å„ªå…ˆç´š**: P1  
> **è§’è‰²**: ADMIN (ç·¨è¼¯), SCHOOL_ADMIN (å”¯è®€)

---

## ğŸ“‹ é é¢æ¦‚è¿°

é¡¯ç¤ºå ±åƒ¹å–®çš„å®Œæ•´è³‡æ–™ï¼ŒåŒ…å«å­¸æ ¡è³‡è¨Šã€å ±åƒ¹é …ç›®æ˜ç´°ã€ç‹€æ…‹è®Šæ›´æ­·å²ã€‚æ”¯æ´ç·¨è¼¯ã€ç™¼é€ã€æ¥å—/æ‹’çµ•æ“ä½œã€‚

---

## ğŸ¨ é é¢çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ å ±åƒ¹è©³æƒ…                                   [ç·¨è¼¯] [åˆªé™¤] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å ±åƒ¹ç·¨è™Ÿï¼šQ2024-003                                  â”‚   â”‚
â”‚  â”‚ ç‹€æ…‹ï¼šğŸŸ¢ å·²æ¥å—                                      â”‚   â”‚
â”‚  â”‚ å»ºç«‹æ—¥æœŸï¼š2024-11-10                                 â”‚   â”‚
â”‚  â”‚ ç™¼é€æ—¥æœŸï¼š2024-11-12                                 â”‚   â”‚
â”‚  â”‚ æœ‰æ•ˆæœŸè‡³ï¼š2024-12-12                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“ å­¸æ ¡è³‡æ–™                                          â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ å­¸æ ¡åç¨±ï¼šè–ä¿ç¾…å°å­¸                                 â”‚   â”‚
â”‚  â”‚ åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°å …é“33è™Ÿ                               â”‚   â”‚
â”‚  â”‚ é›»è©±ï¼š2523-1234                                      â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ è¯çµ¡äººï¼šç‹è€å¸«ï¼ˆé«”è‚²ç§‘ä¸»ä»»ï¼‰                         â”‚   â”‚
â”‚  â”‚ æ‰‹æï¼š9123 4567                                      â”‚   â”‚
â”‚  â”‚ é›»éƒµï¼šwang@stpaul.edu.hk                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“‹ æŸ¥è©¢è³‡æ–™                                          â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ æŸ¥è©¢æ—¥æœŸï¼š2024-11-10                                 â”‚   â”‚
â”‚  â”‚ å¸Œæœ›é–‹å§‹ï¼š2024-12-01                                 â”‚   â”‚
â”‚  â”‚ é è¨ˆå­¸ç”Ÿï¼š20 äºº                                      â”‚   â”‚
â”‚  â”‚ å¸Œæœ›æ™‚é–“ï¼šæ¯é€±ä¸€ 14:00-15:30                        â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ æŸ¥è©¢å…§å®¹ï¼š                                           â”‚   â”‚
â”‚  â”‚ å¸Œæœ›ç‚ºå°ä¸‰è‡³å°äº”å­¸ç”Ÿé–‹è¨­è·³ç¹©è¨“ç·´ç­ï¼Œ                 â”‚   â”‚
â”‚  â”‚ æ¯é€±ä¸€æ¬¡ï¼Œç‚ºæœŸä¸€å€‹å­¸æœŸ...                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’° å ±åƒ¹é …ç›®                                          â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚ â”‚ é …ç›® 1                                         â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ èª²ç¨‹åç¨±ï¼šè·³ç¹©æ†å¸¸ç­ï¼ˆä¸Šå­¸æœŸï¼‰                 â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ èª²ç¨‹é¡å‹ï¼šæ†å¸¸ç­                               â”‚  â”‚   â”‚
â”‚  â”‚ â”‚                                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ æ”¶è²»æ¨¡å¼ï¼šå­¸ç”Ÿæ¯ç¯€èª²å ‚æ”¶è²»                     â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ å–®åƒ¹ï¼šHK$ 50 / äºº / å ‚                        â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ æ•¸é‡ï¼š12 å ‚                                    â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ é è¨ˆå­¸ç”Ÿï¼š20 äºº                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚                                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ èª²ç¨‹å®‰æ’ï¼š                                     â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â€¢ æ¯é€± 1 å ‚ï¼Œæ¯å ‚ 90 åˆ†é˜                     â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â€¢ æ‰€éœ€å°å¸«ï¼š2 äºº                              â”‚  â”‚   â”‚
â”‚  â”‚ â”‚                                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ å°è¨ˆï¼šHK$ 12,000                              â”‚  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚ â”‚ é …ç›® 2                                         â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ èª²ç¨‹åç¨±ï¼šé€Ÿåº¦è·³è¨“ç·´                           â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ èª²ç¨‹é¡å‹ï¼šçŸ­æœŸç­                               â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ ...                                            â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ å°è¨ˆï¼šHK$ 6,000                               â”‚  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ ç¸½é‡‘é¡ï¼šHK$ 18,000                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“ å‚™è¨»                                              â”‚   â”‚
â”‚  â”‚ åŒ…æ‹¬è·³ç¹©è¨“ç·´ã€èŠ±å¼æ•™å­¸ã€æ¯”è³½æº–å‚™...                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“œ ç‹€æ…‹è®Šæ›´æ­·å²                                      â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚ ğŸŸ¢ 2024-11-15 14:30  å·²æ¥å—                          â”‚   â”‚
â”‚  â”‚    å›æ‡‰æ¸ é“ï¼šé›»è©±ç¢ºèª                                 â”‚   â”‚
â”‚  â”‚    å‚™è¨»ï¼šç‹è€å¸«ç¢ºèªæ¥å—å ±åƒ¹                          â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ğŸ”µ 2024-11-12 10:00  å·²ç™¼é€                          â”‚   â”‚
â”‚  â”‚    ç™¼é€æ–¹å¼ï¼šé›»éƒµ                                    â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ âšª 2024-11-10 16:00  è‰ç¨¿å»ºç«‹                        â”‚   â”‚
â”‚  â”‚    å»ºç«‹è€…ï¼šAdmin User                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¯ æ“ä½œ                                              â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ç‹€æ…‹ï¼šå·²æ¥å—                                         â”‚   â”‚
â”‚  â”‚ [ ğŸ”„ è½‰æ›ç‚ºèª²ç¨‹ ]                                   â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ å…¶ä»–æ“ä½œï¼š                                           â”‚   â”‚
â”‚  â”‚ [ ğŸ“„ ä¸‹è¼‰ PDF ] [ ğŸ“§ é‡æ–°ç™¼é€ ] [ ğŸ“‹ è¤‡è£½å ±åƒ¹ ]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ä½¿ç”¨çµ„ä»¶

### TailAdmin çµ„ä»¶

| çµ„ä»¶      | è·¯å¾‘                            | ç”¨é€”     |
| --------- | ------------------------------- | -------- |
| `Badge`   | `components/ui/badge/Badge.tsx` | ç‹€æ…‹æ¨™ç±¤ |
| `Button`  | `components/ui/button/`         | æ“ä½œæŒ‰éˆ• |
| `Modal`   | `components/ui/modal/`          | ç¢ºèªå½ˆçª— |
| `Tooltip` | `components/ui/tooltip/`        | æç¤ºè¨Šæ¯ |

### éœ€é–‹ç™¼çµ„ä»¶

| çµ„ä»¶                   | èªªæ˜           |
| ---------------------- | -------------- |
| `QuotationStatusBadge` | å ±åƒ¹ç‹€æ…‹æ¨™ç±¤   |
| `QuotationInfoCard`    | å ±åƒ¹è³‡è¨Šå¡ç‰‡   |
| `QuotationItemCard`    | å ±åƒ¹é …ç›®å¡ç‰‡   |
| `StatusTimeline`       | ç‹€æ…‹è®Šæ›´æ™‚é–“ç·š |

---

## ğŸ“Š è³‡æ–™çµæ§‹

### å ±åƒ¹è©³æƒ…è³‡æ–™

```typescript
interface QuotationDetail {
  id: string;
  quotationNumber: string;
  status: QuotationStatus;

  // æ—¥æœŸ
  inquiryDate: Date | null;
  quotationDate: Date;
  sentDate: Date | null;
  respondedDate: Date | null;
  validUntil: Date | null;

  // æŸ¥è©¢è³‡æ–™
  desiredStartDate: Date | null;
  estimatedStudentCount: number | null;
  desiredSchedule: string | null;
  inquiryNotes: string | null;

  // å ±åƒ¹è³‡æ–™
  totalAmount: number | null;
  notes: string | null;

  // å›æ‡‰è³‡æ–™
  responseChannel: string | null;
  rejectionReason: string | null;

  // å­¸æ ¡è³‡æ–™
  school: {
    id: string;
    schoolName: string;
    schoolNameEnglish: string | null;
    address: string | null;
    phone: string | null;
    email: string | null;
  };

  // è¯çµ¡äººè³‡æ–™
  contacts: Array<{
    id: string;
    nameChinese: string;
    nameEnglish: string | null;
    position: string | null;
    mobile: string | null;
    email: string | null;
    isPrimary: boolean;
  }>;

  // å ±åƒ¹é …ç›®
  items: Array<{
    id: string;
    courseName: string;
    courseType: CourseType;
    chargingModel: ChargingModel;
    unitPrice: number;
    quantity: number;
    totalPrice: number;

    // èª²ç¨‹å®‰æ’
    weeklyLessons: number | null;
    lessonDuration: number | null;
    estimatedStudents: number | null;
    requiredTutors: number | null;

    notes: string | null;
  }>;

  // ç³»çµ±æ¬„ä½
  createdAt: Date;
  updatedAt: Date;
  createdBy: {
    id: string;
    name: string;
  };
}
```

### API æŸ¥è©¢

```typescript
// API: GET /api/quotations/[id]
async function getQuotationDetail(id: string, session: Session) {
  // æ¬Šé™æª¢æŸ¥
  const canView = await checkPermission(session, "quotation:read");
  if (!canView) throw new Error("Unauthorized");

  const quotation = await prisma.schoolQuotation.findUnique({
    where: { id },
    include: {
      school: {
        select: {
          id: true,
          schoolName: true,
          schoolNameEnglish: true,
          address: true,
          phone: true,
          email: true,
        },
      },
      items: {
        where: { deletedAt: null },
        orderBy: { createdAt: "asc" },
      },
      contacts: {
        where: { deletedAt: null },
        orderBy: [{ isPrimary: "desc" }, { createdAt: "asc" }],
      },
      createdByUser: {
        select: {
          id: true,
          name: true,
        },
      },
    },
  });

  if (!quotation) throw new Error("Quotation not found");

  // SCHOOL_ADMIN åªèƒ½æŸ¥çœ‹è‡ªå·±å­¸æ ¡
  if (session.user.role === "SCHOOL_ADMIN") {
    if (quotation.school.id !== session.user.schoolId) {
      throw new Error("Forbidden");
    }
  }

  return quotation;
}
```

---

## ğŸ”„ ç‹€æ…‹è®Šæ›´é‚è¼¯

### ç‹€æ…‹æµè½‰

```
DRAFTï¼ˆè‰ç¨¿ï¼‰
    â†“ [ç™¼é€å ±åƒ¹]
SENTï¼ˆå·²ç™¼é€ï¼‰
    â†“
    â”œâ”€ [æ¨™è¨˜æ¥å—] â†’ ACCEPTEDï¼ˆå·²æ¥å—ï¼‰â†’ å¯è½‰æ›ç‚ºèª²ç¨‹
    â”œâ”€ [æ¨™è¨˜æ‹’çµ•] â†’ REJECTEDï¼ˆå·²æ‹’çµ•ï¼‰
    â””â”€ [éæœŸ] â†’ EXPIREDï¼ˆå·²éæœŸï¼‰
```

### 1. ç™¼é€å ±åƒ¹

```typescript
// API: POST /api/quotations/[id]/send
async function sendQuotation(
  id: string,
  data: {
    method: "email" | "whatsapp" | "download";
    recipients?: string[]; // é›»éƒµåœ°å€
  }
) {
  const quotation = await prisma.schoolQuotation.update({
    where: { id },
    data: {
      status: "SENT",
      sentDate: new Date(),
    },
  });

  // ç™¼é€é›»éƒµ/WhatsApp
  if (data.method === "email") {
    await sendQuotationEmail(quotation, data.recipients);
  }

  // ç”Ÿæˆ PDF
  const pdfUrl = await generateQuotationPDF(quotation);

  return { quotation, pdfUrl };
}
```

### 2. æ¨™è¨˜æ¥å—

```typescript
// API: POST /api/quotations/[id]/accept
async function acceptQuotation(
  id: string,
  data: {
    respondedDate: Date;
    responseChannel: string; // é›»è©±/é›»éƒµ/æœƒè­°
    notes?: string;
  }
) {
  // æ›´æ–°å ±åƒ¹ç‹€æ…‹
  const quotation = await prisma.schoolQuotation.update({
    where: { id },
    data: {
      status: "ACCEPTED",
      respondedDate: data.respondedDate,
      responseChannel: data.responseChannel,
    },
  });

  // æ›´æ–°å­¸æ ¡åˆä½œç‹€æ…‹
  await prisma.school.update({
    where: { id: quotation.schoolId },
    data: {
      partnershipStatus: "CONFIRMED",
      partnershipStartDate: data.respondedDate,
      confirmationChannel: data.responseChannel,
    },
  });

  return quotation;
}
```

### 3. æ¨™è¨˜æ‹’çµ•

```typescript
// API: POST /api/quotations/[id]/reject
async function rejectQuotation(
  id: string,
  data: {
    respondedDate: Date;
    rejectionReason: string;
  }
) {
  const quotation = await prisma.schoolQuotation.update({
    where: { id },
    data: {
      status: "REJECTED",
      respondedDate: data.respondedDate,
      rejectionReason: data.rejectionReason,
    },
  });

  return quotation;
}
```

---

## ğŸ“ ç·¨è¼¯åŠŸèƒ½

### å¯ç·¨è¼¯æ¬„ä½ï¼ˆåƒ…è‰ç¨¿ç‹€æ…‹ï¼‰

```typescript
interface EditableQuotation {
  // æŸ¥è©¢è³‡æ–™
  inquiryDate?: Date;
  desiredStartDate?: Date;
  estimatedStudentCount?: number;
  desiredSchedule?: string;
  inquiryNotes?: string;

  // å ±åƒ¹è³‡æ–™
  quotationDate: Date;
  validUntil?: Date;
  notes?: string;

  // å ±åƒ¹é …ç›®
  items: Array<{
    id?: string; // æœ‰ id = æ›´æ–°ï¼Œç„¡ id = æ–°å¢
    courseName: string;
    courseType: CourseType;
    chargingModel: ChargingModel;
    unitPrice: number;
    quantity: number;
    weeklyLessons?: number;
    lessonDuration?: number;
    estimatedStudents?: number;
    requiredTutors?: number;
    notes?: string;
  }>;
}
```

### API æ›´æ–°

```typescript
// API: PUT /api/quotations/[id]
async function updateQuotation(id: string, data: EditableQuotation) {
  // åªèƒ½ç·¨è¼¯è‰ç¨¿
  const existing = await prisma.schoolQuotation.findUnique({
    where: { id },
  });

  if (existing.status !== "DRAFT") {
    throw new Error("åªèƒ½ç·¨è¼¯è‰ç¨¿ç‹€æ…‹çš„å ±åƒ¹");
  }

  // æ›´æ–°å ±åƒ¹
  const quotation = await prisma.schoolQuotation.update({
    where: { id },
    data: {
      inquiryDate: data.inquiryDate,
      desiredStartDate: data.desiredStartDate,
      estimatedStudentCount: data.estimatedStudentCount,
      desiredSchedule: data.desiredSchedule,
      inquiryNotes: data.inquiryNotes,
      quotationDate: data.quotationDate,
      validUntil: data.validUntil,
      notes: data.notes,
    },
  });

  // æ›´æ–°é …ç›®ï¼ˆåˆªé™¤èˆŠçš„ï¼Œå»ºç«‹æ–°çš„ï¼‰
  await prisma.schoolQuotationItem.deleteMany({
    where: { quotationId: id },
  });

  await prisma.schoolQuotationItem.createMany({
    data: data.items.map((item) => ({
      quotationId: id,
      ...item,
      totalPrice: item.unitPrice * item.quantity,
    })),
  });

  // é‡æ–°è¨ˆç®—ç¸½é‡‘é¡
  const totalAmount = data.items.reduce(
    (sum, item) => sum + item.unitPrice * item.quantity,
    0
  );

  await prisma.schoolQuotation.update({
    where: { id },
    data: { totalAmount },
  });

  return quotation;
}
```

---

## ğŸ” æ¬Šé™æ§åˆ¶

### æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯

```typescript
function getAvailableActions(quotation: QuotationDetail, userRole: UserRole) {
  const actions = {
    edit: false,
    delete: false,
    send: false,
    accept: false,
    reject: false,
    convert: false,
    download: true, // æ‰€æœ‰äººéƒ½å¯ä¸‹è¼‰
    resend: false,
    duplicate: false,
  };

  // åªæœ‰ ADMIN å¯æ“ä½œ
  if (userRole !== "ADMIN") {
    return actions;
  }

  switch (quotation.status) {
    case "DRAFT":
      actions.edit = true;
      actions.delete = true;
      actions.send = true;
      actions.duplicate = true;
      break;

    case "SENT":
      actions.accept = true;
      actions.reject = true;
      actions.resend = true;
      actions.duplicate = true;
      break;

    case "ACCEPTED":
      actions.convert = true;
      actions.duplicate = true;
      break;

    case "REJECTED":
    case "EXPIRED":
      actions.duplicate = true;
      break;
  }

  return actions;
}
```

---

## ğŸ¨ UX é‡é»

### 1. ç‹€æ…‹è¦–è¦ºåŒ–

```typescript
const statusConfig = {
  DRAFT: {
    color: "gray",
    icon: "ğŸ“",
    label: "è‰ç¨¿",
  },
  SENT: {
    color: "blue",
    icon: "ğŸ“¤",
    label: "å·²ç™¼é€",
  },
  ACCEPTED: {
    color: "green",
    icon: "âœ…",
    label: "å·²æ¥å—",
  },
  REJECTED: {
    color: "red",
    icon: "âŒ",
    label: "å·²æ‹’çµ•",
  },
  EXPIRED: {
    color: "orange",
    icon: "â°",
    label: "å·²éæœŸ",
  },
};
```

### 2. é‡‘é¡æ ¼å¼åŒ–

```typescript
function formatCurrency(amount: number): string {
  return `HK$ ${amount.toLocaleString("en-HK")}`;
}

// ç¯„ä¾‹ï¼š12000 â†’ "HK$ 12,000"
```

### 3. æ—¥æœŸé¡¯ç¤º

```typescript
function formatDate(date: Date | null): string {
  if (!date) return "-";
  return date.toLocaleDateString("zh-HK", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  });
}

// ç¯„ä¾‹ï¼š2024-11-10 â†’ "2024/11/10"
```

### 4. å ±åƒ¹éæœŸæç¤º

```typescript
function checkExpired(quotation: QuotationDetail): boolean {
  if (!quotation.validUntil) return false;
  if (quotation.status !== "SENT") return false;

  const now = new Date();
  const expired = now > quotation.validUntil;

  if (expired) {
    // è‡ªå‹•æ›´æ–°ç‹€æ…‹ç‚º EXPIRED
    updateQuotationStatus(quotation.id, "EXPIRED");
  }

  return expired;
}
```

### 5. è½‰æ›ç‚ºèª²ç¨‹æç¤º

å·²æ¥å—çš„å ±åƒ¹åœ¨é ‚éƒ¨é¡¯ç¤ºé†’ç›®æç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… æ­¤å ±åƒ¹å·²è¢«æ¥å—                          â”‚
â”‚ è«‹é»æ“Šã€Œè½‰æ›ç‚ºèª²ç¨‹ã€å»ºç«‹æ­£å¼èª²ç¨‹è¨˜éŒ„ã€‚     â”‚
â”‚ [ ğŸ”„ è½‰æ›ç‚ºèª²ç¨‹ ]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¥ PDF ç”Ÿæˆ

### PDF å…§å®¹çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é¦™æ¸¯è·³ç¹©å­¸é™¢                â”‚
â”‚         QUOTATION                   â”‚
â”‚                                     â”‚
â”‚  å ±åƒ¹ç·¨è™Ÿï¼šQ2024-003                â”‚
â”‚  æ—¥æœŸï¼š2024-11-10                   â”‚
â”‚  æœ‰æ•ˆæœŸè‡³ï¼š2024-12-12               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è‡´ï¼šè–ä¿ç¾…å°å­¸                     â”‚
â”‚     ç‹è€å¸«ï¼ˆé«”è‚²ç§‘ä¸»ä»»ï¼‰            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å ±åƒ¹é …ç›®ï¼š                         â”‚
â”‚  1. è·³ç¹©æ†å¸¸ç­ï¼ˆä¸Šå­¸æœŸï¼‰            â”‚
â”‚     æ•¸é‡ï¼š12 å ‚                     â”‚
â”‚     å–®åƒ¹ï¼šHK$ 50 x 20 äºº           â”‚
â”‚     å°è¨ˆï¼šHK$ 12,000               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¸½è¨ˆï¼šHK$ 18,000                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‚™è¨»ï¼š...                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯¦ä½œåƒè€ƒ

```typescript
import { jsPDF } from "jspdf";

async function generateQuotationPDF(quotation: QuotationDetail) {
  const doc = new jsPDF();

  // æ¨™é¡Œ
  doc.setFontSize(20);
  doc.text("é¦™æ¸¯è·³ç¹©å­¸é™¢", 105, 20, { align: "center" });
  doc.setFontSize(16);
  doc.text("QUOTATION", 105, 30, { align: "center" });

  // å ±åƒ¹è³‡è¨Š
  doc.setFontSize(12);
  doc.text(`å ±åƒ¹ç·¨è™Ÿï¼š${quotation.quotationNumber}`, 20, 45);
  doc.text(`æ—¥æœŸï¼š${formatDate(quotation.quotationDate)}`, 20, 52);

  // å­¸æ ¡è³‡è¨Š
  doc.text(`è‡´ï¼š${quotation.school.schoolName}`, 20, 65);

  // å ±åƒ¹é …ç›®
  let y = 80;
  quotation.items.forEach((item, index) => {
    doc.text(`${index + 1}. ${item.courseName}`, 20, y);
    doc.text(`   HK$ ${item.totalPrice.toLocaleString()}`, 20, y + 7);
    y += 15;
  });

  // ç¸½è¨ˆ
  doc.text(`ç¸½è¨ˆï¼šHK$ ${quotation.totalAmount.toLocaleString()}`, 20, y + 10);

  // å„²å­˜
  const filename = `Quotation_${quotation.quotationNumber}.pdf`;
  doc.save(filename);

  return filename;
}
```

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### 1. æŸ¥çœ‹æ¬Šé™æ¸¬è©¦

```typescript
// ADMIN å¯æŸ¥çœ‹æ‰€æœ‰å ±åƒ¹
// SCHOOL_ADMIN åªèƒ½æŸ¥çœ‹è‡ªå·±å­¸æ ¡
// å…¶ä»–è§’è‰²ç„¡æ¬Šé™
```

### 2. ç‹€æ…‹è®Šæ›´æ¸¬è©¦

```typescript
// è‰ç¨¿ â†’ ç™¼é€ â†’ æ¥å— â†’ è½‰æ›
// è‰ç¨¿ â†’ ç™¼é€ â†’ æ‹’çµ•
// ç™¼é€ â†’ éæœŸï¼ˆè‡ªå‹•ï¼‰
```

### 3. ç·¨è¼¯é™åˆ¶æ¸¬è©¦

```typescript
// åªæœ‰è‰ç¨¿å¯ç·¨è¼¯
// å…¶ä»–ç‹€æ…‹é¡¯ç¤ºã€Œç„¡æ³•ç·¨è¼¯ã€æç¤º
```

---

## ğŸ“Œ é–‹ç™¼æ³¨æ„äº‹é …

1. **å³æ™‚ç‹€æ…‹æ›´æ–°**ï¼šé é¢è¼‰å…¥æ™‚æª¢æŸ¥ `validUntil`ï¼Œè‡ªå‹•æ›´æ–°éæœŸç‹€æ…‹
2. **æ¬Šé™æŒ‰éˆ•**ï¼šæ ¹æ“šç”¨æˆ¶è§’è‰²å’Œå ±åƒ¹ç‹€æ…‹å‹•æ…‹é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
3. **é‡‘é¡é©—è­‰**ï¼šå ±åƒ¹é …ç›®çš„ `totalPrice` æ‡‰ç­‰æ–¼ `unitPrice * quantity`
4. **è¯çµ¡äººé¡¯ç¤º**ï¼šå„ªå…ˆé¡¯ç¤º `isPrimary = true` çš„è¯çµ¡äºº
5. **è½‰æ›æç¤º**ï¼šå·²æ¥å—çš„å ±åƒ¹é¡¯ç¤ºé†’ç›®çš„è½‰æ›æŒ‰éˆ•
6. **PDF ä¸‹è¼‰**ï¼šæ”¯æ´é›¢ç·šä¸‹è¼‰å’Œé›»éƒµç™¼é€
7. **è¤‡è£½å ±åƒ¹**ï¼šé»æ“Šã€Œè¤‡è£½å ±åƒ¹ã€å»ºç«‹æ–°è‰ç¨¿ï¼Œè‡ªå‹•å¡«å…¥ç›¸åŒå…§å®¹
8. **åˆªé™¤ä¿è­·**ï¼šå·²ç™¼é€/å·²æ¥å—çš„å ±åƒ¹ä¸å¯åˆªé™¤ï¼Œåªèƒ½ Soft Delete

---

## ğŸ”— ç›¸é—œé é¢

- **ä¸Šä¸€æ­¥**ï¼š[å ±åƒ¹åˆ—è¡¨](./QUOTATIONS.md)
- **ä¸‹ä¸€æ­¥**ï¼š[è½‰æ›ç‚ºèª²ç¨‹](./QUOTATIONS_CONVERT.md)
- **ç›¸é—œ**ï¼š[æ–°å¢å ±åƒ¹](./QUOTATIONS_NEW.md)
