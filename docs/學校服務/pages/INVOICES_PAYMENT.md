# ğŸ’µ è¨˜éŒ„æ”¶æ¬¾ - Invoices Payment

> **è·¯å¾‘**: `/dashboard/school/invoices/[id]/payment`  
> **å„ªå…ˆç´š**: P1  
> **è§’è‰²**: ADMIN, FINANCE

---

## ğŸ“‹ é é¢æ¦‚è¿°

è¨˜éŒ„å­¸æ ¡ä»˜æ¬¾çš„è¡¨å–®é é¢ã€‚æ”¯æ´å…¨é¡æ”¶æ¬¾ã€éƒ¨åˆ†æ”¶æ¬¾ã€å¤šç¨®ä»˜æ¬¾æ–¹å¼ï¼Œä¸¦è‡ªå‹•ç”Ÿæˆæ”¶æ“šã€‚

---

## ğŸ¨ é é¢çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’µ è¨˜éŒ„æ”¶æ¬¾                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“„ ç™¼ç¥¨è³‡æ–™ï¼ˆå”¯è®€ï¼‰      â”‚ â”‚ ğŸ’° æ”¶æ¬¾è¡¨å–®              â”‚   â”‚
â”‚  â”‚                          â”‚ â”‚                          â”‚   â”‚
â”‚  â”‚ ç™¼ç¥¨ç·¨è™Ÿï¼š               â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ INV-2024-09-001          â”‚ â”‚ â”‚ ä»˜æ¬¾ç¢ºèªæ—¥æœŸ *       â”‚ â”‚   â”‚
â”‚  â”‚                          â”‚ â”‚ â”‚ [2024-10-15_______]  â”‚ â”‚   â”‚
â”‚  â”‚ å­¸æ ¡ï¼šè–ä¿ç¾…å°å­¸         â”‚ â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚  â”‚                          â”‚ â”‚ â”‚ å¯¦éš›æ”¶æ¬¾é‡‘é¡ *       â”‚ â”‚   â”‚
â”‚  â”‚ ç™¼ç¥¨æ—¥æœŸï¼š2024-09-30     â”‚ â”‚ â”‚ HK$ [3,900_______]   â”‚ â”‚   â”‚
â”‚  â”‚ åˆ°æœŸæ—¥ï¼š2024-10-30       â”‚ â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚  â”‚                          â”‚ â”‚ â”‚ ç™¼ç¥¨é‡‘é¡ï¼šHK$ 3,900  â”‚ â”‚   â”‚
â”‚  â”‚ ç™¼ç¥¨é‡‘é¡ï¼šHK$ 3,900      â”‚ â”‚ â”‚ å·²æ”¶æ¬¾ï¼šHK$ 0        â”‚ â”‚   â”‚
â”‚  â”‚ å·²æ”¶æ¬¾ï¼šHK$ 0            â”‚ â”‚ â”‚ å¾…æ”¶æ¬¾ï¼šHK$ 3,900    â”‚ â”‚   â”‚
â”‚  â”‚ å¾…æ”¶æ¬¾ï¼šHK$ 3,900        â”‚ â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚  â”‚                          â”‚ â”‚ â”‚ æ”¶æ¬¾é¡å‹ï¼š           â”‚ â”‚   â”‚
â”‚  â”‚ ç‹€æ…‹ï¼šğŸ”µ å·²ç™¼é€          â”‚ â”‚ â”‚ â—‰ å…¨é¡æ”¶æ¬¾           â”‚ â”‚   â”‚
â”‚  â”‚                          â”‚ â”‚ â”‚ â—‹ éƒ¨åˆ†æ”¶æ¬¾           â”‚ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ ä»˜æ¬¾æ–¹å¼ *           â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ [è½‰æ•¸å¿« (FPS)____â–¼]  â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ äº¤æ˜“ç·¨è™Ÿ             â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ [FPS202410151430__]  â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ ä»˜æ¬¾æ†‘è­‰ï¼ˆå¯é¸ï¼‰     â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ [ ğŸ“ ä¸Šå‚³åœ–ç‰‡ ]      â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ å‚™è¨»                 â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ [å·²æ”¶æ¬¾ï¼Œè¬è¬______] â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚                               â”‚ â”‚ [ å–æ¶ˆ ] [ ç¢ºèªæ”¶æ¬¾ ]â”‚ â”‚   â”‚
â”‚                               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“œ æ”¶æ¬¾è¨˜éŒ„ï¼ˆå¦‚æœ‰éƒ¨åˆ†æ”¶æ¬¾ï¼‰                          â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚ â”‚ #1  2024-10-05                                 â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ HK$ 2,000  |  FPS  |  FPS202410051200         â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ ç‹€æ…‹ï¼šå·²ç¢ºèª                                   â”‚  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ç´¯è¨ˆå·²æ”¶ï¼šHK$ 2,000                                 â”‚   â”‚
â”‚  â”‚ æœ¬æ¬¡æ”¶æ¬¾ï¼šHK$ 1,900                                 â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚ ç¸½è¨ˆæ”¶æ¬¾ï¼šHK$ 3,900 âœ“                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ä½¿ç”¨çµ„ä»¶

### TailAdmin çµ„ä»¶

| çµ„ä»¶         | è·¯å¾‘                              | ç”¨é€”     |
| ------------ | --------------------------------- | -------- |
| `Input`      | `components/form/input/`          | è¡¨å–®è¼¸å…¥ |
| `DatePicker` | `components/form/date-picker.tsx` | æ—¥æœŸé¸æ“‡ |
| `Select`     | `components/form/Select.tsx`      | ä»˜æ¬¾æ–¹å¼ |
| `Button`     | `components/ui/button/`           | æ“ä½œæŒ‰éˆ• |
| `Modal`      | `components/ui/modal/`            | ç¢ºèªå½ˆçª— |

### éœ€é–‹ç™¼çµ„ä»¶

| çµ„ä»¶             | èªªæ˜                 |
| ---------------- | -------------------- |
| `AmountInput`    | é‡‘é¡è¼¸å…¥ï¼ˆå¸¶æ ¼å¼åŒ–ï¼‰ |
| `FileUpload`     | æª”æ¡ˆä¸Šå‚³ï¼ˆä»˜æ¬¾æ†‘è­‰ï¼‰ |
| `PaymentSummary` | æ”¶æ¬¾æ‘˜è¦å¡ç‰‡         |

---

## ğŸ“Š è³‡æ–™çµæ§‹

### è¡¨å–®è³‡æ–™

```typescript
interface PaymentFormData {
  // å¿…å¡«æ¬„ä½
  paymentConfirmedDate: Date;
  actualReceivedAmount: number;
  paymentMethod: PaymentMethod;

  // å¯é¸æ¬„ä½
  paymentType: "FULL" | "PARTIAL";
  paymentTransactionNumber?: string;
  paymentProofImage?: File;
  notes?: string;

  // éŠ€è¡Œè³‡è¨Šï¼ˆéŠ€è¡Œè½‰å¸³æ™‚ï¼‰
  bankName?: string;
  bankAccountNumber?: string;

  // æ”¯ç¥¨è³‡è¨Šï¼ˆæ”¯ç¥¨æ™‚ï¼‰
  chequeNumber?: string;
  chequeBank?: string;
  chequeDate?: Date;
}

enum PaymentMethod {
  FPS = "FPS", // è½‰æ•¸å¿«
  BANK_TRANSFER = "BANK_TRANSFER", // éŠ€è¡Œè½‰å¸³
  CHEQUE = "CHEQUE", // æ”¯ç¥¨
  CASH = "CASH", // ç¾é‡‘
  CREDIT_CARD = "CREDIT_CARD", // ä¿¡ç”¨å¡
  OTHER = "OTHER", // å…¶ä»–
}
```

### ä»˜æ¬¾æ–¹å¼æ¬„ä½å°æ‡‰

```typescript
const paymentMethodFields = {
  FPS: ["paymentTransactionNumber"],
  BANK_TRANSFER: ["bankName", "bankAccountNumber", "paymentTransactionNumber"],
  CHEQUE: ["chequeNumber", "chequeBank", "chequeDate"],
  CASH: [],
  CREDIT_CARD: ["paymentTransactionNumber"],
  OTHER: ["notes"],
};
```

---

## ğŸ”„ æ”¶æ¬¾é‚è¼¯

### 1. å…¨é¡æ”¶æ¬¾

```typescript
// API: POST /api/invoices/[id]/payment
async function recordFullPayment(invoiceId: string, data: PaymentFormData) {
  const invoice = await prisma.schoolInvoice.findUnique({
    where: { id: invoiceId },
    include: { receipts: true },
  });

  if (!invoice) throw new Error("Invoice not found");

  // è¨ˆç®—å·²æ”¶æ¬¾ç¸½é¡
  const paidAmount = invoice.receipts.reduce(
    (sum, r) => sum + r.actualReceivedAmount,
    0
  );

  const remainingAmount = invoice.invoiceAmount - paidAmount;

  // é©—è­‰é‡‘é¡
  if (data.actualReceivedAmount !== remainingAmount) {
    throw new Error(`å…¨é¡æ”¶æ¬¾é‡‘é¡æ‡‰ç‚º HK$ ${remainingAmount}`);
  }

  // ç”Ÿæˆæ”¶æ“šç·¨è™Ÿ
  const receiptNumber = await generateReceiptNumber(invoice.schoolId);

  // å»ºç«‹æ”¶æ“š
  const receipt = await prisma.schoolReceipt.create({
    data: {
      schoolId: invoice.schoolId,
      invoiceId: invoice.id,
      receiptNumber,
      paymentConfirmedDate: data.paymentConfirmedDate,
      actualReceivedAmount: data.actualReceivedAmount,
      paymentMethod: data.paymentMethod,
      paymentStatus: "CONFIRMED",
      paymentTransactionNumber: data.paymentTransactionNumber,
      paymentProofImage: data.paymentProofImage,
      notes: data.notes,
      // å…¶ä»–æ¬„ä½...
    },
  });

  // æ›´æ–°ç™¼ç¥¨ç‹€æ…‹
  await prisma.schoolInvoice.update({
    where: { id: invoiceId },
    data: {
      status: "PAID",
      paidAmount: invoice.invoiceAmount,
    },
  });

  // æ›´æ–°èª²å ‚ä»˜æ¬¾ç‹€æ…‹
  await updateLessonPaymentStatus(invoiceId, "PAID");

  return receipt;
}
```

### 2. éƒ¨åˆ†æ”¶æ¬¾

```typescript
async function recordPartialPayment(invoiceId: string, data: PaymentFormData) {
  const invoice = await prisma.schoolInvoice.findUnique({
    where: { id: invoiceId },
    include: { receipts: true },
  });

  if (!invoice) throw new Error("Invoice not found");

  // è¨ˆç®—å·²æ”¶æ¬¾ç¸½é¡
  const paidAmount = invoice.receipts.reduce(
    (sum, r) => sum + r.actualReceivedAmount,
    0
  );

  const remainingAmount = invoice.invoiceAmount - paidAmount;

  // é©—è­‰é‡‘é¡
  if (data.actualReceivedAmount <= 0) {
    throw new Error("æ”¶æ¬¾é‡‘é¡å¿…é ˆå¤§æ–¼ 0");
  }

  if (data.actualReceivedAmount > remainingAmount) {
    throw new Error(`æ”¶æ¬¾é‡‘é¡ä¸èƒ½è¶…éå¾…æ”¶æ¬¾é‡‘é¡ HK$ ${remainingAmount}`);
  }

  // ç”Ÿæˆæ”¶æ“šç·¨è™Ÿ
  const receiptNumber = await generateReceiptNumber(invoice.schoolId);

  // å»ºç«‹æ”¶æ“š
  const receipt = await prisma.schoolReceipt.create({
    data: {
      schoolId: invoice.schoolId,
      invoiceId: invoice.id,
      receiptNumber,
      paymentConfirmedDate: data.paymentConfirmedDate,
      actualReceivedAmount: data.actualReceivedAmount,
      paymentMethod: data.paymentMethod,
      paymentStatus: "CONFIRMED",
      paymentTransactionNumber: data.paymentTransactionNumber,
      notes: data.notes,
      // å…¶ä»–æ¬„ä½...
    },
  });

  const newPaidAmount = paidAmount + data.actualReceivedAmount;

  // æ›´æ–°ç™¼ç¥¨ç‹€æ…‹
  if (newPaidAmount >= invoice.invoiceAmount) {
    // å…¨é¡æ”¶é½Š
    await prisma.schoolInvoice.update({
      where: { id: invoiceId },
      data: {
        status: "PAID",
        paidAmount: invoice.invoiceAmount,
      },
    });

    await updateLessonPaymentStatus(invoiceId, "PAID");
  } else {
    // ä»æœ‰å¾…æ”¶æ¬¾
    await prisma.schoolInvoice.update({
      where: { id: invoiceId },
      data: {
        status: "PARTIAL",
        paidAmount: newPaidAmount,
      },
    });
  }

  return receipt;
}
```

### 3. æ›´æ–°èª²å ‚ä»˜æ¬¾ç‹€æ…‹

```typescript
async function updateLessonPaymentStatus(
  invoiceId: string,
  status: "PAID" | "PARTIAL"
) {
  // é€é SchoolInvoiceCourse æ‰¾åˆ°é—œè¯çš„èª²ç¨‹
  const invoiceCourses = await prisma.schoolInvoiceCourse.findMany({
    where: { invoiceId },
    select: { courseId: true },
  });

  const courseIds = invoiceCourses.map((ic) => ic.courseId);

  // æ›´æ–°èª²å ‚çš„ä»˜æ¬¾ç‹€æ…‹
  await prisma.schoolLesson.updateMany({
    where: {
      courseId: { in: courseIds },
      invoiceStatus: "INVOICED",
      // éœ€è¦æ›´ç²¾ç¢ºåœ°é—œè¯åˆ°æ­¤ç™¼ç¥¨çš„èª²å ‚
    },
    data: {
      paymentStatus: status,
    },
  });
}
```

---

## ğŸ“ æ”¶æ“šç·¨è™Ÿç”Ÿæˆ

### ç·¨è™Ÿè¦å‰‡

```
æ ¼å¼ï¼šREC-YYYY-MM-XXXXX

ç¯„ä¾‹ï¼š
REC-2024-10-00001
REC-2024-10-00002
```

### å¯¦ä½œ

```typescript
async function generateReceiptNumber(schoolId: string): Promise<string> {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, "0");

  const prefix = `REC-${year}-${month}-`;

  // æŸ¥è©¢æœ¬æœˆæœ€å¾Œä¸€å€‹æ”¶æ“šç·¨è™Ÿ
  const lastReceipt = await prisma.schoolReceipt.findFirst({
    where: {
      receiptNumber: {
        startsWith: prefix,
      },
    },
    orderBy: {
      receiptNumber: "desc",
    },
  });

  let sequence = 1;
  if (lastReceipt) {
    const lastSequence = parseInt(lastReceipt.receiptNumber.split("-")[3]);
    sequence = lastSequence + 1;
  }

  const receiptNumber = `${prefix}${String(sequence).padStart(5, "0")}`;

  return receiptNumber;
}
```

---

## ğŸ“¤ ä»˜æ¬¾æ†‘è­‰ä¸Šå‚³

### æª”æ¡ˆè™•ç†

```typescript
async function uploadPaymentProof(file: File): Promise<string> {
  // é©—è­‰æª”æ¡ˆé¡å‹
  const allowedTypes = [
    "image/jpeg",
    "image/png",
    "image/jpg",
    "application/pdf",
  ];
  if (!allowedTypes.includes(file.type)) {
    throw new Error("åªæ”¯æ´ JPG, PNG, PDF æ ¼å¼");
  }

  // é©—è­‰æª”æ¡ˆå¤§å°ï¼ˆæœ€å¤§ 5MBï¼‰
  const maxSize = 5 * 1024 * 1024;
  if (file.size > maxSize) {
    throw new Error("æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 5MB");
  }

  // ä¸Šå‚³åˆ°å„²å­˜ç©ºé–“ï¼ˆS3 / Cloudinary / Localï¼‰
  const uploadResult = await uploadToStorage(file);

  return uploadResult.url;
}
```

---

## ğŸ¨ å‹•æ…‹æ¬„ä½é¡¯ç¤º

### æ ¹æ“šä»˜æ¬¾æ–¹å¼é¡¯ç¤ºä¸åŒæ¬„ä½

```typescript
function PaymentForm() {
  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>("FPS");

  return (
    <form>
      {/* å›ºå®šæ¬„ä½ */}
      <DatePicker name="paymentConfirmedDate" required />
      <AmountInput name="actualReceivedAmount" required />
      <Select
        name="paymentMethod"
        value={paymentMethod}
        onChange={setPaymentMethod}
        required
      />

      {/* å‹•æ…‹æ¬„ä½ */}
      {paymentMethod === "FPS" && (
        <Input
          name="paymentTransactionNumber"
          label="FPS äº¤æ˜“ç·¨è™Ÿ"
          placeholder="FPS202410151430"
        />
      )}

      {paymentMethod === "BANK_TRANSFER" && (
        <>
          <Input name="bankName" label="éŠ€è¡Œåç¨±" />
          <Input name="bankAccountNumber" label="å¸³æˆ¶è™Ÿç¢¼" />
          <Input name="paymentTransactionNumber" label="äº¤æ˜“ç·¨è™Ÿ" />
        </>
      )}

      {paymentMethod === "CHEQUE" && (
        <>
          <Input name="chequeNumber" label="æ”¯ç¥¨è™Ÿç¢¼" required />
          <Input name="chequeBank" label="æ”¯ç¥¨éŠ€è¡Œ" />
          <DatePicker name="chequeDate" label="æ”¯ç¥¨æ—¥æœŸ" />
        </>
      )}

      {/* å…±ç”¨æ¬„ä½ */}
      <FileUpload name="paymentProofImage" label="ä»˜æ¬¾æ†‘è­‰" />
      <Textarea name="notes" label="å‚™è¨»" />

      <Button type="submit">ç¢ºèªæ”¶æ¬¾</Button>
    </form>
  );
}
```

---

## âœ… è¡¨å–®é©—è­‰

### å®¢æˆ¶ç«¯é©—è­‰

```typescript
const paymentSchema = z
  .object({
    paymentConfirmedDate: z.date(),
    actualReceivedAmount: z.number().positive("é‡‘é¡å¿…é ˆå¤§æ–¼ 0"),
    paymentMethod: z.enum([
      "FPS",
      "BANK_TRANSFER",
      "CHEQUE",
      "CASH",
      "CREDIT_CARD",
      "OTHER",
    ]),
    paymentType: z.enum(["FULL", "PARTIAL"]),

    // æ¢ä»¶é©—è­‰
    paymentTransactionNumber: z.string().optional(),
    bankName: z.string().optional(),
    chequeNumber: z.string().optional(),

    notes: z.string().optional(),
  })
  .refine(
    (data) => {
      // FPS å¿…é ˆæœ‰äº¤æ˜“ç·¨è™Ÿ
      if (data.paymentMethod === "FPS" && !data.paymentTransactionNumber) {
        return false;
      }
      return true;
    },
    {
      message: "FPS ä»˜æ¬¾å¿…é ˆå¡«å¯«äº¤æ˜“ç·¨è™Ÿ",
      path: ["paymentTransactionNumber"],
    }
  );
```

### ä¼ºæœå™¨ç«¯é©—è­‰

```typescript
async function validatePayment(invoiceId: string, data: PaymentFormData) {
  const invoice = await prisma.schoolInvoice.findUnique({
    where: { id: invoiceId },
    include: { receipts: true },
  });

  if (!invoice) {
    throw new Error("ç™¼ç¥¨ä¸å­˜åœ¨");
  }

  if (invoice.status === "PAID") {
    throw new Error("ç™¼ç¥¨å·²å…¨é¡æ”¶æ¬¾");
  }

  // è¨ˆç®—å¾…æ”¶æ¬¾é‡‘é¡
  const paidAmount = invoice.receipts.reduce(
    (sum, r) => sum + r.actualReceivedAmount,
    0
  );
  const remainingAmount = invoice.invoiceAmount - paidAmount;

  if (data.actualReceivedAmount > remainingAmount) {
    throw new Error(`æ”¶æ¬¾é‡‘é¡ä¸èƒ½è¶…éå¾…æ”¶æ¬¾é‡‘é¡ HK$ ${remainingAmount}`);
  }

  // å…¨é¡æ”¶æ¬¾é©—è­‰
  if (
    data.paymentType === "FULL" &&
    data.actualReceivedAmount !== remainingAmount
  ) {
    throw new Error(`å…¨é¡æ”¶æ¬¾é‡‘é¡æ‡‰ç‚º HK$ ${remainingAmount}`);
  }

  return true;
}
```

---

## ğŸ“„ æ”¶æ“šç”Ÿæˆ

### è‡ªå‹•ç”Ÿæˆæ”¶æ“š

æ”¶æ¬¾æˆåŠŸå¾Œï¼Œè‡ªå‹•ç”Ÿæˆæ”¶æ“š PDFï¼š

```typescript
async function generateReceiptPDF(receipt: SchoolReceipt) {
  const doc = new jsPDF();

  // æ¨™é¡Œ
  doc.setFontSize(20);
  doc.text("é¦™æ¸¯è·³ç¹©å­¸é™¢", 105, 20, { align: "center" });
  doc.setFontSize(16);
  doc.text("RECEIPT / æ”¶æ“š", 105, 30, { align: "center" });

  // æ”¶æ“šè³‡è¨Š
  doc.setFontSize(12);
  doc.text(`æ”¶æ“šç·¨è™Ÿï¼š${receipt.receiptNumber}`, 20, 45);
  doc.text(`æ—¥æœŸï¼š${formatDate(receipt.paymentConfirmedDate)}`, 20, 52);

  // å­¸æ ¡è³‡è¨Š
  const school = await prisma.school.findUnique({
    where: { id: receipt.schoolId },
  });
  doc.text(`æ”¶æ¬¾è‡ªï¼š${school.schoolName}`, 20, 65);

  // ç™¼ç¥¨è³‡è¨Š
  const invoice = await prisma.schoolInvoice.findUnique({
    where: { id: receipt.invoiceId },
  });
  doc.text(`ç™¼ç¥¨ç·¨è™Ÿï¼š${invoice.invoiceNumber}`, 20, 78);

  // æ”¶æ¬¾è³‡è¨Š
  doc.setFontSize(14);
  doc.text(
    `æ”¶æ¬¾é‡‘é¡ï¼šHK$ ${receipt.actualReceivedAmount.toLocaleString()}`,
    20,
    95
  );
  doc.setFontSize(12);
  doc.text(
    `ä»˜æ¬¾æ–¹å¼ï¼š${getPaymentMethodLabel(receipt.paymentMethod)}`,
    20,
    105
  );

  if (receipt.paymentTransactionNumber) {
    doc.text(`äº¤æ˜“ç·¨è™Ÿï¼š${receipt.paymentTransactionNumber}`, 20, 112);
  }

  // å‚™è¨»
  if (receipt.notes) {
    doc.text(`å‚™è¨»ï¼š${receipt.notes}`, 20, 125);
  }

  // å„²å­˜
  const filename = `Receipt_${receipt.receiptNumber}.pdf`;
  doc.save(filename);

  return filename;
}
```

---

## ğŸ¯ UX é‡é»

### 1. å³æ™‚è¨ˆç®—

```typescript
function PaymentAmountInput({ invoice, receipts }) {
  const paidAmount = receipts.reduce(
    (sum, r) => sum + r.actualReceivedAmount,
    0
  );
  const remainingAmount = invoice.invoiceAmount - paidAmount;

  const [amount, setAmount] = useState(remainingAmount);
  const [paymentType, setPaymentType] = useState<"FULL" | "PARTIAL">("FULL");

  return (
    <div>
      <div className="summary">
        <p>ç™¼ç¥¨é‡‘é¡ï¼šHK$ {invoice.invoiceAmount.toLocaleString()}</p>
        <p>å·²æ”¶æ¬¾ï¼šHK$ {paidAmount.toLocaleString()}</p>
        <p>å¾…æ”¶æ¬¾ï¼šHK$ {remainingAmount.toLocaleString()}</p>
      </div>

      <RadioGroup value={paymentType} onChange={setPaymentType}>
        <Radio value="FULL">
          å…¨é¡æ”¶æ¬¾ (HK$ {remainingAmount.toLocaleString()})
        </Radio>
        <Radio value="PARTIAL">éƒ¨åˆ†æ”¶æ¬¾</Radio>
      </RadioGroup>

      <AmountInput
        value={amount}
        onChange={setAmount}
        disabled={paymentType === "FULL"}
        max={remainingAmount}
      />
    </div>
  );
}
```

### 2. ç¢ºèªå½ˆçª—

æäº¤å‰é¡¯ç¤ºç¢ºèªå½ˆçª—ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¢ºèªæ”¶æ¬¾è³‡è¨Š                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç™¼ç¥¨ç·¨è™Ÿï¼šINV-2024-09-001              â”‚
â”‚ å­¸æ ¡ï¼šè–ä¿ç¾…å°å­¸                       â”‚
â”‚                                        â”‚
â”‚ æ”¶æ¬¾æ—¥æœŸï¼š2024-10-15                   â”‚
â”‚ æ”¶æ¬¾é‡‘é¡ï¼šHK$ 3,900                    â”‚
â”‚ ä»˜æ¬¾æ–¹å¼ï¼šè½‰æ•¸å¿« (FPS)                 â”‚
â”‚ äº¤æ˜“ç·¨è™Ÿï¼šFPS202410151430              â”‚
â”‚                                        â”‚
â”‚ æ­¤æ“ä½œå°‡ç”Ÿæˆæ”¶æ“šä¸¦æ›´æ–°ç™¼ç¥¨ç‹€æ…‹ç‚ºå·²ä»˜æ¬¾ã€‚â”‚
â”‚                                        â”‚
â”‚ [ å–æ¶ˆ ] [ ç¢ºèªæ”¶æ¬¾ ]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æˆåŠŸæç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… æ”¶æ¬¾è¨˜éŒ„æˆåŠŸ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ”¶æ“šç·¨è™Ÿï¼šREC-2024-10-00001            â”‚
â”‚ æ”¶æ¬¾é‡‘é¡ï¼šHK$ 3,900                    â”‚
â”‚                                        â”‚
â”‚ [ ğŸ“„ ä¸‹è¼‰æ”¶æ“š ] [ ğŸ“§ ç™¼é€æ”¶æ“š ]       â”‚
â”‚ [ è¿”å›ç™¼ç¥¨åˆ—è¡¨ ]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### 1. å…¨é¡æ”¶æ¬¾

```typescript
// å¾…æ”¶æ¬¾ = ç™¼ç¥¨é‡‘é¡ - å·²æ”¶æ¬¾
// è¼¸å…¥é‡‘é¡ = å¾…æ”¶æ¬¾ â†’ æˆåŠŸ
// è¼¸å…¥é‡‘é¡ < å¾…æ”¶æ¬¾ â†’ éŒ¯èª¤
// è¼¸å…¥é‡‘é¡ > å¾…æ”¶æ¬¾ â†’ éŒ¯èª¤
```

### 2. éƒ¨åˆ†æ”¶æ¬¾

```typescript
// ç¬¬ä¸€æ¬¡ï¼šæ”¶ HK$ 2,000 â†’ ç‹€æ…‹è®Šæ›´ç‚º PARTIAL
// ç¬¬äºŒæ¬¡ï¼šæ”¶ HK$ 1,900 â†’ ç‹€æ…‹è®Šæ›´ç‚º PAID
```

### 3. ä»˜æ¬¾æ–¹å¼é©—è­‰

```typescript
// FPSï¼šå¿…é ˆæœ‰äº¤æ˜“ç·¨è™Ÿ
// æ”¯ç¥¨ï¼šå¿…é ˆæœ‰æ”¯ç¥¨è™Ÿç¢¼
// ç¾é‡‘ï¼šç„¡é¡å¤–å¿…å¡«æ¬„ä½
```

---

## ğŸ“Œ é–‹ç™¼æ³¨æ„äº‹é …

1. **é‡‘é¡é©—è­‰**ï¼šæ”¶æ¬¾é‡‘é¡ä¸èƒ½è¶…éå¾…æ”¶æ¬¾é‡‘é¡
2. **é‡è¤‡æ”¶æ¬¾**ï¼šå…è¨±å¤šæ¬¡éƒ¨åˆ†æ”¶æ¬¾ï¼Œç›´åˆ°å…¨é¡æ”¶é½Š
3. **æ”¶æ“šç·¨è™Ÿ**ï¼šè‡ªå‹•ç”Ÿæˆï¼Œä¸å¯é‡è¤‡
4. **ä»˜æ¬¾æ†‘è­‰**ï¼šæ”¯æ´åœ–ç‰‡å’Œ PDFï¼Œé™åˆ¶æª”æ¡ˆå¤§å°
5. **è‡ªå‹•æ›´æ–°**ï¼šæ”¶æ¬¾å¾Œè‡ªå‹•æ›´æ–°ç™¼ç¥¨å’Œèª²å ‚ç‹€æ…‹
6. **æ”¶æ“šä¸‹è¼‰**ï¼šæ”¶æ¬¾æˆåŠŸå¾Œæä¾›æ”¶æ“šä¸‹è¼‰é€£çµ
7. **é›»éƒµé€šçŸ¥**ï¼šå¯é¸æ“‡ç™¼é€æ”¶æ“šçµ¦å­¸æ ¡è¯çµ¡äºº
8. **äº¤æ˜“è¨˜éŒ„**ï¼šæ‰€æœ‰æ”¶æ¬¾è¨˜éŒ„ä¸å¯åˆªé™¤ï¼ˆç¨½æ ¸éœ€æ±‚ï¼‰

---

## ğŸ”— ç›¸é—œé é¢

- **ä¸Šä¸€æ­¥**ï¼š[ç™¼ç¥¨è©³æƒ…](./INVOICES_DETAIL.md)
- **ç›¸é—œ**ï¼š[ç™¼ç¥¨åˆ—è¡¨](./INVOICES.md)
- **ç›¸é—œ**ï¼š[è²¡å‹™å„€è¡¨æ¿](./FINANCE.md)
