# TASK-004 會話總結 - 2026-02-02 Session 3

## 任務狀態：✅ 完成

### 已完成項目

#### 1. 建立 OtpInput 共用組件

```typescript
// src/components/shared/forms/OtpInput.tsx
export interface OtpInputProps {
  value: string[];
  onChange: (value: string[]) => void;
  length?: number;
  disabled?: boolean;
  autoFocus?: boolean;
}

export interface OtpInputRef {
  focus: () => void;
  clear: () => void;
}
```

**功能**：

- 6 位數字驗證碼輸入
- 自動跳格（輸入後自動移至下一格）
- Backspace 返回上一格
- 左右箭頭鍵導航
- 貼上支援（自動分配數字到各格）
- `ref` 暴露 `focus()` 和 `clear()` 方法

#### 2. 擴展 FormError 組件

新增 `className` 屬性支援：

```typescript
export interface FormErrorProps {
  message?: string;
  className?: string;
}
```

#### 3. 重構使用 OtpInput 的組件

| 組件                 | 變更                         | 行數變化         |
| :------------------- | :--------------------------- | :--------------- |
| ResetPasswordOtpStep | 使用 OtpInput + SubmitButton | 179 → 83 (-54%)  |
| OtpForm              | 使用 OtpInput + FormError    | 241 → 158 (-34%) |
| UserInfoEditModal    | 使用 OtpInput + FormError    | 490 → 451 (-8%)  |

#### 4. 替換剩餘 FormError

| 組件              | 變更               |
| :---------------- | :----------------- |
| ResetPasswordForm | 使用共用 FormError |
| NewCourseForm     | 使用共用 FormError |

### 行數變化總結

| 組件                 | 優化前 | 優化後 | 變化 |
| :------------------- | :----- | :----- | :--- |
| ResetPasswordOtpStep | 179    | 83     | -54% |
| OtpForm              | 241    | 158    | -34% |
| UserInfoEditModal    | 490    | 451    | -8%  |

### 驗收檢查

- [x] `pnpm build` 成功
- [x] TypeScript 無錯誤
- [ ] **登入/註冊/重設密碼功能待手動測試**

### Next Steps

1. **手動測試** — 啟動 `pnpm dev` 測試：
   - 登入功能
   - 註冊功能（OTP 驗證）
   - 重設密碼（OTP 驗證）
   - 個人資料編輯（電話/電郵 OTP 驗證）
2. **歸檔任務** — 測試通過後移動到 `_ARCHIVE/2026-02/`

### 修改的文件

**新增/擴展**：

- `src/components/shared/forms/OtpInput.tsx` — OTP 輸入共用組件
- `src/components/shared/forms/FormError.tsx` — 擴展支援 className
- `src/components/shared/forms/index.ts` — 導出 OtpInput 和 FormErrorProps

**重構**：

- `src/features/auth/components/OtpForm.tsx` — 使用 OtpInput + FormError
- `src/features/auth/components/reset-password/ResetPasswordOtpStep.tsx` — 使用 OtpInput + SubmitButton
- `src/features/auth/components/ResetPasswordForm.tsx` — 使用 FormError
- `src/features/user/components/profile/UserInfoEditModal.tsx` — 使用 OtpInput + FormError
- `src/features/school-service/components/course/NewCourseForm.tsx` — 使用 FormError

#### 5. 建立 useCountdown Hook

```typescript
// src/components/shared/forms/ResendCountdown.tsx
export function useCountdown(initialCount = 60) {
  const [countdown, setCountdown] = useState(0);
  // ...
  return { countdown, isActive, startCountdown, resetCountdown };
}
```

**重構使用 useCountdown**：

- `ResetPasswordOtpStep` — 移除手動 useEffect 倒計時
- `OtpForm` — 移除手動 useEffect 倒計時
- `UserInfoEditModal` — 移除手動 useEffect 倒計時

#### 6. 修復 Build 問題

**DATABASE_URL client-side import 問題**：

- 原因：`@/features/user/index.ts` 同時導出了 client-safe 的 actions 和 server-only 的 queries
- 修復：建立 `@/features/user/server.ts` 專門導出 server-only 的 queries

```typescript
// src/features/user/server.ts
import "server-only";

export { getProfile, getAddress, ... } from "./queries";
```

### 共用組件清單（最終）

```
src/components/shared/forms/
├── PasswordField.tsx       # 密碼欄位 + 顯示/隱藏切換
├── FormError.tsx           # 錯誤訊息顯示（支援 className）
├── SubmitButton.tsx        # 提交按鈕 + loading 狀態
├── LoginMethodToggle.tsx   # 泛用切換組件
├── OtpInput.tsx            # OTP 6 位數字輸入
├── ResendCountdown.tsx     # useCountdown hook + ResendCountdown 組件
└── index.ts                # 公開 API
```
