# Session 01 — Server Actions 遷移（2026-02-02）

## 會話摘要

本次會話完成了 **階段一（Action 基礎設施）** 和 **階段二（Auth 模組遷移）**，進度約 40%。

---

## 已完成工作

### 階段一：Action 基礎設施 ✅

建立了 `src/lib/actions/` 目錄：

| 檔案 | 內容 |
|:-----|:-----|
| `types.ts` | `ActionResult<T>`, `ActionErrorCode`, `success()`, `failure()` |
| `safe-action.ts` | `safeAction()`, `safeActionWithoutSchema()` |
| `guards.ts` | `requireUser()`, `requirePermission()`, `requireRole()` |
| `index.ts` | 統一導出 |

### 階段二：Auth 模組遷移 ✅

建立了 `src/features/auth/` 下的新檔案：

| 檔案 | 內容 |
|:-----|:-----|
| `schema.ts` | 7 個 Zod schemas |
| `actions.ts` | 7 個 Server Actions |

更新了以下組件：

- `SignUpForm.tsx` — 改用 `useTransition` + Actions（移除 4 個 fetch 調用）
- `ResetPasswordForm.tsx` — 改用 `useTransition` + Actions（移除 4 個 fetch 調用）
- `reset-password/ResetPasswordOtpStep.tsx` — 更新 props 類型
- `reset-password/ResetPasswordNewStep.tsx` — 更新 props 類型
- `index.ts` — 導出 Actions、Schemas、Types

### Auth Actions 清單

```typescript
// src/features/auth/actions.ts
export const sendOtpAction = safeAction(sendOtpSchema, ...)
export const verifyOtpAction = safeAction(verifyOtpSchema, ...)
export const registerAction = safeAction(registerSchema, ...)
export const changePasswordAction = safeAction(changePasswordSchema, ...)
export const resetPasswordSendAction = safeAction(resetPasswordSendSchema, ...)
export const resetPasswordVerifyAction = safeAction(resetPasswordVerifySchema, ...)
export const resetPasswordAction = safeAction(resetPasswordSchema, ...)
```

---

## 未完成工作

### 階段三：User 模組（待開始）

需要遷移的 API Routes：
- `/api/user/profile` — GET, PATCH
- `/api/user/address` — GET, PATCH
- `/api/user/bank` — GET, PATCH
- `/api/user/children` — GET, POST, PATCH, DELETE
- `/api/user/tutor/document` — POST

需要建立：
- `src/features/user/schema.ts`
- `src/features/user/queries.ts`
- `src/features/user/actions.ts`

需要更新的組件（參考 `src/features/user/components/profile/`）：
- `UserInfoEditModal.tsx` — 有 2 處 fetch 調用（OTP 相關）
- `UserTutorCard.tsx` — 有 1 處 fetch 調用（文件上傳）

### 階段四：School Service 模組（待開始）

需要遷移的 API Routes：
- `/api/school-service/courses` — GET, POST
- `/api/school-service/courses/batch-with-school` — POST
- `/api/school-service/schools` — GET, POST
- `/api/school-service/schools/[id]` — GET, PATCH

需要建立：
- `src/features/school-service/schema.ts`
- `src/features/school-service/queries.ts`
- `src/features/school-service/actions.ts`

需要更新的組件：
- `NewCourseForm.tsx` — 1 處 fetch
- `SchoolFormStep.tsx` — 1 處 fetch
- `app/(private)/dashboard/school/courses/new/page.tsx` — 1 處 fetch

### 階段五：收尾（待開始）

- 標記/刪除廢棄的 API Routes
- 更新文檔
- 執行驗證：`pnpm lint && pnpm type-check && pnpm build`

---

## 重要注意事項

1. **保留的 API Route**：`/api/auth/[...nextauth]` 是 NextAuth 核心，不需要遷移

2. **Zod v4 語法**：使用 `{ message: "..." }` 而非 `{ errorMap: ... }`
   ```typescript
   z.enum(OTP_PURPOSES, { message: "無效的驗證用途" })
   ```

3. **Rate limit 在 Server Actions 中取得 IP**：
   ```typescript
   import { headers } from "next/headers";
   const headersList = await headers();
   const ip = headersList.get("x-forwarded-for")?.split(",")[0] || "unknown";
   ```

4. **組件 props 類型更新**：將 `Promise<void>` 改為 `void | Promise<void>` 以支援 sync 函式

---

## 參考文件

- 任務資訊：`docs/02-Tasks/_ACTIVE/TASK-0005-server-actions-migration/00-task-info.yaml`
- 技術方案：`docs/02-Tasks/_ACTIVE/TASK-0005-server-actions-migration/02-Technical-Plan.md`
- 進度追蹤：`docs/02-Tasks/_ACTIVE/TASK-0005-server-actions-migration/03-Implementation-Progress.md`
