# ğŸ“ ç”Ÿæˆç™¼ç¥¨ - Invoices Generate

> **è·¯å¾‘**: `/dashboard/school/invoices/generate`  
> **å„ªå…ˆç´š**: P0  
> **è§’è‰²**: ADMIN, FINANCE

---

## ğŸ“‹ é é¢æ¦‚è¿°

å¤šæ­¥é©Ÿè¡¨å–®ï¼Œç”¨æ–¼å¾å·²å®Œæˆèª²å ‚ç”Ÿæˆç™¼ç¥¨ã€‚æ”¯æ´é¸æ“‡å¤šå€‹èª²ç¨‹ã€æ—¥æœŸç¯„åœç¯©é¸ã€èª²å ‚æ‰‹å‹•å‹¾é¸ã€‚

---

## ğŸ¨ é é¢çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ ç”Ÿæˆç™¼ç¥¨                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ­¥é©Ÿ 1        æ­¥é©Ÿ 2        æ­¥é©Ÿ 3        æ­¥é©Ÿ 4    â”‚   â”‚
â”‚  â”‚ â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹      â”‚   â”‚
â”‚  â”‚ é¸æ“‡å­¸æ ¡      é¸æ“‡èª²å ‚      å¡«å¯«è³‡æ–™      é è¦½ç¢ºèª  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ­¥é©Ÿ 2ï¼šé¸æ“‡èª²ç¨‹èˆ‡èª²å ‚                               â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚ â”‚ â˜‘ è·³ç¹©æ†å¸¸ç­ï¼ˆä¸Šå­¸æœŸï¼‰                         â”‚  â”‚   â”‚
â”‚  â”‚ â”‚                                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ èª²å ‚ç¯„åœï¼š                                     â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â—‰ ä¾æ—¥æœŸï¼š[2024-09-01] ~ [2024-09-30]         â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â—‹ ä¾å ‚æ•¸ï¼šç¬¬ [__] å ‚ è‡³ ç¬¬ [__] å ‚            â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ â—‹ æ‰‹å‹•é¸æ“‡                                    â”‚  â”‚   â”‚
â”‚  â”‚ â”‚                                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ å·²å®Œæˆèª²å ‚ï¼š8 å ‚                               â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ å·²é–‹ç¥¨ï¼š0 å ‚                                   â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ å¯é–‹ç¥¨ï¼š8 å ‚ âœ“                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚                                                â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ å°è¨ˆï¼š8 å ‚ x $50 x 20äºº = $8,000              â”‚  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚ â”‚ â˜ é€Ÿåº¦è·³è¨“ç·´                                   â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ ...                                            â”‚  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ç™¼ç¥¨ç¸½è¨ˆï¼šHK$ 8,000                                 â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚                              [ â† ä¸Šä¸€æ­¥ ] [ ä¸‹ä¸€æ­¥ â†’ ] â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ä½¿ç”¨çµ„ä»¶

### TailAdmin çµ„ä»¶

| çµ„ä»¶                 | è·¯å¾‘                                        | ç”¨é€”     |
| -------------------- | ------------------------------------------- | -------- |
| `CreateInvoiceTable` | `components/invoice/CreateInvoiceTable.tsx` | åƒè€ƒçµæ§‹ |
| `Select`             | `components/form/Select.tsx`                | å­¸æ ¡é¸æ“‡ |
| `DatePicker`         | `components/form/date-picker.tsx`           | æ—¥æœŸç¯„åœ |
| `Switch`             | `components/form/switch/`                   | èª²ç¨‹å‹¾é¸ |
| `Modal`              | `components/ui/modal/`                      | ç¢ºèªå½ˆçª— |

### éœ€é–‹ç™¼çµ„ä»¶

| çµ„ä»¶                    | èªªæ˜              |
| ----------------------- | ----------------- |
| `CourseInvoiceSelector` | èª²ç¨‹é¸æ“‡+èª²å ‚ç¯„åœ |
| `LessonCheckboxList`    | èª²å ‚å‹¾é¸åˆ—è¡¨      |
| `InvoicePreview`        | ç™¼ç¥¨é è¦½          |

---

## ğŸ“Š è¡¨å–®çµæ§‹

### æ­¥é©Ÿ 1ï¼šé¸æ“‡å­¸æ ¡

```typescript
interface Step1Data {
  schoolId: string;
}
```

### æ­¥é©Ÿ 2ï¼šé¸æ“‡èª²ç¨‹èˆ‡èª²å ‚

```typescript
interface Step2Data {
  courses: CourseSelection[];
}

interface CourseSelection {
  courseId: string;
  courseName: string;
  included: boolean; // æ˜¯å¦åŒ…å«

  selectionMode: "date_range" | "lesson_range" | "manual";

  // æ—¥æœŸç¯„åœæ¨¡å¼
  dateStart?: Date;
  dateEnd?: Date;

  // å ‚æ•¸ç¯„åœæ¨¡å¼
  lessonStart?: number;
  lessonEnd?: number;

  // æ‰‹å‹•æ¨¡å¼
  selectedLessonIds?: string[];

  // è¨ˆç®—çµæœ
  availableLessons: LessonForInvoice[];
  selectedLessons: LessonForInvoice[];
  subtotal: number;
}

interface LessonForInvoice {
  id: string;
  lessonDate: Date;
  lessonNumber: number;
  studentCount: number;
  feeLesson: number;
  invoiceStatus: InvoiceStatus;
}
```

### æ­¥é©Ÿ 3ï¼šå¡«å¯«æ”¶ä»¶äººè³‡æ–™

```typescript
interface Step3Data {
  recipientName: string;
  recipientPosition?: string;
  recipientEmail?: string;
  mailingAddress?: string;
  paymentTermsDays: number; // é è¨­ 30
  notes?: string;
}
```

### æ­¥é©Ÿ 4ï¼šé è¦½ç¢ºèª

```typescript
interface Step4Data {
  confirmed: boolean;
  sendMethod?: "email" | "download" | "draft";
}
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. ç²å–å¯é–‹ç¥¨èª²å ‚

```typescript
// API: GET /api/schools/[id]/invoiceable-lessons
async function getInvoiceableLessons(schoolId: string) {
  // ç²å–å­¸æ ¡çš„æ‰€æœ‰æ´»èºèª²ç¨‹
  const courses = await prisma.schoolCourse.findMany({
    where: {
      schoolId,
      status: "ACTIVE",
      deletedAt: null,
    },
    include: {
      lessons: {
        where: {
          lessonStatus: "COMPLETED",
          invoiceStatus: "NOT_INVOICED",
          deletedAt: null,
        },
        orderBy: { lessonDate: "asc" },
      },
    },
  });

  return courses.map((course) => ({
    courseId: course.id,
    courseName: course.courseName,
    chargingModel: course.chargingModel,
    studentPerLessonFee: course.studentPerLessonFee,
    fixedPerLessonFee: course.fixedPerLessonFee,
    lessons: course.lessons.map((lesson) => ({
      id: lesson.id,
      lessonDate: lesson.lessonDate,
      lessonNumber: lesson.lessonNumber,
      studentCount: lesson.studentCount,
      feeLesson: lesson.feeLesson,
    })),
    stats: {
      completedCount: course.lessons.length,
      totalFee: course.lessons.reduce(
        (sum, l) => sum + Number(l.feeLesson || 0),
        0
      ),
    },
  }));
}
```

### 2. èª²å ‚ç¯©é¸é‚è¼¯

```typescript
function filterLessons(
  lessons: LessonForInvoice[],
  mode: "date_range" | "lesson_range" | "manual",
  options: {
    dateStart?: Date;
    dateEnd?: Date;
    lessonStart?: number;
    lessonEnd?: number;
    selectedIds?: string[];
  }
): LessonForInvoice[] {
  switch (mode) {
    case "date_range":
      return lessons.filter(
        (l) =>
          l.lessonDate >= options.dateStart! && l.lessonDate <= options.dateEnd!
      );

    case "lesson_range":
      return lessons.filter(
        (l) =>
          l.lessonNumber >= options.lessonStart! &&
          l.lessonNumber <= options.lessonEnd!
      );

    case "manual":
      return lessons.filter((l) => options.selectedIds!.includes(l.id));

    default:
      return [];
  }
}
```

### 3. é‡‘é¡è¨ˆç®—

```typescript
function calculateSubtotal(
  lessons: LessonForInvoice[],
  chargingModel: ChargingModel,
  studentPerLessonFee?: number,
  fixedPerLessonFee?: number
): number {
  switch (chargingModel) {
    case "STUDENT_PER_LESSON":
      // ä½¿ç”¨èª²å ‚è¨˜éŒ„çš„ feeLessonï¼ˆå·²æŒ‰å­¸ç”Ÿäººæ•¸è¨ˆç®—ï¼‰
      return lessons.reduce((sum, l) => sum + Number(l.feeLesson || 0), 0);

    case "FIXED_PER_LESSON":
      return lessons.length * (fixedPerLessonFee || 0);

    default:
      return lessons.reduce((sum, l) => sum + Number(l.feeLesson || 0), 0);
  }
}
```

### 4. èª²ç¨‹é¸æ“‡çµ„ä»¶

```tsx
interface CourseInvoiceSelectorProps {
  course: CourseWithLessons;
  selection: CourseSelection;
  onChange: (updates: Partial<CourseSelection>) => void;
}

export function CourseInvoiceSelector({
  course,
  selection,
  onChange,
}: CourseInvoiceSelectorProps) {
  const selectedLessons = useMemo(() => {
    if (!selection.included) return [];

    return filterLessons(course.lessons, selection.selectionMode, {
      dateStart: selection.dateStart,
      dateEnd: selection.dateEnd,
      lessonStart: selection.lessonStart,
      lessonEnd: selection.lessonEnd,
      selectedIds: selection.selectedLessonIds,
    });
  }, [selection, course.lessons]);

  const subtotal = useMemo(
    () =>
      calculateSubtotal(
        selectedLessons,
        course.chargingModel,
        course.studentPerLessonFee
      ),
    [selectedLessons, course]
  );

  // åŒæ­¥æ›´æ–°
  useEffect(() => {
    onChange({
      selectedLessons,
      subtotal,
    });
  }, [selectedLessons, subtotal]);

  return (
    <div
      className={cn(
        "rounded-xl border p-4 transition-colors",
        selection.included
          ? "border-primary-500 bg-primary-50 dark:bg-primary-900/20"
          : "border-gray-200 dark:border-gray-700"
      )}
    >
      {/* æ¨™é¡Œè¡Œ */}
      <div className="flex items-center justify-between mb-4">
        <label className="flex items-center gap-3 cursor-pointer">
          <input
            type="checkbox"
            checked={selection.included}
            onChange={(e) => onChange({ included: e.target.checked })}
            className="w-5 h-5 rounded border-gray-300"
          />
          <span className="font-medium">{course.courseName}</span>
        </label>

        <div className="text-sm text-gray-500">
          å¯é–‹ç¥¨ï¼š{course.lessons.length} å ‚
        </div>
      </div>

      {selection.included && (
        <>
          {/* é¸æ“‡æ¨¡å¼ */}
          <div className="space-y-3 mb-4">
            <label className="flex items-center gap-2">
              <input
                type="radio"
                name={`mode-${course.id}`}
                checked={selection.selectionMode === "date_range"}
                onChange={() => onChange({ selectionMode: "date_range" })}
              />
              <span className="text-sm">ä¾æ—¥æœŸç¯„åœ</span>
            </label>

            {selection.selectionMode === "date_range" && (
              <div className="flex gap-2 ml-6">
                <DatePicker
                  value={selection.dateStart}
                  onChange={(d) => onChange({ dateStart: d })}
                  placeholder="é–‹å§‹æ—¥æœŸ"
                />
                <span className="self-center">~</span>
                <DatePicker
                  value={selection.dateEnd}
                  onChange={(d) => onChange({ dateEnd: d })}
                  placeholder="çµæŸæ—¥æœŸ"
                />
              </div>
            )}

            <label className="flex items-center gap-2">
              <input
                type="radio"
                name={`mode-${course.id}`}
                checked={selection.selectionMode === "lesson_range"}
                onChange={() => onChange({ selectionMode: "lesson_range" })}
              />
              <span className="text-sm">ä¾å ‚æ•¸ç¯„åœ</span>
            </label>

            {selection.selectionMode === "lesson_range" && (
              <div className="flex items-center gap-2 ml-6">
                <span className="text-sm">ç¬¬</span>
                <Input
                  type="number"
                  value={selection.lessonStart || ""}
                  onChange={(e) =>
                    onChange({ lessonStart: Number(e.target.value) })
                  }
                  className="w-20"
                />
                <span className="text-sm">è‡³</span>
                <Input
                  type="number"
                  value={selection.lessonEnd || ""}
                  onChange={(e) =>
                    onChange({ lessonEnd: Number(e.target.value) })
                  }
                  className="w-20"
                />
                <span className="text-sm">å ‚</span>
              </div>
            )}

            <label className="flex items-center gap-2">
              <input
                type="radio"
                name={`mode-${course.id}`}
                checked={selection.selectionMode === "manual"}
                onChange={() => onChange({ selectionMode: "manual" })}
              />
              <span className="text-sm">æ‰‹å‹•é¸æ“‡èª²å ‚</span>
            </label>

            {selection.selectionMode === "manual" && (
              <div className="ml-6 max-h-48 overflow-y-auto border rounded-lg p-2">
                {course.lessons.map((lesson) => (
                  <label
                    key={lesson.id}
                    className="flex items-center gap-2 py-1 hover:bg-gray-50 dark:hover:bg-gray-800 px-2 rounded"
                  >
                    <input
                      type="checkbox"
                      checked={selection.selectedLessonIds?.includes(lesson.id)}
                      onChange={(e) => {
                        const ids = selection.selectedLessonIds || [];
                        onChange({
                          selectedLessonIds: e.target.checked
                            ? [...ids, lesson.id]
                            : ids.filter((id) => id !== lesson.id),
                        });
                      }}
                    />
                    <span className="text-sm">
                      #{lesson.lessonNumber}{" "}
                      {format(lesson.lessonDate, "MM/dd")}| {
                        lesson.studentCount
                      }äºº | ${lesson.feeLesson?.toLocaleString()}
                    </span>
                  </label>
                ))}
              </div>
            )}
          </div>

          {/* çµ±è¨ˆ */}
          <div className="pt-4 border-t border-gray-200 dark:border-gray-700">
            <div className="flex justify-between text-sm">
              <span>å·²é¸èª²å ‚ï¼š{selectedLessons.length} å ‚</span>
              <span className="font-medium">
                å°è¨ˆï¼šHK$ {subtotal.toLocaleString()}
              </span>
            </div>
          </div>
        </>
      )}
    </div>
  );
}
```

### 5. ç”Ÿæˆç™¼ç¥¨ API

```typescript
// API: POST /api/invoices
export async function POST(request: Request) {
  const session = await getServerSession();

  if (!["ADMIN", "FINANCE"].includes(session?.user?.role || "")) {
    return Response.json({ error: "Forbidden" }, { status: 403 });
  }

  const body = await request.json();
  const { schoolId, courses, recipient, paymentTermsDays, sendMethod } = body;

  try {
    const result = await prisma.$transaction(async (tx) => {
      // 1. æ”¶é›†æ‰€æœ‰é¸ä¸­çš„èª²å ‚ ID
      const allLessonIds = courses.flatMap((c: CourseSelection) =>
        c.selectedLessons.map((l: LessonForInvoice) => l.id)
      );

      // 2. è¨ˆç®—ç¸½é‡‘é¡
      const totalAmount = courses.reduce(
        (sum: number, c: CourseSelection) => sum + c.subtotal,
        0
      );

      // 3. ç”Ÿæˆç™¼ç¥¨ç·¨è™Ÿ
      const invoiceNumber = await generateInvoiceNumber(tx);

      // 4. è¨ˆç®—åˆ°æœŸæ—¥
      const dueDate = addDays(new Date(), paymentTermsDays);

      // 5. å»ºç«‹ç™¼ç¥¨
      const invoice = await tx.schoolInvoice.create({
        data: {
          schoolId,
          invoiceNumber,
          invoiceDate: new Date(),
          dueDate,
          paymentTermsDays,
          invoiceAmount: totalAmount,
          paidAmount: 0,
          status: sendMethod === "draft" ? "DRAFT" : "SENT",
          recipientNameChinese: recipient.name,
          contactPosition: recipient.position,
          contactEmail: recipient.email,
          mailingAddress: recipient.address,
          sentDate: sendMethod !== "draft" ? new Date() : null,
          createdBy: session.user.id,
        },
      });

      // 6. å»ºç«‹ç™¼ç¥¨-èª²ç¨‹é—œè¯
      await tx.schoolInvoiceCourse.createMany({
        data: courses
          .filter((c: CourseSelection) => c.included)
          .map((c: CourseSelection) => ({
            invoiceId: invoice.id,
            courseId: c.courseId,
            lessonDateStart: c.selectedLessons[0]?.lessonDate,
            lessonDateEnd:
              c.selectedLessons[c.selectedLessons.length - 1]?.lessonDate,
            lessonCount: c.selectedLessons.length,
            amount: c.subtotal,
          })),
      });

      // 7. æ›´æ–°èª²å ‚çš„é–‹ç¥¨ç‹€æ…‹
      await tx.schoolLesson.updateMany({
        where: { id: { in: allLessonIds } },
        data: { invoiceStatus: "INVOICED" },
      });

      // 8. å»ºç«‹æ”¶æ“šè¨˜éŒ„ï¼ˆå¾…ä»˜æ¬¾ï¼‰
      await tx.schoolReceipt.create({
        data: {
          schoolId,
          invoiceId: invoice.id,
          receiptNumber: `REC-${invoiceNumber.replace("INV-", "")}`,
          paymentConfirmedDate: new Date(),
          actualReceivedAmount: 0,
          paymentMethod: "FPS",
          paymentStatus: "PENDING",
        },
      });

      return invoice;
    });

    // 9. å¦‚æœé¸æ“‡ç™¼é€éƒµä»¶
    if (sendMethod === "email") {
      // ç”Ÿæˆ PDF ä¸¦ç™¼é€éƒµä»¶
      // await sendInvoiceEmail(result.id);
    }

    return Response.json(result);
  } catch (error) {
    console.error("ç”Ÿæˆç™¼ç¥¨å¤±æ•—:", error);
    return Response.json({ error: "ç”Ÿæˆç™¼ç¥¨å¤±æ•—" }, { status: 500 });
  }
}
```

---

## ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹

### é é¢ä¸»çµæ§‹

```tsx
// app/(private)/dashboard/school/invoices/generate/page.tsx
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import useSWR from "swr";
import { PageBreadCrumb } from "@/components/common/PageBreadCrumb";
import { StepIndicator } from "@/components/school-service/common/StepIndicator";
import { Step1School } from "./components/Step1School";
import { Step2Lessons } from "./components/Step2Lessons";
import { Step3Recipient } from "./components/Step3Recipient";
import { Step4Preview } from "./components/Step4Preview";

const steps = [
  { id: 1, label: "é¸æ“‡å­¸æ ¡" },
  { id: 2, label: "é¸æ“‡èª²å ‚" },
  { id: 3, label: "å¡«å¯«è³‡æ–™" },
  { id: 4, label: "é è¦½ç¢ºèª" },
];

export default function GenerateInvoicePage() {
  const router = useRouter();
  const [currentStep, setCurrentStep] = useState(1);
  const [formData, setFormData] = useState<InvoiceFormData>({
    step1: null,
    step2: null,
    step3: null,
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (sendMethod: "email" | "download" | "draft") => {
    setIsSubmitting(true);

    try {
      const response = await fetch("/api/invoices", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          schoolId: formData.step1.schoolId,
          courses: formData.step2.courses.filter((c) => c.included),
          recipient: formData.step3,
          paymentTermsDays: formData.step3.paymentTermsDays,
          sendMethod,
        }),
      });

      const result = await response.json();

      if (response.ok) {
        if (sendMethod === "download") {
          // ä¸‹è¼‰ PDF
          window.open(`/api/invoices/${result.id}/pdf`, "_blank");
        }
        router.push(`/dashboard/school/invoices/${result.id}`);
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      console.error("ç”Ÿæˆç™¼ç¥¨å¤±æ•—:", error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // è¨ˆç®—ç¸½é‡‘é¡
  const totalAmount =
    formData.step2?.courses
      .filter((c) => c.included)
      .reduce((sum, c) => sum + c.subtotal, 0) || 0;

  return (
    <div className="max-w-4xl mx-auto">
      <PageBreadCrumb
        title="ç”Ÿæˆç™¼ç¥¨"
        items={[{ label: "ç™¼ç¥¨ç®¡ç†", href: "/dashboard/school/invoices" }]}
      />

      {/* æ­¥é©Ÿé€²åº¦æ¢ */}
      <StepIndicator
        steps={steps}
        currentStep={currentStep}
        onStepClick={(step) => step < currentStep && setCurrentStep(step)}
      />

      {/* æ­¥é©Ÿå…§å®¹ */}
      <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-6">
        {currentStep === 1 && (
          <Step1School
            data={formData.step1}
            onComplete={(data) => {
              setFormData((prev) => ({ ...prev, step1: data }));
              setCurrentStep(2);
            }}
            onCancel={() => router.push("/dashboard/school/invoices")}
          />
        )}

        {currentStep === 2 && (
          <Step2Lessons
            schoolId={formData.step1.schoolId}
            data={formData.step2}
            onComplete={(data) => {
              setFormData((prev) => ({ ...prev, step2: data }));
              setCurrentStep(3);
            }}
            onBack={() => setCurrentStep(1)}
          />
        )}

        {currentStep === 3 && (
          <Step3Recipient
            schoolId={formData.step1.schoolId}
            data={formData.step3}
            onComplete={(data) => {
              setFormData((prev) => ({ ...prev, step3: data }));
              setCurrentStep(4);
            }}
            onBack={() => setCurrentStep(2)}
          />
        )}

        {currentStep === 4 && (
          <Step4Preview
            formData={formData}
            totalAmount={totalAmount}
            onSubmit={handleSubmit}
            onBack={() => setCurrentStep(3)}
            isSubmitting={isSubmitting}
          />
        )}
      </div>
    </div>
  );
}
```

---

## âœ… é©—æ”¶æ¨™æº–

- [ ] å¯é¸æ“‡å­¸æ ¡
- [ ] é¡¯ç¤ºè©²å­¸æ ¡æ‰€æœ‰å¯é–‹ç¥¨çš„èª²ç¨‹
- [ ] å¯é¸æ“‡å¤šå€‹èª²ç¨‹
- [ ] ä¸‰ç¨®èª²å ‚ç¯©é¸æ¨¡å¼æ­£ç¢ºé‹ä½œ
- [ ] é‡‘é¡è‡ªå‹•è¨ˆç®—
- [ ] æ”¶ä»¶äººè³‡æ–™å¯è‡ªå‹•å¡«å…¥ï¼ˆå¾è¯çµ¡äººï¼‰
- [ ] é è¦½é é¢é¡¯ç¤ºå®Œæ•´è³‡è¨Š
- [ ] å¯å„²å­˜ç‚ºè‰ç¨¿
- [ ] å¯ç”Ÿæˆä¸¦ä¸‹è¼‰ PDF
- [ ] èª²å ‚ç‹€æ…‹æ›´æ–°ç‚ºå·²é–‹ç¥¨
