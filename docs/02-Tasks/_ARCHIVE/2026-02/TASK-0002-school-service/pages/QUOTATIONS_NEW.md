# â• æ–°å¢å ±åƒ¹ - Quotations New

> **è·¯å¾‘**: `/dashboard/school/quotations/new`  
> **å„ªå…ˆç´š**: P0  
> **è§’è‰²**: ADMIN

---

## ğŸ“‹ é é¢æ¦‚è¿°

å¤šæ­¥é©Ÿè¡¨å–®ï¼Œç”¨æ–¼è¨˜éŒ„å­¸æ ¡æŸ¥è©¢ä¸¦å»ºç«‹å ±åƒ¹å–®ã€‚æ”¯æ´æ–°å¢å­¸æ ¡æˆ–é¸æ“‡ç¾æœ‰å­¸æ ¡ã€‚

---

## ğŸ¨ é é¢çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â• æ–°å¢å ±åƒ¹                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ­¥é©Ÿ 1        æ­¥é©Ÿ 2        æ­¥é©Ÿ 3        æ­¥é©Ÿ 4    â”‚   â”‚
â”‚  â”‚ â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹      â”‚   â”‚
â”‚  â”‚ é¸æ“‡å­¸æ ¡      æŸ¥è©¢éœ€æ±‚      å ±åƒ¹é …ç›®      é è¦½ç¢ºèª  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ­¥é©Ÿ 1ï¼šé¸æ“‡æˆ–æ–°å¢å­¸æ ¡                               â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ â—‹ é¸æ“‡ç¾æœ‰å­¸æ ¡                                       â”‚   â”‚
â”‚  â”‚   [ æœå°‹å­¸æ ¡... â–¼ ]                                 â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ â— æ–°å¢å­¸æ ¡                                          â”‚   â”‚
â”‚  â”‚   å­¸æ ¡åç¨±ï¼ˆä¸­æ–‡ï¼‰* [________________]              â”‚   â”‚
â”‚  â”‚   å­¸æ ¡åç¨±ï¼ˆè‹±æ–‡ï¼‰  [________________]              â”‚   â”‚
â”‚  â”‚   åœ°å€             [________________]              â”‚   â”‚
â”‚  â”‚   é›»è©±             [________________]              â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚   â”€â”€ è¯çµ¡äººè³‡æ–™ â”€â”€                                  â”‚   â”‚
â”‚  â”‚   å§“åï¼ˆä¸­æ–‡ï¼‰*    [________________]              â”‚   â”‚
â”‚  â”‚   è·ä½             [________________]              â”‚   â”‚
â”‚  â”‚   æ‰‹æé›»è©±         [________________]              â”‚   â”‚
â”‚  â”‚   é›»éƒµ             [________________]              â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚                              [ å–æ¶ˆ ] [ ä¸‹ä¸€æ­¥ â†’ ] â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ä½¿ç”¨çµ„ä»¶

### TailAdmin çµ„ä»¶

| çµ„ä»¶         | è·¯å¾‘                              | ç”¨é€”     |
| ------------ | --------------------------------- | -------- |
| `Input`      | `components/form/input/`          | æ–‡å­—è¼¸å…¥ |
| `Select`     | `components/form/Select.tsx`      | å­¸æ ¡é¸æ“‡ |
| `DatePicker` | `components/form/date-picker.tsx` | æ—¥æœŸé¸æ“‡ |
| `Button`     | `components/ui/button/`           | æ“ä½œæŒ‰éˆ• |
| `Modal`      | `components/ui/modal/`            | ç¢ºèªå½ˆçª— |

### éœ€é–‹ç™¼çµ„ä»¶

| çµ„ä»¶                | èªªæ˜           |
| ------------------- | -------------- |
| `StepIndicator`     | æ­¥é©Ÿé€²åº¦æ¢     |
| `SchoolSelector`    | å­¸æ ¡æœå°‹é¸æ“‡å™¨ |
| `QuotationItemForm` | å ±åƒ¹é …ç›®è¡¨å–®   |
| `QuotationPreview`  | å ±åƒ¹é è¦½å¡ç‰‡   |

---

## ğŸ“Š è¡¨å–®çµæ§‹

### æ­¥é©Ÿ 1ï¼šé¸æ“‡æˆ–æ–°å¢å­¸æ ¡

```typescript
interface Step1Data {
  mode: "existing" | "new";

  // é¸æ“‡ç¾æœ‰å­¸æ ¡
  schoolId?: string;

  // æ–°å¢å­¸æ ¡
  newSchool?: {
    schoolName: string;
    schoolNameEnglish?: string;
    schoolType: SchoolType;
    district?: string;
    address?: string;
    phone?: string;
    email?: string;
  };

  // è¯çµ¡äººï¼ˆæ–°å­¸æ ¡å¿…å¡«ï¼‰
  contact?: {
    nameChinese: string;
    nameEnglish?: string;
    position?: string;
    mobile?: string;
    email?: string;
  };
}
```

### æ­¥é©Ÿ 2ï¼šæŸ¥è©¢éœ€æ±‚

```typescript
interface Step2Data {
  inquiryDate: Date; // é è¨­ä»Šå¤©
  expectedStartDate?: Date;
  expectedStudentCount?: number;
  preferredSchedule?: string; // æ–‡å­—æè¿°
  inquiryNotes?: string;
}
```

### æ­¥é©Ÿ 3ï¼šå ±åƒ¹é …ç›®

```typescript
interface Step3Data {
  items: QuotationItemData[];
  validUntil: Date; // é è¨­ 30 å¤©å¾Œ
  notes?: string;
}

interface QuotationItemData {
  id: string; // è‡¨æ™‚ ID
  courseName: string;
  courseType: CourseType;
  description?: string;
  chargingModel: ChargingModel;
  unitPrice: number;
  quantity: number;
  totalPrice: number; // è‡ªå‹•è¨ˆç®—
  lessonsPerWeek?: number;
  lessonDuration?: number;
  expectedStudents?: number;
  requiredTutors?: number;
}
```

### æ­¥é©Ÿ 4ï¼šé è¦½ç¢ºèª

```typescript
interface Step4Data {
  // æ•´åˆå‰ä¸‰æ­¥è³‡æ–™çš„å”¯è®€é è¦½
  confirmed: boolean;
}
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å­¸æ ¡æœå°‹é¸æ“‡å™¨

```tsx
// components/school-service/school/SchoolSelector.tsx
interface SchoolSelectorProps {
  value?: string;
  onChange: (schoolId: string) => void;
  onSelect?: (school: School) => void;
}

export function SchoolSelector({
  value,
  onChange,
  onSelect,
}: SchoolSelectorProps) {
  const [search, setSearch] = useState("");
  const [isOpen, setIsOpen] = useState(false);

  const { data: schools } = useSWR(
    search.length >= 2 ? `/api/schools?search=${search}` : null,
    fetcher
  );

  return (
    <div className="relative">
      <input
        type="text"
        placeholder="è¼¸å…¥å­¸æ ¡åç¨±æœå°‹..."
        value={search}
        onChange={(e) => setSearch(e.target.value)}
        onFocus={() => setIsOpen(true)}
        className="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700"
      />

      {isOpen && schools?.length > 0 && (
        <div className="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 max-h-60 overflow-y-auto">
          {schools.map((school: School) => (
            <button
              key={school.id}
              onClick={() => {
                onChange(school.id);
                onSelect?.(school);
                setSearch(school.schoolName);
                setIsOpen(false);
              }}
              className="w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700"
            >
              <div className="font-medium">{school.schoolName}</div>
              {school.district && (
                <div className="text-sm text-gray-500">{school.district}</div>
              )}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}
```

### 2. å ±åƒ¹é …ç›®è¡¨å–®

```tsx
// components/school-service/quotation/QuotationItemForm.tsx
interface QuotationItemFormProps {
  item?: QuotationItemData;
  onSave: (item: QuotationItemData) => void;
  onCancel: () => void;
}

export function QuotationItemForm({
  item,
  onSave,
  onCancel,
}: QuotationItemFormProps) {
  const [formData, setFormData] = useState<QuotationItemData>(
    item || {
      id: crypto.randomUUID(),
      courseName: "",
      courseType: "REGULAR_CLASS",
      chargingModel: "STUDENT_PER_LESSON",
      unitPrice: 0,
      quantity: 1,
      totalPrice: 0,
    }
  );

  // è‡ªå‹•è¨ˆç®—ç¸½åƒ¹
  useEffect(() => {
    let total = formData.unitPrice * formData.quantity;

    // å¦‚æœæ˜¯å­¸ç”Ÿæ¯å ‚æ”¶è²»ï¼Œéœ€è¦ä¹˜ä»¥é è¨ˆå­¸ç”Ÿæ•¸
    if (
      formData.chargingModel === "STUDENT_PER_LESSON" &&
      formData.expectedStudents
    ) {
      total =
        formData.unitPrice * formData.expectedStudents * formData.quantity;
    }

    setFormData((prev) => ({ ...prev, totalPrice: total }));
  }, [
    formData.unitPrice,
    formData.quantity,
    formData.chargingModel,
    formData.expectedStudents,
  ]);

  return (
    <div className="space-y-4 p-4 border border-gray-200 rounded-lg dark:border-gray-700">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <Label>èª²ç¨‹åç¨± *</Label>
          <Input
            value={formData.courseName}
            onChange={(e) =>
              setFormData((prev) => ({ ...prev, courseName: e.target.value }))
            }
            placeholder="ä¾‹ï¼šå°å­¸èŠ±å¼è·³ç¹©åˆç­"
          />
        </div>

        <div>
          <Label>èª²ç¨‹é¡å‹ *</Label>
          <Select
            value={formData.courseType}
            onChange={(value) =>
              setFormData((prev) => ({ ...prev, courseType: value }))
            }
            options={courseTypeOptions}
          />
        </div>

        <div>
          <Label>æ”¶è²»æ¨¡å¼ *</Label>
          <Select
            value={formData.chargingModel}
            onChange={(value) =>
              setFormData((prev) => ({ ...prev, chargingModel: value }))
            }
            options={chargingModelOptions}
          />
        </div>

        <div>
          <Label>å–®åƒ¹ (HK$) *</Label>
          <Input
            type="number"
            value={formData.unitPrice}
            onChange={(e) =>
              setFormData((prev) => ({
                ...prev,
                unitPrice: Number(e.target.value),
              }))
            }
          />
        </div>

        <div>
          <Label>æ•¸é‡ï¼ˆå ‚æ•¸ï¼‰*</Label>
          <Input
            type="number"
            value={formData.quantity}
            onChange={(e) =>
              setFormData((prev) => ({
                ...prev,
                quantity: Number(e.target.value),
              }))
            }
          />
        </div>

        {formData.chargingModel === "STUDENT_PER_LESSON" && (
          <div>
            <Label>é è¨ˆå­¸ç”Ÿäººæ•¸</Label>
            <Input
              type="number"
              value={formData.expectedStudents || ""}
              onChange={(e) =>
                setFormData((prev) => ({
                  ...prev,
                  expectedStudents: Number(e.target.value),
                }))
              }
            />
          </div>
        )}
      </div>

      {/* èª²ç¨‹å®‰æ’å»ºè­° */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <Label>æ¯é€±å ‚æ•¸</Label>
          <Input
            type="number"
            value={formData.lessonsPerWeek || ""}
            onChange={(e) =>
              setFormData((prev) => ({
                ...prev,
                lessonsPerWeek: Number(e.target.value),
              }))
            }
          />
        </div>

        <div>
          <Label>æ¯å ‚æ™‚é•·ï¼ˆåˆ†é˜ï¼‰</Label>
          <Input
            type="number"
            value={formData.lessonDuration || ""}
            onChange={(e) =>
              setFormData((prev) => ({
                ...prev,
                lessonDuration: Number(e.target.value),
              }))
            }
          />
        </div>

        <div>
          <Label>æ‰€éœ€å°å¸«</Label>
          <Input
            type="number"
            value={formData.requiredTutors || ""}
            onChange={(e) =>
              setFormData((prev) => ({
                ...prev,
                requiredTutors: Number(e.target.value),
              }))
            }
          />
        </div>
      </div>

      {/* å°è¨ˆ */}
      <div className="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
        <span className="text-lg font-medium">
          å°è¨ˆï¼šHK$ {formData.totalPrice.toLocaleString()}
        </span>

        <div className="flex gap-2">
          <Button variant="outline" onClick={onCancel}>
            å–æ¶ˆ
          </Button>
          <Button variant="primary" onClick={() => onSave(formData)}>
            {item ? "æ›´æ–°" : "æ–°å¢"}
          </Button>
        </div>
      </div>
    </div>
  );
}
```

### 3. æ­¥é©Ÿé€²åº¦æ¢

```tsx
// components/school-service/common/StepIndicator.tsx
interface StepIndicatorProps {
  steps: { id: number; label: string }[];
  currentStep: number;
  onStepClick?: (step: number) => void;
}

export function StepIndicator({
  steps,
  currentStep,
  onStepClick,
}: StepIndicatorProps) {
  return (
    <div className="flex items-center justify-between mb-8">
      {steps.map((step, index) => (
        <React.Fragment key={step.id}>
          {/* æ­¥é©Ÿåœ“é» */}
          <button
            onClick={() => onStepClick?.(step.id)}
            disabled={step.id > currentStep}
            className={cn(
              "flex flex-col items-center",
              step.id <= currentStep ? "cursor-pointer" : "cursor-not-allowed"
            )}
          >
            <div
              className={cn(
                "w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium transition-colors",
                step.id < currentStep && "bg-green-500 text-white",
                step.id === currentStep && "bg-primary-500 text-white",
                step.id > currentStep &&
                  "bg-gray-200 text-gray-500 dark:bg-gray-700"
              )}
            >
              {step.id < currentStep ? (
                <CheckIcon className="h-5 w-5" />
              ) : (
                step.id
              )}
            </div>
            <span
              className={cn(
                "mt-2 text-sm",
                step.id === currentStep
                  ? "text-primary-600 font-medium"
                  : "text-gray-500"
              )}
            >
              {step.label}
            </span>
          </button>

          {/* é€£æ¥ç·š */}
          {index < steps.length - 1 && (
            <div
              className={cn(
                "flex-1 h-0.5 mx-4",
                step.id < currentStep
                  ? "bg-green-500"
                  : "bg-gray-200 dark:bg-gray-700"
              )}
            />
          )}
        </React.Fragment>
      ))}
    </div>
  );
}
```

---

## ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹

### é é¢ä¸»çµæ§‹

```tsx
// app/(private)/dashboard/school/quotations/new/page.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { PageBreadCrumb } from "@/components/common/PageBreadCrumb";
import { StepIndicator } from "@/components/school-service/common/StepIndicator";
import { Step1School } from "./components/Step1School";
import { Step2Inquiry } from "./components/Step2Inquiry";
import { Step3Items } from "./components/Step3Items";
import { Step4Preview } from "./components/Step4Preview";

const steps = [
  { id: 1, label: "é¸æ“‡å­¸æ ¡" },
  { id: 2, label: "æŸ¥è©¢éœ€æ±‚" },
  { id: 3, label: "å ±åƒ¹é …ç›®" },
  { id: 4, label: "é è¦½ç¢ºèª" },
];

export default function NewQuotationPage() {
  const router = useRouter();
  const [currentStep, setCurrentStep] = useState(1);
  const [formData, setFormData] = useState<QuotationFormData>({
    step1: null,
    step2: null,
    step3: null,
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleStep1Complete = (data: Step1Data) => {
    setFormData((prev) => ({ ...prev, step1: data }));
    setCurrentStep(2);
  };

  const handleStep2Complete = (data: Step2Data) => {
    setFormData((prev) => ({ ...prev, step2: data }));
    setCurrentStep(3);
  };

  const handleStep3Complete = (data: Step3Data) => {
    setFormData((prev) => ({ ...prev, step3: data }));
    setCurrentStep(4);
  };

  const handleSubmit = async (asDraft: boolean) => {
    setIsSubmitting(true);

    try {
      const response = await fetch("/api/quotations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...formData,
          status: asDraft ? "DRAFT" : "SENT",
        }),
      });

      const result = await response.json();

      if (response.ok) {
        router.push(`/dashboard/school/quotations/${result.id}`);
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      console.error("å»ºç«‹å ±åƒ¹å¤±æ•—:", error);
      // é¡¯ç¤ºéŒ¯èª¤é€šçŸ¥
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto">
      <PageBreadCrumb
        title="æ–°å¢å ±åƒ¹"
        items={[{ label: "å ±åƒ¹ç®¡ç†", href: "/dashboard/school/quotations" }]}
      />

      {/* æ­¥é©Ÿé€²åº¦æ¢ */}
      <StepIndicator
        steps={steps}
        currentStep={currentStep}
        onStepClick={(step) => step < currentStep && setCurrentStep(step)}
      />

      {/* æ­¥é©Ÿå…§å®¹ */}
      <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-6">
        {currentStep === 1 && (
          <Step1School
            data={formData.step1}
            onComplete={handleStep1Complete}
            onCancel={() => router.push("/dashboard/school/quotations")}
          />
        )}

        {currentStep === 2 && (
          <Step2Inquiry
            data={formData.step2}
            onComplete={handleStep2Complete}
            onBack={() => setCurrentStep(1)}
          />
        )}

        {currentStep === 3 && (
          <Step3Items
            data={formData.step3}
            onComplete={handleStep3Complete}
            onBack={() => setCurrentStep(2)}
          />
        )}

        {currentStep === 4 && (
          <Step4Preview
            formData={formData}
            onSubmit={handleSubmit}
            onBack={() => setCurrentStep(3)}
            isSubmitting={isSubmitting}
          />
        )}
      </div>
    </div>
  );
}
```

### API æäº¤

```typescript
// app/api/quotations/route.ts
export async function POST(request: Request) {
  const session = await getServerSession();

  if (!session?.user || session.user.role !== "ADMIN") {
    return Response.json({ error: "Forbidden" }, { status: 403 });
  }

  const body = await request.json();
  const { step1, step2, step3, status } = body;

  try {
    const result = await prisma.$transaction(async (tx) => {
      // 1. è™•ç†å­¸æ ¡
      let schoolId: string;

      if (step1.mode === "existing") {
        schoolId = step1.schoolId;
      } else {
        // å»ºç«‹æ–°å­¸æ ¡
        const newSchool = await tx.school.create({
          data: {
            ...step1.newSchool,
            partnershipStatus: "INQUIRY",
          },
        });
        schoolId = newSchool.id;

        // å»ºç«‹è¯çµ¡äºº
        if (step1.contact) {
          await tx.schoolContact.create({
            data: {
              schoolId,
              ...step1.contact,
              isPrimary: true,
            },
          });
        }
      }

      // 2. ç”Ÿæˆå ±åƒ¹ç·¨è™Ÿ
      const quotationNumber = await generateQuotationNumber(tx);

      // 3. è¨ˆç®—ç¸½é‡‘é¡
      const totalAmount = step3.items.reduce(
        (sum: number, item: QuotationItemData) => sum + item.totalPrice,
        0
      );

      // 4. å»ºç«‹å ±åƒ¹å–®
      const quotation = await tx.schoolQuotation.create({
        data: {
          schoolId,
          quotationNumber,
          quotationDate: new Date(),
          status,
          totalAmount,
          validUntil: step3.validUntil,
          inquiryDate: step2.inquiryDate,
          inquiryNotes: step2.inquiryNotes,
          expectedStartDate: step2.expectedStartDate,
          expectedStudentCount: step2.expectedStudentCount,
          preferredSchedule: step2.preferredSchedule,
          sentDate: status === "SENT" ? new Date() : null,
          createdBy: session.user.id,
        },
      });

      // 5. å»ºç«‹å ±åƒ¹é …ç›®
      await tx.schoolQuotationItem.createMany({
        data: step3.items.map((item: QuotationItemData, index: number) => ({
          quotationId: quotation.id,
          courseName: item.courseName,
          courseType: item.courseType,
          description: item.description,
          chargingModel: item.chargingModel,
          unitPrice: item.unitPrice,
          quantity: item.quantity,
          totalPrice: item.totalPrice,
          lessonsPerWeek: item.lessonsPerWeek,
          lessonDuration: item.lessonDuration,
          expectedStudents: item.expectedStudents,
          requiredTutors: item.requiredTutors,
          sortOrder: index,
        })),
      });

      // 6. å¦‚æœç™¼é€ï¼Œæ›´æ–°å­¸æ ¡ç‹€æ…‹
      if (status === "SENT") {
        await tx.school.update({
          where: { id: schoolId },
          data: { partnershipStatus: "QUOTATION_SENT" },
        });
      }

      return quotation;
    });

    return Response.json(result);
  } catch (error) {
    console.error("å»ºç«‹å ±åƒ¹å¤±æ•—:", error);
    return Response.json({ error: "å»ºç«‹å ±åƒ¹å¤±æ•—" }, { status: 500 });
  }
}
```

---

## âœ… é©—æ”¶æ¨™æº–

- [ ] å¯é¸æ“‡ç¾æœ‰å­¸æ ¡æˆ–æ–°å¢å­¸æ ¡
- [ ] æ–°å­¸æ ¡å¿…é ˆå¡«å¯«è¯çµ¡äººè³‡æ–™
- [ ] å¯æ–°å¢å¤šå€‹å ±åƒ¹é …ç›®
- [ ] é‡‘é¡è‡ªå‹•è¨ˆç®—æ­£ç¢º
- [ ] æ­¥é©Ÿå¯å‰å¾Œåˆ‡æ›
- [ ] é è¦½é é¢é¡¯ç¤ºå®Œæ•´è³‡æ–™
- [ ] å¯å„²å­˜ç‚ºè‰ç¨¿
- [ ] å¯å»ºç«‹ä¸¦ç™¼é€
- [ ] å ±åƒ¹ç·¨è™Ÿè‡ªå‹•ç”Ÿæˆ
