# 🔄 業務流程文檔

> 本文檔詳細描述學校服務系統的 7 個業務階段

---

## 📊 流程總覽

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  階段 1     │ →  │  階段 2     │ →  │  階段 3     │
│  查詢接洽   │    │  報價提案   │    │  確認合作   │
└─────────────┘    └─────────────┘    └─────────────┘
                                            │
┌─────────────┐    ┌─────────────┐    ┌─────┴───────┐
│  階段 6     │ ←  │  階段 5     │ ←  │  階段 4     │
│  開立發票   │    │  執行課堂   │    │  建立課程   │
└─────────────┘    └─────────────┘    └─────────────┘
       │
       ▼
┌─────────────┐
│  階段 7     │
│  收款記錄   │
└─────────────┘
```

---

## 階段 1：查詢接洽 📞

### 業務情境

學校致電查詢：「我們想開跳繩班，每週一堂，預計 20 個學生...」

### 操作頁面

`/dashboard/school/quotations/new`

### 操作流程

```
步驟 1：選擇或新增學校
├─ 選項 A：從現有學校選擇（下拉搜尋）
└─ 選項 B：新增學校資料
   ├─ 學校名稱（中/英）
   ├─ 地址、電話、電郵
   └─ 聯絡人資料
      ├─ 姓名（中/英）
      ├─ 職位
      ├─ 手提電話
      └─ 電郵

步驟 2：記錄查詢需求
├─ 查詢日期（自動填入今天）
├─ 希望開始日期
├─ 預計學生人數
├─ 希望上課時間（文字描述：「每週一 14:00-15:30」）
└─ 查詢內容備註

步驟 3：儲存為草稿
└─ 自動建立相關記錄
```

### 資料變化

| 資料表              | 操作   | 欄位             |
| ------------------- | ------ | ---------------- |
| `schools`           | INSERT | 若新學校         |
| `school_contacts`   | INSERT | 若新聯絡人       |
| `school_quotations` | INSERT | `status = DRAFT` |

### SQL 範例

```sql
-- 新增學校
INSERT INTO schools (school_name, address, partnership_status)
VALUES ('XX小學', '九龍XX區', 'INQUIRY');

-- 新增聯絡人
INSERT INTO school_contacts (school_id, name_chinese, position, phone)
VALUES ('[school_id]', '王老師', '體育科主任', '9123 4567');

-- 新增報價單（草稿）
INSERT INTO school_quotations (school_id, quotation_number, status, inquiry_date)
VALUES ('[school_id]', 'Q2026-001', 'DRAFT', '2026-01-30');
```

---

## 階段 2：報價提案 💼

### 業務情境

根據查詢需求，準備報價單並發送給學校

### 操作頁面

`/dashboard/school/quotations/[id]`

### 操作流程

```
步驟 1：編輯報價項目
├─ 點擊「新增報價項目」
├─ 填寫課程資料
│  ├─ 課程名稱：「跳繩恆常班（上學期）」
│  ├─ 課程類型：REGULAR_CLASS
│  ├─ 收費模式：STUDENT_PER_LESSON
│  ├─ 單價：$50 / 人 / 堂
│  ├─ 數量：12 堂
│  └─ 小計：$50 x 20人 x 12堂 = $12,000
└─ 可新增多個項目

步驟 2：填寫報價資料
├─ 報價有效期至：2026-02-28
├─ 報價總金額：自動計算
└─ 備註

步驟 3：發送報價
├─ 點擊「發送報價」
├─ 選擇發送方式（email / WhatsApp / 下載 PDF）
└─ 狀態自動更新為 SENT
```

### 資料變化

| 資料表                   | 操作   | 欄位                                  |
| ------------------------ | ------ | ------------------------------------- |
| `school_quotation_items` | INSERT | 報價項目                              |
| `school_quotations`      | UPDATE | `status = SENT`, `sent_date = NOW()`  |
| `schools`                | UPDATE | `partnership_status = QUOTATION_SENT` |

---

## 階段 3：確認合作 ✅

### 業務情境

學校回覆接受/拒絕報價，或直接口頭確認合作（跳過報價階段）

### 操作頁面

- **有報價流程**：`/dashboard/school/quotations/[id]`
- **無報價流程**：`/dashboard/school/courses/new`

### 操作流程

```
情境 A：學校接受報價（標準流程）
├─ 點擊「標記為已接受」
├─ 填寫回應資料
│  ├─ 回應日期
│  └─ 確認渠道（電話/電郵/會議）
├─ 更新學校合作資料
│  ├─ 合作開始日期
│  └─ 合作學年：2024-2025
└─ 引導至「轉換為課程」頁面

情境 B：學校拒絕報價
├─ 點擊「標記為已拒絕」
├─ 填寫拒絕原因
└─ 保留記錄（不刪除）

情境 C：跳過報價階段（口頭確認）⭐ 新增
├─ 業務場景：
│  └─ 學校電話/會議中口頭確認合作細節
│     無需正式書面報價
├─ 操作路徑：
│  └─ 直接前往「新增課程」頁面
├─ 填寫資料：
│  ├─ 選擇學校（若無則新增）
│  ├─ 更新學校合作資料
│  │  ├─ 合作狀態：CONFIRMED
│  │  ├─ 合作開始日期
│  │  └─ 合作學年
│  └─ 填寫課程詳情（同階段 4）
└─ 備註欄位標記：「口頭確認，無書面報價」
```

### 資料變化

**情境 A（有報價）**

| 資料表              | 操作   | 欄位                                                       |
| ------------------- | ------ | ---------------------------------------------------------- |
| `school_quotations` | UPDATE | `status = ACCEPTED`, `responded_date`                      |
| `schools`           | UPDATE | `partnership_status = CONFIRMED`, `partnership_start_date` |

**情境 C（無報價）⭐ 新增**

| 資料表           | 操作   | 欄位                                                       |
| ---------------- | ------ | ---------------------------------------------------------- |
| `schools`        | UPDATE | `partnership_status = CONFIRMED`, `partnership_start_date` |
| `school_courses` | INSERT | 直接建立課程，`quotation_id = NULL`                        |

---

## 階段 4：建立課程 📚

### 業務情境

報價接受後轉換為課程，或直接建立課程（無報價）

### 操作頁面

- **有報價流程**：`/dashboard/school/quotations/[id]/convert`
- **無報價流程**：`/dashboard/school/courses/new`

### 操作流程

**路徑 A：從報價轉換（標準流程）**

```
步驟 1：顯示報價項目（唯讀參考）
┌────────────────────────────────────┐
│ 原報價項目：跳繩恆常班（上學期）   │
│ 預計學生：20 人                    │
│ 每週堂數：1 堂                     │
└────────────────────────────────────┘

步驟 2：填寫實際課程資料（可修改）
├─ 課程名稱 ✏️ 可編輯
├─ 課程類型
├─ 學期設定
│  ├─ 學年：2024-2025
│  ├─ 學期：FIRST_TERM
│  ├─ 開始日期：2024-09-09
│  └─ 結束日期：2025-01-17
├─ 人數設定
│  ├─ 所需導師：2 人
│  └─ 最大學生：25 人
└─ 收費設定
   ├─ 收費模式
   ├─ 學生每堂收費：$50
   └─ 導師每堂薪資：$300

步驟 3：確認建立
└─ 跳轉到 courses/[id]
```

**路徑 B：直接建立課程（無報價）⭐ 新增**

```
步驟 1：選擇學校
├─ 下拉選擇現有學校
└─ 或新增學校（同階段 1）

步驟 2：更新學校合作狀態（若尚未更新）
├─ 合作狀態：CONFIRMED
├─ 合作開始日期
└─ 合作學年

步驟 3：填寫課程資料
├─ 課程名稱
├─ 課程類型
├─ 學期設定（同上）
├─ 人數設定（同上）
├─ 收費設定（同上）
└─ 備註：「口頭確認，無書面報價」

步驟 4：確認建立
└─ 跳轉到 courses/[id]
```

### 資料變化

**路徑 A（有報價）**

| 資料表              | 操作   | 欄位                                |
| ------------------- | ------ | ----------------------------------- |
| `school_courses`    | INSERT | 從報價項目複製，`quotation_id` 有值 |
| `school_quotations` | UPDATE | 標記已轉換（可選）                  |

**路徑 B（無報價）⭐ 新增**

| 資料表           | 操作   | 欄位                            |
| ---------------- | ------ | ------------------------------- |
| `schools`        | UPDATE | 更新合作狀態（若需要）          |
| `school_courses` | INSERT | 直接建立，`quotation_id = NULL` |

---

## 階段 5：執行課堂 🗓️

### 5A：排定課堂

#### 操作頁面

`/dashboard/school/courses/[id]`

#### 操作流程

```
功能 A：批次生成課堂
├─ 點擊「批次生成課堂」
├─ 設定規則
│  ├─ 星期：每週一
│  ├─ 時間：14:00 - 15:30
│  ├─ 日期範圍：2024-09-09 ~ 2025-01-17
│  └─ 排除日期：公眾假期
├─ 預覽生成結果（共 16 堂）
└─ 確認生成

功能 B：手動新增單堂
├─ 選擇日期
├─ 選擇時間
├─ 課堂類型（補堂/加操）
└─ 備註
```

#### 資料變化

| 資料表           | 操作   | 說明         |
| ---------------- | ------ | ------------ |
| `school_lessons` | INSERT | 批次插入多筆 |

### 5B：分配導師

#### 操作頁面

`/dashboard/school/schedule`

#### 操作流程

```
視圖：週視圖看板

左側：未排班課堂列表
┌────────────────────────┐
│ 🔴 待分配課堂 (5)      │
├────────────────────────┤
│ 09/09 14:00 XX小學     │
│ 09/16 14:00 XX小學     │
└────────────────────────┘

右側：導師排班表
┌─────────┬──────────┬──────────┐
│ 導師    │ 週一     │ 週二     │
├─────────┼──────────┼──────────┤
│ 張教練  │ [拖拉]   │ 15:00    │
└─────────┴──────────┴──────────┘

操作：
├─ 拖拉課堂到空檔
├─ 自動檢查時間衝突
└─ 成功分配 → 建立 TutorLesson
```

#### 資料變化

| 資料表                 | 操作   | 說明             |
| ---------------------- | ------ | ---------------- |
| `school_tutor_lessons` | INSERT | 建立導師任教記錄 |

### 5C：導師簽到與完成課堂

#### 操作頁面

`/dashboard/school/my-lessons`

#### 操作流程

```
導師視圖：
┌────────────────────────────────┐
│ 14:00 - 15:30  XX小學          │
│ 學生：20 人 | 主教             │
│ [簽到] [查看詳情]              │
└────────────────────────────────┘

簽到流程：
├─ 點擊「簽到」
├─ 拍攝現場相片
├─ 自動記錄地理位置
├─ 自動記錄簽到時間
└─ 狀態 → CHECKED_IN

簽退流程：
├─ 點擊「簽退」
├─ 自動計算工作時長
├─ 填寫實際學生人數
└─ 狀態 → COMPLETED
```

#### 資料變化

| 資料表                 | 操作   | 欄位                                                       |
| ---------------------- | ------ | ---------------------------------------------------------- |
| `school_tutor_lessons` | UPDATE | `attendance_status`, `check_in_time`, `check_out_time`     |
| `school_lessons`       | UPDATE | `lesson_status = COMPLETED`, `student_count`, `fee_lesson` |

---

## 階段 6：開立發票 💰

### 業務情境

每月底或每 N 堂課後，彙總已完成課堂開立發票

### 操作頁面

`/dashboard/school/invoices/generate`

### 操作流程

```
步驟 1：選擇學校
└─ 下拉選擇

步驟 2：選擇課程（可多選）
├─ ☑ 跳繩恆常班（上學期）
└─ ☐ 跳繩進階班

步驟 3：選擇課堂範圍
├─ 選項 A：依日期範圍
├─ 選項 B：依課堂數量
└─ 選項 C：手動勾選課堂
   ├─ ☑ 09/09 | 20人 | $1,000
   ├─ ☑ 09/16 | 20人 | $1,000
   └─ ☑ 09/23 | 18人 | $900

步驟 4：預覽發票
┌────────────────────────────────┐
│ 課程：跳繩恆常班（上學期）     │
│ 課堂數：4 堂                   │
│ 金額：$3,900                   │
├────────────────────────────────┤
│ 總計：$3,900                   │
└────────────────────────────────┘

步驟 5：填寫收件人資料
├─ 選擇聯絡人（自動填入）
└─ 付款條款：30 天

步驟 6：生成發票
├─ 自動生成發票編號
└─ 狀態：DRAFT
```

### 資料變化

| 資料表                   | 操作   | 欄位                        |
| ------------------------ | ------ | --------------------------- |
| `school_invoices`        | INSERT | 發票資料                    |
| `school_invoice_courses` | INSERT | 發票-課程關聯               |
| `school_lessons`         | UPDATE | `invoice_status = INVOICED` |

---

## 階段 7：收款記錄 💳

### 業務情境

學校付款後，記錄收款並生成收據

### 操作頁面

`/dashboard/school/invoices/[id]/payment`

### 操作流程

```
發票詳情頁：
┌────────────────────────────────┐
│ INV-2024-09-001                │
│ 狀態：已發送                   │
│ 金額：$3,900                   │
│ 到期日：2024-10-30             │
│ [記錄收款]                     │
└────────────────────────────────┘

記錄收款：
├─ 付款確認日期：2024-10-15
├─ 實際收款金額：$3,900
├─ 付款方式：FPS
├─ 交易編號：FPS202410151430
└─ 備註

結果：
├─ 收據編號：REC-2024-09-001
├─ 付款狀態：PAID
└─ 發票狀態：PAID
```

### 資料變化

| 資料表            | 操作   | 欄位                    |
| ----------------- | ------ | ----------------------- |
| `school_receipts` | INSERT | 收據資料                |
| `school_invoices` | UPDATE | `status = PAID`         |
| `school_lessons`  | UPDATE | `payment_status = PAID` |

---

## 📊 狀態流轉圖

### 報價狀態

```
      ┌─────────┐
      │  DRAFT  │
      └────┬────┘
           │ 發送
           ▼
      ┌─────────┐
      │  SENT   │
      └────┬────┘
           │
     ┌─────┼─────┐
     │     │     │
     ▼     ▼     ▼
┌────────┐│┌────────┐
│ACCEPTED│││REJECTED│
└────────┘│└────────┘
          ▼
     ┌─────────┐
     │ EXPIRED │ (自動：超過有效期)
     └─────────┘
```

### 課堂狀態

```
┌───────────┐
│ SCHEDULED │ ← 建立時
└─────┬─────┘
      │
  ┌───┴───┐
  │       │
  ▼       ▼
┌─────────┐ ┌─────────┐
│COMPLETED│ │CANCELLED│
└─────────┘ └─────────┘
```

### 發票狀態

```
┌───────┐
│ DRAFT │
└───┬───┘
    │ 發送
    ▼
┌───────┐
│ SENT  │
└───┬───┘
    │
┌───┴───┬─────────┐
│       │         │
▼       ▼         ▼
┌────┐ ┌───────┐ ┌─────────┐
│PAID│ │PARTIAL│ │ OVERDUE │ (自動：超過到期日)
└────┘ └───────┘ └─────────┘
```

### 導師簽到狀態

```
┌───────────┐
│ SCHEDULED │
└─────┬─────┘
      │ 簽到
      ▼
┌───────────┐
│ CHECKED_IN│
└─────┬─────┘
      │ 簽退
      ▼
┌───────────┐
│ COMPLETED │
└───────────┘

例外狀態：
- ABSENT：未到場
- LATE：超時簽到（可標記）
```

---

## ⚠️ 業務規則

### 報價規則

1. 報價單必須有至少一個報價項目才能發送
2. 已發送的報價單不能刪除報價項目
3. 報價有效期預設 30 天
4. 已接受的報價才能轉換為課程
5. **報價非必要流程** - 可直接建立課程（`quotation_id = NULL`）⭐ 新增

### 課程規則

1. 課程必須關聯學校
2. 收費模式決定收費計算方式
3. 課程開始後不能更改收費模式
4. **課程可無報價來源** - `quotation_id` 可為 NULL（口頭確認情境）⭐ 新增
5. 無報價來源的課程需在備註說明確認方式

### 課堂規則

1. 課堂必須關聯課程
2. 已完成的課堂才能開票
3. 已開票的課堂不能刪除
4. 補堂需標記類型為 MAKEUP

### 發票規則

1. 只能對已完成且未開票的課堂開票
2. 發票金額自動計算
3. 已付款的發票不能取消
4. 部分付款需記錄多筆收款

### 導師規則

1. 同一時段不能分配給同一導師兩堂課（時間衝突檢查）
2. 簽到必須在課堂當天
3. 簽退後自動計算工作時長
