# 資料庫操作與 Prisma 配置

## Prisma 配置

### 1. Schema 結構

```
prisma/
├── schema.prisma          # 主 schema 文件
├── schema/
│   ├── school.prisma     # 學校服務 schema
│   └── user.prisma       # 使用者 schema
├── migrations/           # 資料庫遷移記錄
└── prisma.config.ts      # Prisma 7.x 配置
```

### 2. 主 Schema 文件

`@/prisma/schema.prisma`

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}
```

**注意：** Prisma 7.x 不再在 schema 中定義 `url`，改用 `prisma.config.ts`。

### 3. Prisma 配置文件

`@/prisma.config.ts`

```typescript
import "dotenv/config";
import { defineConfig } from "prisma/config";

export default defineConfig({
  schema: "prisma",
  migrations: {
    path: "prisma/migrations",
  },
  datasource: {
    url: process.env["DATABASE_URL"],
  },
});
```

### 4. Prisma Client 配置

`@/lib/prisma.ts`

```typescript
import { PrismaClient } from "@prisma/client";
import { neonConfig } from "@neondatabase/serverless";
import { PrismaNeon } from "@prisma/adapter-neon";
import ws from "ws";

// 配置 WebSocket
neonConfig.webSocketConstructor = ws;

// 檢查環境變量
const connectionString = process.env.DATABASE_URL;

if (!connectionString) {
  throw new Error("DATABASE_URL environment variable is not set");
}

// 初始化 Neon Adapter
const adapter = new PrismaNeon({ connectionString });

// 全域 Prisma Client
const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    adapter,
    log:
      process.env.NODE_ENV === "development"
        ? ["query", "error", "warn"]
        : ["error"],
  });

// 開發環境下避免熱重載時重複建立 client
if (process.env.NODE_ENV !== "production") {
  globalForPrisma.prisma = prisma;
}
```

**關鍵配置：**

- 使用 Neon Serverless Driver
- WebSocket 支援（需要 `ws` 和 `bufferutil`）
- 開發環境啟用查詢日誌
- 全域單例模式

## 資料庫 Schema

### School Model

```prisma
model School {
  id String @id @default(cuid())

  // 基本資料
  schoolName   String
  schoolNameEn String?
  schoolCode   String? @unique
  address      String
  phone        String?
  fax          String?
  email        String?
  website      String?

  // 合作狀態
  partnershipStatus    PartnershipStatus @default(INQUIRY)
  partnershipStartDate DateTime?
  partnershipEndDate   DateTime?
  partnershipStartYear String?
  partnershipEndYear   String?

  // 確認渠道
  confirmationChannel String?

  // 備註
  remarks String? @db.Text

  // 關聯
  contacts   SchoolContact[]
  quotations SchoolQuotation[]
  courses    SchoolCourse[]
  invoices   SchoolInvoice[]
  receipts   SchoolReceipt[]

  // 系統欄位
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([partnershipStatus])
  @@index([schoolName])
  @@map("schools")
}
```

### SchoolContact Model

```prisma
model SchoolContact {
  id String @id @default(cuid())

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // 聯絡人資料
  salutation  String?
  nameChinese String
  nameEnglish String?
  position    String?
  department  String?

  // 聯絡方式
  phone  String?
  mobile String?
  email  String?

  // 主要聯絡人標記
  isPrimary Boolean @default(false)

  // 備註
  remarks String? @db.Text

  // 系統欄位
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([schoolId, email])
  @@index([schoolId])
  @@index([isPrimary])
  @@map("school_contacts")
}
```

### SchoolCourse Model

```prisma
model SchoolCourse {
  id String @id @default(cuid())

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // 課程基本資料
  courseName  String
  courseCode  String?
  courseType  String
  description String? @db.Text

  // 學期設定
  courseTerm   CourseTerm @default(FULL_YEAR)
  academicYear String
  startDate    DateTime?
  endDate      DateTime?

  // 人數設定
  requiredTutors Int  @default(1)
  maxStudents    Int?

  // 收費模式（多選）
  chargingModels ChargingModel[] @default([])

  // 學生收費
  studentPerLessonFee  Decimal? @db.Decimal(10, 2)
  studentHourlyFee     Decimal? @db.Decimal(10, 2)
  studentFullCourseFee Decimal? @db.Decimal(10, 2)
  teamActivityFee      Decimal? @db.Decimal(10, 2)

  // 導師薪資
  tutorPerLessonFee Decimal? @db.Decimal(10, 2)
  tutorHourlyFee    Decimal? @db.Decimal(10, 2)

  // 付款模式
  paymentMode String?

  // 課程狀態
  status CourseStatus @default(DRAFT)

  // 備註
  remarks String? @db.Text

  // 關聯
  lessons        SchoolLesson[]
  invoiceCourses SchoolInvoiceCourse[]

  // 系統欄位
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([schoolId])
  @@index([academicYear])
  @@index([courseType])
  @@index([status])
  @@map("school_courses")
}
```

### Enums

```prisma
enum PartnershipStatus {
  INQUIRY         // 查詢中
  QUOTATION_SENT  // 已發送報價
  NEGOTIATING     // 洽談中
  CONFIRMED       // 已確認合作
  ACTIVE          // 合作中
  SUSPENDED       // 暫停合作
  TERMINATED      // 已終止
}

enum CourseTerm {
  FULL_YEAR    // 全期不分學期
  FIRST_TERM   // 上學期
  SECOND_TERM  // 下學期
  SUMMER       // 暑期
}

enum ChargingModel {
  STUDENT_PER_LESSON   // 學生每節課堂收費
  TUTOR_PER_LESSON     // 導師每堂節數收費
  STUDENT_HOURLY       // 學生課堂時數收費
  TUTOR_HOURLY         // 導師時薪節數收費
  STUDENT_FULL_COURSE  // 學生全期課程收費
  TEAM_ACTIVITY        // 帶隊活動收費
}

enum CourseStatus {
  DRAFT      // 草稿
  SCHEDULED  // 已排程
  ACTIVE     // 進行中
  COMPLETED  // 已完成
  CANCELLED  // 已取消
  SUSPENDED  // 已暫停
}
```

## Prisma 操作詳解

### 1. Transaction 操作

```typescript
const result = await prisma.$transaction(async (tx) => {
  // 所有操作使用 tx 而非 prisma
  const school = await tx.school.create({ ... });
  const contact = await tx.schoolContact.create({ ... });
  const course = await tx.schoolCourse.create({ ... });

  return { school, contact, course };
});
```

**特性：**

- 原子性：全部成功或全部失敗
- 隔離性：避免並發衝突
- 自動回滾：錯誤時自動還原

**最佳實踐：**

```typescript
// ✅ 使用 tx 執行所有操作
await tx.school.create({ ... });

// ❌ 不要在 transaction 內使用 prisma
await prisma.school.create({ ... }); // 錯誤！
```

### 2. Create 操作

```typescript
const school = await tx.school.create({
  data: {
    schoolName: "測試小學",
    address: "九龍測試道123號",
    partnershipStatus: "CONFIRMED",
    partnershipStartDate: new Date("2026-01-01"),
  },
});
```

**返回值：**

```typescript
{
  id: "cml13k3vs000041caeff9vomt",
  schoolName: "測試小學",
  address: "九龍測試道123號",
  // ... 其他欄位
  createdAt: Date,
  updatedAt: Date,
}
```

### 3. Update 操作

```typescript
await tx.school.update({
  where: { id: schoolId },
  data: {
    schoolName: "更新後的學校名稱",
    address: "新地址",
  },
});
```

**注意事項：**

- `where` 必須指定唯一欄位（id、unique 欄位）
- `data` 只包含要更新的欄位
- `updatedAt` 自動更新

### 4. FindFirst 操作

```typescript
const existingContact = await tx.schoolContact.findFirst({
  where: {
    schoolId: schoolId,
    email: contact.email,
  },
});
```

**用途：**

- 檢查記錄是否存在
- 根據多個條件查詢
- 返回第一筆符合的記錄

**與 findUnique 的差異：**

```typescript
// findUnique - 只能用於唯一欄位
await prisma.school.findUnique({
  where: { id: schoolId },
});

// findFirst - 可用於任何條件組合
await prisma.schoolContact.findFirst({
  where: {
    schoolId: schoolId,
    email: "test@example.com",
  },
});
```

### 5. 關聯查詢

```typescript
const school = await prisma.school.findUnique({
  where: { id: schoolId },
  include: {
    contacts: true,
    courses: {
      where: { status: "ACTIVE" },
      orderBy: { createdAt: "desc" },
    },
  },
});
```

**返回結構：**

```typescript
{
  id: "...",
  schoolName: "...",
  contacts: [
    { id: "...", nameChinese: "...", ... }
  ],
  courses: [
    { id: "...", courseName: "...", ... }
  ]
}
```

## 資料類型處理

### 1. DateTime 處理

```typescript
// 前端 → 後端
const date = new Date("2026-01-01");

// 後端 → 資料庫
partnershipStartDate: new Date(school.partnershipStartDate);

// 資料庫 → 前端
const dateString = school.partnershipStartDate.toISOString();
// "2026-01-01T00:00:00.000Z"
```

**可選日期處理：**

```typescript
partnershipEndDate: school.partnershipEndDate
  ? new Date(school.partnershipEndDate)
  : null;
```

### 2. Decimal 處理

```typescript
// Prisma 返回 Decimal 物件
studentPerLessonFee: Decimal { value: "50.00" }

// 轉換為數字
const fee = Number(course.studentPerLessonFee);

// 或使用 toNumber()
const fee = course.studentPerLessonFee.toNumber();
```

### 3. Enum 處理

```typescript
// 前端字串 → Prisma Enum
courseTerm: course.courseTerm as CourseTerm;

// Prisma Enum → 前端字串
const termString: string = course.courseTerm;
```

### 4. 陣列處理

```typescript
// 前端陣列 → Prisma Enum 陣列
chargingModels: course.chargingModel as ChargingModel[];

// Prisma Enum 陣列 → 前端陣列
const models: string[] = course.chargingModels;
```

## 索引優化

### 1. 單欄位索引

```prisma
model School {
  // ...
  @@index([schoolName])
  @@index([partnershipStatus])
}
```

**用途：**

- 加速單欄位查詢
- 加速排序操作

### 2. 複合索引

```prisma
model SchoolContact {
  // ...
  @@unique([schoolId, email])
}
```

**用途：**

- 確保唯一性約束
- 加速多欄位查詢

### 3. 外鍵索引

```prisma
model SchoolCourse {
  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
}
```

**自動建立：**

- Prisma 自動為外鍵建立索引
- 加速關聯查詢

## 軟刪除實作

### Schema 定義

```prisma
model School {
  // ...
  deletedAt DateTime?
}
```

### 查詢時過濾

```typescript
// 只查詢未刪除的記錄
const schools = await prisma.school.findMany({
  where: {
    deletedAt: null,
  },
});
```

### 軟刪除操作

```typescript
// 軟刪除
await prisma.school.update({
  where: { id: schoolId },
  data: {
    deletedAt: new Date(),
  },
});

// 恢復
await prisma.school.update({
  where: { id: schoolId },
  data: {
    deletedAt: null,
  },
});
```

### 全域中間件（未來擴展）

```typescript
prisma.$use(async (params, next) => {
  // 自動過濾已刪除的記錄
  if (params.action === "findMany" || params.action === "findFirst") {
    params.args.where = {
      ...params.args.where,
      deletedAt: null,
    };
  }

  return next(params);
});
```

## 遷移管理

### 1. 建立遷移

```bash
pnpm prisma migrate dev --name add_school_courses
```

**流程：**

1. 比較 schema 與資料庫差異
2. 生成 SQL 遷移檔
3. 執行遷移
4. 重新生成 Prisma Client

### 2. 查看遷移狀態

```bash
pnpm prisma migrate status
```

### 3. 部署遷移（生產環境）

```bash
pnpm prisma migrate deploy
```

### 4. 重置資料庫（開發環境）

```bash
pnpm prisma migrate reset
```

**警告：** 會刪除所有資料！

## Prisma Studio

### 啟動

```bash
pnpm prisma studio
```

**功能：**

- 視覺化資料庫瀏覽
- 手動編輯資料
- 測試查詢
- 查看關聯

**訪問：** `http://localhost:5555`

## 效能最佳實踐

### 1. 選擇性查詢

```typescript
// ✅ 只查詢需要的欄位
const schools = await prisma.school.findMany({
  select: {
    id: true,
    schoolName: true,
  },
});

// ❌ 查詢所有欄位
const schools = await prisma.school.findMany();
```

### 2. 批次操作

```typescript
// ✅ 使用 createMany
await prisma.schoolCourse.createMany({
  data: courses,
});

// ❌ 逐一建立
for (const course of courses) {
  await prisma.schoolCourse.create({ data: course });
}
```

**注意：** `createMany` 不返回建立的記錄。

### 3. 連接池配置

```typescript
// prisma.config.ts
export default defineConfig({
  datasource: {
    url: process.env["DATABASE_URL"],
    // 連接池設定
    pool: {
      max: 10,
      min: 2,
      idleTimeoutMillis: 30000,
    },
  },
});
```

## 錯誤處理

### 1. 唯一約束錯誤

```typescript
try {
  await prisma.school.create({ ... });
} catch (error) {
  if (error.code === 'P2002') {
    // 唯一約束衝突
    console.error('School already exists');
  }
}
```

### 2. 外鍵約束錯誤

```typescript
try {
  await prisma.schoolCourse.create({ ... });
} catch (error) {
  if (error.code === 'P2003') {
    // 外鍵約束失敗
    console.error('School not found');
  }
}
```

### 3. Transaction 錯誤

```typescript
try {
  await prisma.$transaction(async (tx) => {
    // ...
  });
} catch (error) {
  if (error.code === "P2028") {
    // Transaction 超時
    console.error("Transaction timeout");
  }
}
```

## 下一步

閱讀 **[08\_錯誤處理.md](./08_錯誤處理.md)** 了解完整的錯誤處理策略。
