# TASK-006 會話總結 - 2026-02-02 Session 1

## 任務狀態：✅ 完成

---

## 完成項目

### 1. 建立 useUserActions.ts

新建 `src/hooks/useUserActions.ts` 取代原有的 `useUserProfile.ts`：

| Hook | 功能 | 調用的 Server Action |
|:-----|:-----|:---------------------|
| `useUpdateProfile` | 更新個人資料 | `updateProfileAction` |
| `useUpdateAddress` | 更新地址 | `updateAddressAction` |
| `useDeleteAddress` | 刪除地址 | `deleteAddressAction` |
| `useUpdateBank` | 更新收款資料 | `updateBankAction` |
| `useDeleteBank` | 刪除收款資料 | `deleteBankAction` |
| `useCreateChild` | 新增學員 | `createChildAction` |
| `useUpdateChild` | 更新學員 | `updateChildAction` |
| `useDeleteChild` | 刪除學員 | `deleteChildAction` |
| `useChangePassword` | 修改密碼 | `changePasswordAction` |

**特點**：
- 使用 `useTransition` + `router.refresh()` 實現資料更新
- 自動顯示 toast 提示
- 統一的錯誤處理

### 2. 重構使用 hooks 的組件

| 組件 | 變更 |
|:-----|:-----|
| `ProfilePageContent.tsx` | 移除 SWR hooks，直接使用 initialData |
| `UserInfoCard.tsx` | import 改為 `useUserActions` |
| `UserAddressCard.tsx` | import 改為 `useUserActions` |
| `UserBankCard.tsx` | import 改為 `useUserActions` |
| `UserChildrenCard.tsx` | 移除 `useUserChildren`，使用 initialData |
| `UserChangePasswordModal.tsx` | import 改為 `useUserActions` |

### 3. 刪除的檔案

| 刪除項目 | 說明 |
|:---------|:-----|
| `src/hooks/useUserProfile.ts` | 舊的 SWR hooks |
| `src/app/api/user/` | 整個目錄（profile, address, bank, children, tutor） |
| `src/app/api/auth/change-password/` | 修改密碼 API Route |

### 4. 保留的 API Routes

| 路徑 | 說明 |
|:-----|:-----|
| `/api/auth/[...nextauth]` | NextAuth 核心路由（必須保留） |
| `/api/auth/otp/*` | OTP 相關（仍在使用） |
| `/api/auth/register` | 註冊（仍在使用） |
| `/api/auth/reset-password/*` | 重設密碼（仍在使用） |
| `/api/school-service/*` | 學校服務（仍在使用） |

---

## 驗收檢查

- [x] `pnpm build` 成功
- [x] `useUserProfile.ts` 已刪除
- [x] `/api/user/*` 已刪除
- [x] `/api/auth/change-password` 已刪除
- [ ] 手動測試功能正常

---

## 架構變更

### Before（API Routes）

```
Client Component
  ↓ SWR fetch
/api/user/profile (API Route)
  ↓
Prisma
```

### After（Server Actions）

```
Client Component
  ↓ Server Action call
updateProfileAction (Server Action)
  ↓
Prisma
```

**優點**：
- 減少 API Routes 維護成本
- 類型安全（Server Actions 有完整類型推斷）
- 更簡單的錯誤處理
- 統一使用 `router.refresh()` 更新資料

---

## Next Steps

1. **手動測試** — 測試 Profile 頁面所有功能
2. **可選清理** — 刪除剩餘未使用的 API Routes（需確認）
3. **歸檔任務** — 測試通過後移動到 `_ARCHIVE/2026-02/`
