# ğŸ—“ï¸ å°å¸«æ’ç­ - Schedule

> **è·¯å¾‘**: `/dashboard/school/schedule`  
> **å„ªå…ˆç´š**: P1  
> **è§’è‰²**: ADMIN (ç·¨è¼¯), TUTOR (å”¯è®€è‡ªå·±)

---

## ğŸ“‹ é é¢æ¦‚è¿°

å°å¸«æ’ç­é€±è¦–åœ–ï¼Œä»¥æ‹–æ‹‰æ–¹å¼åˆ†é…å°å¸«åˆ°èª²å ‚ã€‚æ”¯æ´æ™‚é–“è¡çªæª¢æŸ¥å’Œæ‰¹æ¬¡é€šçŸ¥ã€‚

---

## ğŸ¨ é é¢çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ—“ï¸ å°å¸«æ’ç­                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â—€ ä¸Šé€± â”‚ 2024 å¹´ 11 æœˆ 18-24 æ—¥ â”‚ ä¸‹é€± â–¶           â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚ è¦–åœ–: [é€±è¦–åœ–â—] [å°å¸«è¦–åœ–â—‹]                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ é€±è¦–åœ–                                      â”‚ â”‚å¾…åˆ†é…  â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â” â”‚ â”‚        â”‚â”‚
â”‚  â”‚ â”‚å°å¸« â”‚ é€±ä¸€ â”‚ é€±äºŒ â”‚ é€±ä¸‰ â”‚ é€±å›› â”‚ é€±äº” â”‚ â”‚ â”‚ğŸ”´ (5)  â”‚â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚        â”‚â”‚
â”‚  â”‚ â”‚å¼µæ•™ç·´â”‚14:00 â”‚      â”‚14:00 â”‚      â”‚10:00 â”‚ â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚ â”‚     â”‚è–ä¿ç¾…â”‚      â”‚è–ä¿ç¾…â”‚      â”‚åŸ¹æ­£  â”‚ â”‚ â”‚â”‚11/25â”‚â”‚â”‚
â”‚  â”‚ â”‚     â”‚âœ…    â”‚      â”‚âœ…    â”‚      â”‚â°    â”‚ â”‚ â”‚â”‚14:00â”‚â”‚â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚â”‚è–ä¿ç¾…â”‚â”‚â”‚
â”‚  â”‚ â”‚ææ•™ç·´â”‚      â”‚15:00 â”‚      â”‚15:00 â”‚      â”‚ â”‚ â”‚â””â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚ â”‚     â”‚      â”‚å”æ©  â”‚      â”‚å”æ©  â”‚      â”‚ â”‚ â”‚        â”‚â”‚
â”‚  â”‚ â”‚     â”‚      â”‚âœ…    â”‚      â”‚âœ…    â”‚      â”‚ â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚â”‚11/26â”‚â”‚â”‚
â”‚  â”‚ â”‚ç‹æ•™ç·´â”‚10:00 â”‚10:00 â”‚âš ï¸è¡çªâ”‚      â”‚14:00 â”‚ â”‚ â”‚â”‚15:00â”‚â”‚â”‚
â”‚  â”‚ â”‚     â”‚åŸ¹æ­£  â”‚è–ä¿ç¾…â”‚      â”‚      â”‚å”æ©  â”‚ â”‚ â”‚â”‚åŸ¹æ­£ â”‚â”‚â”‚
â”‚  â”‚ â”‚     â”‚âœ…    â”‚â°    â”‚      â”‚      â”‚â°    â”‚ â”‚ â”‚â””â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚        â”‚â”‚
â”‚  â”‚                                              â”‚ â”‚        â”‚â”‚
â”‚  â”‚ [è‡ªå‹•åˆ†é…] [é€šçŸ¥æ‰€æœ‰å°å¸«] [åŒ¯å‡ºPDF]         â”‚ â”‚        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ä½¿ç”¨çµ„ä»¶

### TailAdmin çµ„ä»¶

| çµ„ä»¶       | è·¯å¾‘                               | ç”¨é€”         |
| ---------- | ---------------------------------- | ------------ |
| `Calendar` | `components/calendar/Calendar.tsx` | æ—¥æ›†åŸºç¤åƒè€ƒ |
| `Avatar`   | `components/ui/avatar/`            | å°å¸«é ­åƒ     |
| `Badge`    | `components/ui/badge/Badge.tsx`    | ç‹€æ…‹æ¨™ç±¤     |
| `Tooltip`  | `components/ui/tooltip/`           | æç¤ºè³‡è¨Š     |

### éœ€é–‹ç™¼çµ„ä»¶

| çµ„ä»¶                  | èªªæ˜         |
| --------------------- | ------------ |
| `WeekSelector`        | é€±é¸æ“‡å™¨     |
| `ScheduleWeekView`    | é€±è¦–åœ–ä¸»é«”   |
| `TutorRow`            | å°å¸«è¡Œ       |
| `LessonSlot`          | èª²å ‚æ ¼å­     |
| `UnassignedPanel`     | å¾…åˆ†é…é¢æ¿   |
| `DraggableLessonCard` | å¯æ‹–æ‹‰èª²å ‚å¡ |

---

## ğŸ“Š è³‡æ–™çµæ§‹

### é€±è¦–åœ–è³‡æ–™

```typescript
interface WeekScheduleData {
  weekStart: Date;
  weekEnd: Date;

  tutors: TutorSchedule[];
  unassignedLessons: UnassignedLesson[];
}

interface TutorSchedule {
  userId: string;
  userName: string;
  avatar?: string;

  // æŒ‰æ˜ŸæœŸåˆ†çµ„çš„èª²å ‚
  lessonsByDay: Record<number, ScheduledLesson[]>; // 1-7
}

interface ScheduledLesson {
  tutorLessonId: string;
  lessonId: string;

  lessonDate: Date;
  startTime: string;
  endTime: string;

  schoolName: string;
  courseName: string;

  tutorRole: TutorRole;
  attendanceStatus: AttendanceStatus;
}

interface UnassignedLesson {
  lessonId: string;
  lessonDate: Date;
  startTime: string;
  endTime: string;

  schoolName: string;
  courseName: string;

  requiredTutors: number;
  assignedTutors: number;
}
```

### æŸ¥è©¢

```typescript
// API: GET /api/schedule?weekStart=2024-11-18
async function getWeekSchedule(weekStart: Date) {
  const weekEnd = addDays(weekStart, 6);

  // ç²å–æ‰€æœ‰å°å¸«
  const tutors = await prisma.user.findMany({
    where: { role: "TUTOR", deletedAt: null },
  });

  // ç²å–è©²é€±æ‰€æœ‰å·²åˆ†é…çš„èª²å ‚
  const tutorLessons = await prisma.schoolTutorLesson.findMany({
    where: {
      lessonDate: {
        gte: weekStart,
        lte: weekEnd,
      },
    },
    include: {
      user: { select: { id: true, name: true } },
      lesson: {
        include: {
          course: {
            include: {
              school: { select: { schoolName: true } },
            },
          },
        },
      },
    },
  });

  // ç²å–è©²é€±æœªå®Œå…¨åˆ†é…çš„èª²å ‚
  const allLessons = await prisma.schoolLesson.findMany({
    where: {
      lessonDate: {
        gte: weekStart,
        lte: weekEnd,
      },
      lessonStatus: "SCHEDULED",
    },
    include: {
      course: {
        include: {
          school: { select: { schoolName: true } },
        },
      },
      tutorLessons: true,
    },
  });

  const unassignedLessons = allLessons.filter(
    (lesson) => lesson.tutorLessons.length < lesson.course.requiredTutors
  );

  // çµ„è£è³‡æ–™
  // ...

  return { weekStart, weekEnd, tutors: tutorSchedules, unassignedLessons };
}
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. æ‹–æ‹‰åˆ†é…

```typescript
// æ‹–æ‹‰è™•ç†
interface DragDropContext {
  draggingLesson: UnassignedLesson | null;
  dropTarget: { tutorId: string; day: number } | null;
  hasConflict: boolean;
}

async function handleDrop(
  lessonId: string,
  tutorId: string,
  role: TutorRole = "ASSISTANT"
) {
  // 1. æª¢æŸ¥æ™‚é–“è¡çª
  const lesson = await prisma.schoolLesson.findUnique({
    where: { id: lessonId },
  });

  const conflict = await checkTimeConflict(
    tutorId,
    lesson.lessonDate,
    lesson.startTime,
    lesson.endTime
  );

  if (conflict) {
    throw new Error("å°å¸«åœ¨æ­¤æ™‚æ®µå·²æœ‰å…¶ä»–èª²å ‚");
  }

  // 2. å»ºç«‹åˆ†é…è¨˜éŒ„
  const course = await prisma.schoolCourse.findFirst({
    where: { lessons: { some: { id: lessonId } } },
  });

  await prisma.schoolTutorLesson.create({
    data: {
      lessonId,
      userId: tutorId,
      courseId: course.id,
      tutorRole: role,
      attendanceStatus: "SCHEDULED",
      lessonDate: lesson.lessonDate,
      startTime: lesson.startTime,
      endTime: lesson.endTime,
    },
  });
}
```

### 2. æ™‚é–“è¡çªæª¢æŸ¥

```typescript
async function checkTimeConflict(
  tutorId: string,
  date: Date,
  startTime: string,
  endTime: string
): Promise<boolean> {
  const conflicts = await prisma.schoolTutorLesson.findMany({
    where: {
      userId: tutorId,
      lessonDate: date,
      OR: [
        // æ–°èª²å ‚é–‹å§‹æ™‚é–“åœ¨ç¾æœ‰èª²å ‚æ™‚é–“å…§
        {
          AND: [
            { startTime: { lte: startTime } },
            { endTime: { gt: startTime } },
          ],
        },
        // æ–°èª²å ‚çµæŸæ™‚é–“åœ¨ç¾æœ‰èª²å ‚æ™‚é–“å…§
        {
          AND: [{ startTime: { lt: endTime } }, { endTime: { gte: endTime } }],
        },
        // æ–°èª²å ‚å®Œå…¨åŒ…å«ç¾æœ‰èª²å ‚
        {
          AND: [
            { startTime: { gte: startTime } },
            { endTime: { lte: endTime } },
          ],
        },
      ],
    },
  });

  return conflicts.length > 0;
}
```

### 3. èª²å ‚æ ¼å­çµ„ä»¶

```tsx
interface LessonSlotProps {
  lesson?: ScheduledLesson;
  isEmpty?: boolean;
  tutorId: string;
  day: number;
  onDrop?: (lessonId: string) => void;
  isDropTarget?: boolean;
  hasConflict?: boolean;
}

export function LessonSlot({
  lesson,
  isEmpty,
  tutorId,
  day,
  onDrop,
  isDropTarget,
  hasConflict,
}: LessonSlotProps) {
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    // è¨­å®šç‚ºæ”¾ç½®ç›®æ¨™
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    const lessonId = e.dataTransfer.getData("lessonId");
    onDrop?.(lessonId);
  };

  if (isEmpty) {
    return (
      <div
        onDragOver={handleDragOver}
        onDrop={handleDrop}
        className={cn(
          "min-h-[80px] border-2 border-dashed rounded-lg transition-colors",
          isDropTarget && !hasConflict && "border-primary-500 bg-primary-50",
          isDropTarget && hasConflict && "border-red-500 bg-red-50",
          !isDropTarget && "border-gray-200 dark:border-gray-700"
        )}
      />
    );
  }

  return (
    <div
      className={cn(
        "min-h-[80px] p-2 rounded-lg border",
        lesson.attendanceStatus === "COMPLETED" &&
          "bg-green-50 border-green-200",
        lesson.attendanceStatus === "CHECKED_IN" &&
          "bg-blue-50 border-blue-200",
        lesson.attendanceStatus === "SCHEDULED" && "bg-white border-gray-200"
      )}
    >
      <div className="text-xs font-medium">{lesson.startTime}</div>
      <div className="text-sm truncate">{lesson.schoolName}</div>
      <div className="flex items-center gap-1 mt-1">
        <TutorRoleBadge role={lesson.tutorRole} size="sm" />
        <AttendanceStatusIcon status={lesson.attendanceStatus} />
      </div>
    </div>
  );
}
```

### 4. å¯æ‹–æ‹‰èª²å ‚å¡

```tsx
interface DraggableLessonCardProps {
  lesson: UnassignedLesson;
}

export function DraggableLessonCard({ lesson }: DraggableLessonCardProps) {
  const handleDragStart = (e: React.DragEvent) => {
    e.dataTransfer.setData("lessonId", lesson.lessonId);
    e.dataTransfer.effectAllowed = "move";
  };

  return (
    <div
      draggable
      onDragStart={handleDragStart}
      className="p-3 rounded-lg border border-orange-200 bg-orange-50 cursor-grab active:cursor-grabbing hover:shadow-md transition-shadow dark:border-orange-800 dark:bg-orange-900/20"
    >
      <div className="text-sm font-medium">
        {format(lesson.lessonDate, "MM/dd")} {lesson.startTime}
      </div>
      <div className="text-sm text-gray-600 truncate">{lesson.schoolName}</div>
      <div className="text-xs text-gray-500 mt-1">
        éœ€è¦ï¼š{lesson.requiredTutors - lesson.assignedTutors} ä½å°å¸«
      </div>
    </div>
  );
}
```

---

## ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹

### é é¢çµæ§‹

```tsx
// app/(private)/dashboard/school/schedule/page.tsx
"use client";

import { useState, useCallback } from "react";
import { useSession } from "next-auth/react";
import useSWR from "swr";
import { addWeeks, subWeeks, startOfWeek, format } from "date-fns";
import { PageBreadCrumb } from "@/components/common/PageBreadCrumb";
import { WeekSelector } from "./components/WeekSelector";
import { ScheduleWeekView } from "./components/ScheduleWeekView";
import { UnassignedPanel } from "./components/UnassignedPanel";
import { TutorAssignModal } from "./components/TutorAssignModal";

export default function SchedulePage() {
  const { data: session } = useSession();
  const isAdmin = session?.user?.role === "ADMIN";

  const [weekStart, setWeekStart] = useState(() =>
    startOfWeek(new Date(), { weekStartsOn: 1 })
  );

  const [assignModal, setAssignModal] = useState<{
    lessonId: string;
    tutorId: string;
  } | null>(null);

  const { data, isLoading, mutate } = useSWR(
    `/api/schedule?weekStart=${weekStart.toISOString()}`,
    fetcher
  );

  const handlePrevWeek = () => setWeekStart((prev) => subWeeks(prev, 1));
  const handleNextWeek = () => setWeekStart((prev) => addWeeks(prev, 1));

  const handleDrop = useCallback(async (lessonId: string, tutorId: string) => {
    // æ‰“é–‹è§’è‰²é¸æ“‡ Modal
    setAssignModal({ lessonId, tutorId });
  }, []);

  const handleAssignConfirm = async (role: TutorRole) => {
    if (!assignModal) return;

    try {
      await fetch("/api/schedule/assign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          lessonId: assignModal.lessonId,
          tutorId: assignModal.tutorId,
          role,
        }),
      });

      mutate();
    } catch (error) {
      console.error("åˆ†é…å¤±æ•—:", error);
    } finally {
      setAssignModal(null);
    }
  };

  // TUTOR åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ’ç­
  const filteredData =
    session?.user?.role === "TUTOR"
      ? {
          ...data,
          tutors: data?.tutors.filter((t: any) => t.userId === session.user.id),
        }
      : data;

  return (
    <div className="space-y-6">
      <PageBreadCrumb title="å°å¸«æ’ç­" />

      {/* é€±é¸æ“‡å™¨ */}
      <WeekSelector
        weekStart={weekStart}
        onPrev={handlePrevWeek}
        onNext={handleNextWeek}
      />

      {/* ä¸»å…§å®¹ */}
      <div className="flex gap-6">
        {/* é€±è¦–åœ– */}
        <div className="flex-1">
          {isLoading ? (
            <div className="h-96 bg-gray-100 rounded-xl animate-pulse" />
          ) : (
            <ScheduleWeekView
              weekStart={weekStart}
              tutors={filteredData?.tutors || []}
              onDrop={isAdmin ? handleDrop : undefined}
              readOnly={!isAdmin}
            />
          )}

          {/* æ‰¹æ¬¡æ“ä½œ */}
          {isAdmin && (
            <div className="flex gap-3 mt-4">
              <Button variant="outline">è‡ªå‹•åˆ†é…</Button>
              <Button variant="outline">é€šçŸ¥æ‰€æœ‰å°å¸«</Button>
              <Button variant="outline">åŒ¯å‡º PDF</Button>
            </div>
          )}
        </div>

        {/* å¾…åˆ†é…é¢æ¿ */}
        {isAdmin && <UnassignedPanel lessons={data?.unassignedLessons || []} />}
      </div>

      {/* åˆ†é…ç¢ºèª Modal */}
      {assignModal && (
        <TutorAssignModal
          onConfirm={handleAssignConfirm}
          onClose={() => setAssignModal(null)}
        />
      )}
    </div>
  );
}
```

---

## âœ… é©—æ”¶æ¨™æº–

- [ ] é€±è¦–åœ–æ­£ç¢ºé¡¯ç¤ºå°å¸«æ’ç­
- [ ] ADMIN å¯æ‹–æ‹‰åˆ†é…èª²å ‚åˆ°å°å¸«
- [ ] æ™‚é–“è¡çªæ­£ç¢ºæª¢æ¸¬ä¸¦é˜»æ­¢
- [ ] æœªåˆ†é…èª²å ‚é¡¯ç¤ºåœ¨å³å´é¢æ¿
- [ ] åˆ†é…æ™‚å¯é¸æ“‡å°å¸«è§’è‰²
- [ ] TUTOR åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ’ç­
- [ ] é€±åˆ‡æ›åŠŸèƒ½æ­£å¸¸
- [ ] ç‹€æ…‹é¡è‰²ç·¨ç¢¼æ­£ç¢º
