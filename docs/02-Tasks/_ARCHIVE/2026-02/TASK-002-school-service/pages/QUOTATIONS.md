# ğŸ“‹ å ±åƒ¹åˆ—è¡¨ - Quotations

> **è·¯å¾‘**: `/dashboard/school/quotations`  
> **å„ªå…ˆç´š**: P0  
> **è§’è‰²**: ADMIN (CRUD), SCHOOL_ADMIN (å”¯è®€)

---

## ğŸ“‹ é é¢æ¦‚è¿°

å ±åƒ¹ç®¡ç†åˆ—è¡¨é ï¼Œé¡¯ç¤ºæ‰€æœ‰å ±åƒ¹å–®ï¼Œæ”¯æ´ç¯©é¸ã€æœå°‹å’Œå¿«é€Ÿæ“ä½œã€‚

---

## ğŸ¨ é é¢çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ å ±åƒ¹ç®¡ç†                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç‹€æ…‹: [å…¨éƒ¨â–¼] [è‰ç¨¿] [å·²ç™¼é€] [å·²æ¥å—] [å·²æ‹’çµ•]     â”‚   â”‚
â”‚  â”‚ æœå°‹: [________________ğŸ”]     [â• æ–°å¢å ±åƒ¹]        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ â”‚ å ±åƒ¹ç·¨è™Ÿâ”‚ å­¸æ ¡       â”‚ æŸ¥è©¢æ—¥æœŸ â”‚ é‡‘é¡    â”‚ ç‹€æ…‹  â”‚ æ“ä½œ   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚ â”‚ Q2024-03â”‚ è–ä¿ç¾…å°å­¸ â”‚ 11/10    â”‚ $24,000 â”‚ ğŸŸ¢å·²æ¥å—â”‚ [è½‰æ›] â”‚
â”‚  â”‚ â”‚ Q2024-02â”‚ åŸ¹æ­£ä¸­å­¸   â”‚ 11/05    â”‚ $18,000 â”‚ ğŸ”µå·²ç™¼é€â”‚ [ç·¨è¼¯] â”‚
â”‚  â”‚ â”‚ Q2024-01â”‚ å”æ©ä¸­å­¸   â”‚ 10/28    â”‚ $15,000 â”‚ ğŸ”´å·²æ‹’çµ•â”‚ [æŸ¥çœ‹] â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚                                                          â”‚
â”‚  â”‚ é¡¯ç¤º 1-10 / å…± 45 ç­†                    [<] 1 2 3 ... [>]â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ä½¿ç”¨çµ„ä»¶

### TailAdmin çµ„ä»¶

| çµ„ä»¶            | è·¯å¾‘                                  | ç”¨é€”       |
| --------------- | ------------------------------------- | ---------- |
| `DataTables`    | `components/tables/DataTables/`       | è³‡æ–™è¡¨æ ¼   |
| `Pagination`    | `components/ui/pagination/`           | åˆ†é        |
| `Badge`         | `components/ui/badge/Badge.tsx`       | ç‹€æ…‹æ¨™ç±¤   |
| `Dropdown`      | `components/ui/dropdown/`             | ç¯©é¸ä¸‹æ‹‰   |
| `Button`        | `components/ui/button/`               | æ“ä½œæŒ‰éˆ•   |
| `TableDropdown` | `components/common/TableDropdown.tsx` | è¡Œæ“ä½œé¸å–® |

---

## ğŸ“Š è³‡æ–™çµæ§‹

### åˆ—è¡¨è³‡æ–™

```typescript
interface QuotationListItem {
  id: string;
  quotationNumber: string;
  school: {
    id: string;
    schoolName: string;
  };
  inquiryDate: Date | null;
  quotationDate: Date;
  totalAmount: number | null;
  status: QuotationStatus;
  itemCount: number;
  validUntil: Date | null;
}
```

### æŸ¥è©¢åƒæ•¸

```typescript
interface QuotationListParams {
  status?: QuotationStatus | "all";
  search?: string; // å­¸æ ¡åç¨±æˆ–å ±åƒ¹ç·¨è™Ÿ
  schoolId?: string; // SCHOOL_ADMIN è‡ªå‹•éæ¿¾
  page?: number;
  pageSize?: number;
  sortBy?: "quotationDate" | "totalAmount" | "status";
  sortOrder?: "asc" | "desc";
}
```

### API æŸ¥è©¢

```typescript
// API: GET /api/quotations
async function getQuotations(params: QuotationListParams) {
  const { status, search, schoolId, page = 1, pageSize = 10 } = params;

  const where: Prisma.SchoolQuotationWhereInput = {
    deletedAt: null,
    ...(status && status !== "all" && { status }),
    ...(schoolId && { schoolId }),
    ...(search && {
      OR: [
        { quotationNumber: { contains: search, mode: "insensitive" } },
        { school: { schoolName: { contains: search, mode: "insensitive" } } },
      ],
    }),
  };

  const [quotations, total] = await Promise.all([
    prisma.schoolQuotation.findMany({
      where,
      include: {
        school: { select: { id: true, schoolName: true } },
        _count: { select: { items: true } },
      },
      orderBy: { quotationDate: "desc" },
      skip: (page - 1) * pageSize,
      take: pageSize,
    }),
    prisma.schoolQuotation.count({ where }),
  ]);

  return {
    data: quotations.map((q) => ({
      ...q,
      itemCount: q._count.items,
    })),
    pagination: {
      page,
      pageSize,
      total,
      totalPages: Math.ceil(total / pageSize),
    },
  };
}
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. ç‹€æ…‹ç¯©é¸

```typescript
const statusOptions = [
  { value: "all", label: "å…¨éƒ¨" },
  { value: "DRAFT", label: "è‰ç¨¿", color: "gray" },
  { value: "SENT", label: "å·²ç™¼é€", color: "blue" },
  { value: "ACCEPTED", label: "å·²æ¥å—", color: "green" },
  { value: "REJECTED", label: "å·²æ‹’çµ•", color: "red" },
  { value: "EXPIRED", label: "å·²éæœŸ", color: "orange" },
];
```

### 2. è¡Œæ“ä½œ

```typescript
function getRowActions(quotation: QuotationListItem, role: UserRole) {
  const actions = [];

  // æŸ¥çœ‹ - æ‰€æœ‰äºº
  actions.push({
    label: "æŸ¥çœ‹",
    href: `/dashboard/school/quotations/${quotation.id}`,
  });

  if (role === "ADMIN") {
    // ç·¨è¼¯ - åªæœ‰è‰ç¨¿å’Œå·²ç™¼é€å¯ç·¨è¼¯
    if (["DRAFT", "SENT"].includes(quotation.status)) {
      actions.push({
        label: "ç·¨è¼¯",
        href: `/dashboard/school/quotations/${quotation.id}?edit=true`,
      });
    }

    // è½‰æ›ç‚ºèª²ç¨‹ - åªæœ‰å·²æ¥å—
    if (quotation.status === "ACCEPTED") {
      actions.push({
        label: "è½‰æ›ç‚ºèª²ç¨‹",
        href: `/dashboard/school/quotations/${quotation.id}/convert`,
        highlight: true,
      });
    }

    // ç™¼é€ - åªæœ‰è‰ç¨¿
    if (quotation.status === "DRAFT") {
      actions.push({
        label: "ç™¼é€å ±åƒ¹",
        onClick: () => handleSendQuotation(quotation.id),
      });
    }

    // åˆªé™¤ - åªæœ‰è‰ç¨¿
    if (quotation.status === "DRAFT") {
      actions.push({
        label: "åˆªé™¤",
        onClick: () => handleDeleteQuotation(quotation.id),
        danger: true,
      });
    }
  }

  return actions;
}
```

### 3. ç‹€æ…‹å¾½ç« 

```tsx
function QuotationStatusBadge({ status }: { status: QuotationStatus }) {
  const config: Record<QuotationStatus, { color: string; text: string }> = {
    DRAFT: { color: "gray", text: "è‰ç¨¿" },
    SENT: { color: "blue", text: "å·²ç™¼é€" },
    ACCEPTED: { color: "green", text: "å·²æ¥å—" },
    REJECTED: { color: "red", text: "å·²æ‹’çµ•" },
    EXPIRED: { color: "orange", text: "å·²éæœŸ" },
  };

  const { color, text } = config[status];

  return (
    <Badge variant="light" color={color}>
      {text}
    </Badge>
  );
}
```

---

## ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹

### é é¢çµæ§‹

```tsx
// app/(private)/dashboard/school/quotations/page.tsx
"use client";

import { useState } from "react";
import { useSession } from "next-auth/react";
import { useRouter, useSearchParams } from "next/navigation";
import useSWR from "swr";
import Link from "next/link";
import { PageBreadCrumb } from "@/components/common/PageBreadCrumb";
import { QuotationStatusBadge } from "./components/QuotationStatusBadge";
import { TableDropdown } from "@/components/common/TableDropdown";
import { Pagination } from "@/components/ui/pagination";

export default function QuotationsPage() {
  const { data: session } = useSession();
  const router = useRouter();
  const searchParams = useSearchParams();

  const [status, setStatus] = useState(searchParams.get("status") || "all");
  const [search, setSearch] = useState("");
  const [page, setPage] = useState(1);

  const isAdmin = session?.user?.role === "ADMIN";
  const schoolId =
    session?.user?.role === "SCHOOL_ADMIN" ? session.user.schoolId : undefined;

  // æ§‹å»ºæŸ¥è©¢ URL
  const queryString = new URLSearchParams({
    ...(status !== "all" && { status }),
    ...(search && { search }),
    ...(schoolId && { schoolId }),
    page: page.toString(),
  }).toString();

  const { data, isLoading } = useSWR(`/api/quotations?${queryString}`, fetcher);

  const handleRowClick = (quotationId: string) => {
    router.push(`/dashboard/school/quotations/${quotationId}`);
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <PageBreadCrumb title="å ±åƒ¹ç®¡ç†" />

        {isAdmin && (
          <Link href="/dashboard/school/quotations/new">
            <Button variant="primary">
              <PlusIcon className="h-4 w-4 mr-2" />
              æ–°å¢å ±åƒ¹
            </Button>
          </Link>
        )}
      </div>

      {/* ç¯©é¸å™¨ */}
      <div className="flex flex-col sm:flex-row gap-4">
        {/* ç‹€æ…‹ç¯©é¸ */}
        <div className="flex gap-2">
          {statusOptions.map((opt) => (
            <button
              key={opt.value}
              onClick={() => {
                setStatus(opt.value);
                setPage(1);
              }}
              className={cn(
                "px-3 py-1.5 rounded-full text-sm transition-colors",
                status === opt.value
                  ? "bg-primary-500 text-white"
                  : "bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400"
              )}
            >
              {opt.label}
            </button>
          ))}
        </div>

        {/* æœå°‹æ¡† */}
        <div className="flex-1 max-w-md">
          <div className="relative">
            <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
            <input
              type="text"
              placeholder="æœå°‹å­¸æ ¡åç¨±æˆ–å ±åƒ¹ç·¨è™Ÿ..."
              value={search}
              onChange={(e) => {
                setSearch(e.target.value);
                setPage(1);
              }}
              className="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-gray-800"
            />
          </div>
        </div>
      </div>

      {/* è¡¨æ ¼ */}
      <div className="rounded-xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-gray-900 overflow-hidden">
        <table className="w-full">
          <thead>
            <tr className="border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50">
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">
                å ±åƒ¹ç·¨è™Ÿ
              </th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">
                å­¸æ ¡
              </th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">
                æŸ¥è©¢æ—¥æœŸ
              </th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-500">
                é‡‘é¡
              </th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">
                ç‹€æ…‹
              </th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-500">
                æ“ä½œ
              </th>
            </tr>
          </thead>
          <tbody>
            {isLoading ? (
              <tr>
                <td colSpan={6} className="px-4 py-8 text-center text-gray-500">
                  è¼‰å…¥ä¸­...
                </td>
              </tr>
            ) : data?.data.length === 0 ? (
              <tr>
                <td colSpan={6} className="px-4 py-8 text-center text-gray-500">
                  æ²’æœ‰å ±åƒ¹è¨˜éŒ„
                </td>
              </tr>
            ) : (
              data?.data.map((quotation: QuotationListItem) => (
                <tr
                  key={quotation.id}
                  onClick={() => handleRowClick(quotation.id)}
                  className="border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 cursor-pointer"
                >
                  <td className="px-4 py-3 text-sm font-medium">
                    {quotation.quotationNumber}
                  </td>
                  <td className="px-4 py-3 text-sm">
                    {quotation.school.schoolName}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-500">
                    {quotation.inquiryDate
                      ? format(quotation.inquiryDate, "yyyy/MM/dd")
                      : "-"}
                  </td>
                  <td className="px-4 py-3 text-sm text-right font-medium">
                    {quotation.totalAmount
                      ? `HK$ ${quotation.totalAmount.toLocaleString()}`
                      : "-"}
                  </td>
                  <td className="px-4 py-3">
                    <QuotationStatusBadge status={quotation.status} />
                  </td>
                  <td
                    className="px-4 py-3 text-right"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <TableDropdown
                      items={getRowActions(quotation, session?.user?.role)}
                    />
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>

        {/* åˆ†é  */}
        {data?.pagination && (
          <div className="px-4 py-3 border-t border-gray-200 dark:border-gray-800 flex items-center justify-between">
            <span className="text-sm text-gray-500">
              é¡¯ç¤º {(data.pagination.page - 1) * data.pagination.pageSize + 1}-
              {Math.min(
                data.pagination.page * data.pagination.pageSize,
                data.pagination.total
              )}{" "}
              / å…± {data.pagination.total} ç­†
            </span>
            <Pagination
              currentPage={data.pagination.page}
              totalPages={data.pagination.totalPages}
              onPageChange={setPage}
            />
          </div>
        )}
      </div>
    </div>
  );
}
```

---

## ğŸ“± éŸ¿æ‡‰å¼è¨­è¨ˆ

| æ–·é»    | è¡¨æ ¼é¡¯ç¤º | ç¯©é¸å™¨   |
| ------- | -------- | -------- |
| mobile  | å¡ç‰‡åˆ—è¡¨ | å‚ç›´æ’åˆ— |
| tablet+ | è¡¨æ ¼     | æ°´å¹³æ’åˆ— |

### æ‰‹æ©Ÿç‰ˆå¡ç‰‡

```tsx
// æ‰‹æ©Ÿç‰ˆä½¿ç”¨å¡ç‰‡åˆ—è¡¨
function QuotationCardList({
  quotations,
}: {
  quotations: QuotationListItem[];
}) {
  return (
    <div className="space-y-3 sm:hidden">
      {quotations.map((q) => (
        <Link
          key={q.id}
          href={`/dashboard/school/quotations/${q.id}`}
          className="block rounded-xl border border-gray-200 p-4 dark:border-gray-800"
        >
          <div className="flex items-center justify-between mb-2">
            <span className="font-medium">{q.quotationNumber}</span>
            <QuotationStatusBadge status={q.status} />
          </div>
          <p className="text-sm text-gray-600 dark:text-gray-400">
            {q.school.schoolName}
          </p>
          <div className="flex items-center justify-between mt-2">
            <span className="text-sm text-gray-500">
              {q.inquiryDate ? format(q.inquiryDate, "yyyy/MM/dd") : "-"}
            </span>
            <span className="font-medium">
              {q.totalAmount ? `HK$ ${q.totalAmount.toLocaleString()}` : "-"}
            </span>
          </div>
        </Link>
      ))}
    </div>
  );
}
```

---

## âœ… é©—æ”¶æ¨™æº–

- [ ] ADMIN å¯æŸ¥çœ‹æ‰€æœ‰å ±åƒ¹
- [ ] SCHOOL_ADMIN åªèƒ½æŸ¥çœ‹è‡ªå·±å­¸æ ¡çš„å ±åƒ¹
- [ ] ç‹€æ…‹ç¯©é¸æ­£ç¢ºé‹ä½œ
- [ ] æœå°‹åŠŸèƒ½æ­£ç¢ºé‹ä½œ
- [ ] åˆ†é åŠŸèƒ½æ­£ç¢ºé‹ä½œ
- [ ] é»æ“Šè¡Œè·³è½‰åˆ°è©³æƒ…é 
- [ ] ADMIN å¯æ–°å¢å ±åƒ¹
- [ ] å·²æ¥å—çš„å ±åƒ¹é¡¯ç¤ºã€Œè½‰æ›ã€æŒ‰éˆ•
- [ ] éŸ¿æ‡‰å¼è¨­è¨ˆæ­£å¸¸é‹ä½œ
